{% load static %}
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>{% block title %}Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±{% endblock %}</title>

  <!-- Ø£Ø¯Ø§Ø¡ -->
  <link rel="preload" href="{% static 'css/app.css' %}" as="style">
  <link rel="stylesheet" href="{% static 'css/app.css' %}" />

  <!-- Ø§Ù„Ø®Ø· ÙˆØ§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª -->
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <!-- Ù„ÙˆÙ† Ø´Ø±ÙŠØ· Ø§Ù„Ù…ØªØµÙØ­ -->
  <meta name="theme-color" content="#0f172a" media="(prefers-color-scheme: dark)">
  <meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)">

  <style>
    :root{
      --brand:#2563eb;--brand-ink:#1e3a8a;--brand-ghost:#e8efff;
      --accent:#10b981;--ink:#0f172a;--ink-soft:#1f2937;--muted:#64748b;
      --bg:#f8fafc;--card:#ffffff;--line:#e5e7eb;--line-2:#f1f5f9;
      --radius:14px;--t:all .22s ease;--shadow:0 4px 16px rgba(2,6,23,.08);--ring:0 0 0 3px rgba(37,99,235,.25);
      --tap:48px;
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-right: env(safe-area-inset-right, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
      --safe-left: env(safe-area-inset-left, 0px);
    }
    @media (prefers-color-scheme: dark){
      :root{
        --bg:#0b1220;--card:#0f1629;--ink:#e6ebff;--ink-soft:#d7e0ff;--muted:#98a3c7;
        --line:#1b2744;--line-2:#122043;--brand-ghost:#0d1a36;
      }
    }

    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    html,body{height:100%}
    body{
      margin:0;font-family:'Tajawal',system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
      color:var(--ink);background:var(--bg);line-height:1.7;
      display:flex;flex-direction:column;-webkit-font-smoothing:antialiased;text-rendering:optimizeLegibility;
    }
    img{max-width:100%;display:block}
    .container{width:100%;max-width:1240px;margin-inline:auto;padding:0 clamp(12px,3vw,24px)}
    .page-main{flex:1;padding:clamp(12px,2.5vw,24px) 0;animation:fadeUp .5s ease both}

    /* Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù… */
    .progress-bar{position:fixed;inset:0 0 auto 0;height:3px;background:linear-gradient(90deg,#60a5fa,var(--brand));transform-origin:0 50%;transform:scaleX(0);z-index:200;box-shadow:0 2px 8px rgba(37,99,235,.25)}

    /* ===== Ø§Ù„Ù‡ÙŠØ¯Ø± ===== */
    .site-header{position:sticky;top:0;z-index:190;background:rgba(255,255,255,.88);border-bottom:1px solid var(--line);backdrop-filter:saturate(140%) blur(8px);transition:box-shadow .22s ease,background .22s ease,border-color .22s ease;padding-top:var(--safe-top)}
    @media (prefers-color-scheme: dark){.site-header{background:rgba(7,11,22,.75)}}
    .site-header.scrolled{box-shadow:0 10px 30px rgba(2,6,23,.10);background:rgba(255,255,255,.92);border-color:#dfe7ff}
    @media (prefers-color-scheme: dark){.site-header.scrolled{background:rgba(7,11,22,.85);border-color:#1a294f}}
    .topbar{display:flex;align-items:center;gap:10px;min-height:64px;padding:8px 0}

    .brand{display:flex;align-items:center;gap:10px;text-decoration:none;color:var(--ink-soft);font-weight:900;font-size:clamp(1.02rem,1.5vw,1.15rem);white-space:nowrap}
    .brand img{width:40px;height:40px;object-fit:contain}
    @media(max-width:480px){.brand img{width:32px;height:32px}}

    /* Ø²Ø± Ø§Ù„Ù‡Ù…Ø¨Ø±Ø¬Ø± */
    .hamburger{display:none;width:var(--tap);height:var(--tap);border:1px solid var(--line);border-radius:12px;align-items:center;justify-content:center;gap:4px;cursor:pointer;background:var(--card)}
    .hamburger span{display:block;width:18px;height:2px;background:#334155;border-radius:2px;transition:var(--t)}
    @media (prefers-color-scheme: dark){.hamburger span{background:#c7d2fe}}
    .hamburger.active span:nth-child(1){transform:translateY(4px) rotate(45deg)}
    .hamburger.active span:nth-child(2){opacity:0}
    .hamburger.active span:nth-child(3){transform:translateY(-4px) rotate(-45deg)}
    @media(max-width:1024px){.hamburger{display:flex}}

    /* Ù‚Ø§Ø¦Ù…Ø© Ø³Ø·Ø­ Ø§Ù„Ù…ÙƒØªØ¨ */
    .nav-desktop{margin-inline-start:auto;display:flex;align-items:center;gap:6px;flex-wrap:wrap}
    .nav-desktop a{--h:40px;position:relative;display:inline-flex;align-items:center;gap:8px;justify-content:center;min-height:var(--tap);height:var(--h);padding:0 14px;border-radius:12px;color:var(--muted);text-decoration:none;font-weight:800;transition:var(--t);white-space:nowrap}
    .nav-desktop a:hover{color:var(--brand)}
    .nav-desktop a::after{content:"";position:absolute;inset:auto 12px 6px 12px;height:3px;background:var(--brand);border-radius:2px;transform:scaleX(0);transform-origin:50% 50%;transition:transform .25s ease}
    .nav-desktop a:hover::after{transform:scaleX(1)}
    .nav-desktop a.active{color:var(--brand);background:var(--brand-ghost)}
    .nav-desktop a.active::after{transform:scaleX(1)}
    .nav-desktop .with-badge{display:inline-flex;align-items:center;gap:8px}
    .badge{min-width:20px;height:20px;padding:0 6px;border-radius:999px;display:inline-grid;place-items:center;font-size:12px;font-weight:900;color:#fff;background:#ef4444;transform:translateY(0);transition:transform .2s ease}
    .nav-desktop .with-badge:hover .badge{transform:translateY(-2px)}
    @media(max-width:1024px){.nav-desktop{display:none}}

    /* ===== Ø§Ù„Ø¯Ø±ÙˆÙØ± (Ø§Ù„Ø¬ÙˆØ§Ù„) ===== */
    .drawer-overlay{position:fixed;inset:0;z-index:180;background:rgba(2,6,23,.45);backdrop-filter:blur(2px);opacity:0;pointer-events:none;transition:var(--t)}
    .drawer{position:fixed;inset:0 auto 0 0;width:min(86vw,360px);max-width:420px;background:var(--card);border-inline-end:1px solid var(--line);box-shadow:20px 0 60px rgba(2,6,23,.25);transform:translateX(-102%);transition:var(--t);z-index:181;display:flex;flex-direction:column;padding-top:var(--safe-top);padding-bottom:var(--safe-bottom)}
    .drawer.open{transform:translateX(0)}
    .drawer-overlay.open{opacity:1;pointer-events:auto}
    .drawer-head{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--line)}
    .drawer-title{font-weight:900;color:var(--ink)}
    .drawer-close{width:40px;height:40px;border-radius:12px;border:1px solid var(--line);background:var(--card);cursor:pointer}
    .drawer-nav{padding:10px}
    .drawer-nav a{display:flex;align-items:center;gap:10px;padding:12px 14px;border-radius:12px;color:var(--ink);text-decoration:none;font-weight:800;border:1px solid transparent}
    .drawer-nav a:active{transform:scale(.99)}
    .drawer-nav a.active{background:var(--brand-ghost);border-color:#dbeafe;color:var(--brand)}
    .drawer-footer{margin-top:auto;padding:12px;border-top:1px solid var(--line);display:flex;gap:8px;flex-wrap:wrap}

    /* ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… */
    .userbox{position:relative}
    .avatar{width:36px;height:36px;border-radius:50%;display:grid;place-items:center;background:linear-gradient(135deg,var(--brand),var(--accent));color:#fff;font-weight:900;box-shadow:var(--shadow);cursor:pointer;border:0;transition:transform .18s ease}
    .avatar:hover{transform:translateY(-2px)}
    .menu{position:absolute;inset:calc(100% + 10px) 0 auto auto;min-width:220px;background:var(--card);border:1px solid var(--line);border-radius:12px;box-shadow:0 20px 40px rgba(2,6,23,.12);padding:8px;opacity:0;transform:translateY(-6px) scale(.98);pointer-events:none;transition:var(--t);z-index:185}
    .menu.open{opacity:1;transform:translateY(0) scale(1);pointer-events:auto}
    .menu .mi{display:flex;gap:10px;align-items:center;padding:10px 12px;border-radius:10px;color:var(--ink);text-decoration:none;font-weight:700}
    .menu .mi:hover{background:var(--line-2)}
    .menu .meta{color:var(--muted);font-size:.9rem}

    /* Ø±Ø³Ø§Ø¦Ù„ Django */
    .messages{margin:16px 0}
    .msg{padding:12px 14px;border-radius:12px;border:1px solid var(--line);background:#f8fbff;color:#0b1b3a;box-shadow:var(--shadow);margin-bottom:10px;animation:fadeIn .3s ease both}
    .msg.success{background:#f0fff6;border-color:#c8f3d6;color:#064e3b}
    .msg.error{background:#fff0f0;border-color:#ffd4d4;color:#7f1d1d}
    .msg.warning{background:#fffbeb;border-color:#fed7aa;color:#7c2d12}
    @media (prefers-color-scheme: dark){.msg{background:#0e1b35;color:#d8e3ff}}

    /* Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© (ÙƒÙ…Ø§ Ù‡ÙŠ) */
    .notify-overlay{position:fixed;inset:0;z-index:170;display:grid;place-items:center;padding:10px;padding-top:calc(10px + var(--safe-top));padding-bottom:calc(10px + var(--safe-bottom))}
    .notify-overlay::before{content:"";position:absolute;inset:0;background:radial-gradient(1200px 800px at 50% 20%, rgba(37,99,235,.20), rgba(2,6,23,.65));backdrop-filter:blur(4px)}
    .notify-card{position:relative;width:min(720px,92vw);max-height:86vh;overflow:auto;background:linear-gradient(180deg,#ffffff 0%, #fbfdff 100%);border:1px solid #e5edff;border-radius:20px;box-shadow:0 30px 80px rgba(2,6,23,.35);padding:20px 20px 16px;animation:popIn .25s ease both}
    @media (prefers-color-scheme: dark){.notify-card{background:linear-gradient(180deg,#0f1629 0%, #0b1326 100%);border-color:#1e2e59}}
    .notify-close{position:absolute;inset:12px 12px auto auto;width:38px;height:38px;border-radius:50%;border:0;background:#ef4444;color:#fff;font-size:20px;cursor:pointer;box-shadow:0 6px 18px rgba(239,68,68,.4)}
    .notify-head{display:flex;align-items:center;gap:14px}
    .notify-icon{font-size:2.1rem;width:54px;height:54px;display:grid;place-items:center;border-radius:14px;background:linear-gradient(135deg,#e9f0ff, #ffffff);border:1px solid #e7efff;box-shadow:0 8px 20px rgba(37,99,235,.10)}
    @media (prefers-color-scheme: dark){.notify-icon{background:linear-gradient(135deg,#0f1b36,#111f3d);border-color:#1e2e59}}
    .notify-title{margin:0;font-weight:900;color:#0b1b3a;font-size:clamp(1.05rem,2.5vw,1.35rem)}
    .notify-sub{color:#475569;font-weight:800;font-size:.95rem;margin-top:2px}
    @media (prefers-color-scheme: dark){.notify-title{color:#e6ebff}.notify-sub{color:#9fb0d9}}
    .notify-content{margin-top:12px;color:#1f2937;font-weight:800;line-height:1.95;white-space:pre-wrap;overflow-wrap:anywhere;direction:rtl;unicode-bidi:plaintext;background:linear-gradient(180deg,#f8fbff 0%, #ffffff 100%);border:1px dashed #dbeafe;border-radius:14px;padding:12px 14px}
    @media (prefers-color-scheme: dark){.notify-content{background:linear-gradient(180deg,#0f1b35 0%, #0d1830 100%);border-color:#28407b;color:#d9e5ff}}
    .notify-meta{margin-top:10px;color:#475569;font-weight:800;display:flex;align-items:center;gap:8px}
    @media (prefers-color-scheme: dark){.notify-meta{color:#a9b8de}}
    .notify-actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
    .notify-actions .btn{border-radius:999px;padding:10px 16px;min-height:var(--tap)}
    .btn{padding:8px 12px;border-radius:12px;border:1px solid var(--line);background:var(--card);cursor:pointer;font-weight:800;text-decoration:none;color:#1e293b}
    .btn-primary{background:var(--brand);color:#fff;border-color:var(--brand)}
    .btn-ghost{background:#eef2ff;border-color:#e5e7eb;color:#1e40af}
    .btn:hover{transform:translateY(-1px)}

    .notify-confetti{pointer-events:none; position:absolute; inset:0; overflow:hidden; border-radius:inherit}
    .notify-confetti .piece{position:absolute;width:8px;height:14px;border-radius:2px;opacity:.9;transform:translateY(-20px) rotate(0deg);animation:confettiFall 1800ms ease-out forwards, confettiSpin 1000ms linear infinite}
    @keyframes confettiFall{to { transform:translateY(110%) rotate(var(--rot)); opacity:1; }}
    @keyframes confettiSpin{from { filter:hue-rotate(0deg);} to { filter:hue-rotate(360deg);} }

    /* Ø§Ù„ÙÙˆØªØ± */
    .site-footer{background:linear-gradient(135deg,#0f1b30 0%, #0c1830 40%, #0b1630 100%);color:#dbe6ff;margin-top:16px;padding-bottom:var(--safe-bottom)}
    .site-footer .wrap{padding:26px 16px}
    .foot-grid{display:grid;gap:18px}
    @media(min-width:900px){.foot-grid{grid-template-columns:1.1fr .9fr .9fr}}
    .foot-title{font-weight:900;font-size:clamp(1rem,1.2rem,1.15rem);color:#eef3ff}
    .foot-links ul{list-style:none;display:grid;gap:8px;padding:0;margin:0}
    .foot-links a{color:#cfe0ff;text-decoration:none;font-weight:700}
    .foot-links a:hover{color:#fff;text-decoration:underline}
    .foot-bottom{border-top:1px solid rgba(255,255,255,.1);padding:12px 0;display:flex;gap:10px;flex-wrap:wrap;justify-content:space-between;font-size:.9rem}

    /* ÙˆØµÙˆÙ„/Ø­Ø±ÙƒØ© */
    a:focus-visible,button:focus-visible{outline:2px solid var(--brand);outline-offset:2px;box-shadow:var(--ring)}
    @media(prefers-reduced-motion:reduce){*{animation-duration:.01ms!important;animation-iteration-count:1!important;transition-duration:.01ms!important}}

    /* Ø£Ù†ÙŠÙ…ÙŠØ´Ù† Ø¹Ø§Ù… */
    @keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
    @keyframes fadeUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:none}}
    @keyframes popIn{from{opacity:0;transform:translateY(10px) scale(.98)}to{opacity:1;transform:none}}
  </style>

  {% block head %}{% endblock %}
</head>
<body>
  <div class="progress-bar" id="scrollProgress"></div>

  <!-- ===== Ø§Ù„Ù‡ÙŠØ¯Ø± ===== -->
  <header class="site-header" id="siteHeader">
    <div class="container topbar">
      <!-- Ø²Ø± Ù‡Ù…Ø¨Ø±Ø¬Ø± (Ø¬ÙˆØ§Ù„) -->
      <button class="hamburger" id="hamburger" aria-label="ÙØªØ­ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©" aria-controls="mobile-drawer" aria-expanded="false">
        <span></span><span></span><span></span>
      </button>

      <!-- Ø§Ù„Ø´Ø¹Ø§Ø± -->
      <a href="{% url 'reports:home' %}" class="brand">
        <img src="{% if SCHOOL_LOGO_URL %}{{ SCHOOL_LOGO_URL }}{% else %}{% static 'img/logo.png' %}{% endif %}" alt="Ø§Ù„Ø´Ø¹Ø§Ø±" loading="eager" decoding="async" width="40" height="40">
        <span>{% if SCHOOL_NAME %}{{ SCHOOL_NAME }}{% else %}Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±{% endif %}</span>
      </a>

      <!-- Ù‚Ø§Ø¦Ù…Ø© Ø³Ø·Ø­ Ø§Ù„Ù…ÙƒØªØ¨ -->
      {% with active=request.resolver_match.url_name %}
      <nav class="nav-desktop" aria-label="Ø±ÙˆØ§Ø¨Ø· Ø£Ø³Ø§Ø³ÙŠØ©">
        {% if request.user.is_authenticated %}
          <a class="{% if active == 'home' %}active{% endif %}" href="{% url 'reports:home' %}"><i class="fa-solid fa-house"></i> Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>

          {% url 'reports:assigned_to_me' as inbox_url %}
          {% if inbox_url %}
            <a class="with-badge {% if active == 'assigned_to_me' %}active{% endif %}" href="{{ inbox_url }}">
              <i class="fa-solid fa-inbox"></i> ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„ÙˆØ§Ø±Ø¯
              {% if NAV_ASSIGNED_TO_ME|default:0 > 0 %}<span class="badge">{{ NAV_ASSIGNED_TO_ME }}</span>{% endif %}
            </a>
          {% endif %}

          {% url 'reports:officer_reports' as officer_reports_url %}
          {% if officer_reports_url and SHOW_OFFICER_REPORTS_LINK %}
            <a class="with-badge {% if active == 'officer_reports' %}active{% endif %}" href="{{ officer_reports_url }}">
              <i class="fas fa-clipboard-list"></i> ØªÙ‚Ø§Ø±ÙŠØ± Ù‚Ø³Ù…ÙŠ
              {% if NAV_OFFICER_REPORTS|default:0 > 0 %}<span class="badge">{{ NAV_OFFICER_REPORTS }}</span>{% endif %}
            </a>
          {% endif %}

          {% if SHOW_ADMIN_DASHBOARD_LINK %}
            <a class="{% if active in 'admin_dashboard departments_list reporttypes_list manage_teachers admin_reports tickets_inbox' %}active{% endif %}" href="{% url 'reports:admin_dashboard' %}">
              <i class="fa-solid fa-gauge-high"></i> Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯ÙŠØ±
            </a>
          {% endif %}

          {% with send_url=SEND_NOTIFICATION_URL %}
            {% if not send_url %}{% url 'reports:notifications_create' as send_url %}{% endif %}
            {% if not send_url %}{% url 'reports:send_notification' as send_url %}{% endif %}
            {% if not send_url %}{% url 'reports:notification_create' as send_url %}{% endif %}
            {% if not send_url %}{% url 'reports:announcement_create' as send_url %}{% endif %}
            {% if not send_url %}{% url 'reports:admin_message_create' as send_url %}{% endif %}
            {% if not send_url %}{% url 'reports:notifications_send' as send_url %}{% endif %}
            {% if CAN_SEND_NOTIFICATIONS and send_url %}
              <a class="{% if active in 'notifications_create send_notification notification_create' %}active{% endif %}" href="{{ send_url }}">
                <i class="fa-solid fa-bullhorn"></i> Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø±
              </a>
            {% endif %}
          {% endwith %}

          {% url 'reports:my_notifications' as my_notifications_url %}
          {% if my_notifications_url %}
            <a class="with-badge {% if active == 'my_notifications' %}active{% endif %}" href="{{ my_notifications_url }}" aria-label="Ø¥Ø´Ø¹Ø§Ø±Ø§ØªÙŠ" title="Ø¥Ø´Ø¹Ø§Ø±Ø§ØªÙŠ">
              <i class="fa-solid fa-bell"></i>
              {% if NAV_NOTIFICATIONS_UNREAD|default:0 > 0 %}<span class="badge">{{ NAV_NOTIFICATIONS_UNREAD }}</span>{% endif %}
            </a>
          {% endif %}

          <!-- Ø­Ø³Ø§Ø¨ -->
          <div class="userbox">
            {% firstof request.user.name request.user.phone request.user.national_id "Ø­Ø³Ø§Ø¨ÙŠ" as display_name %}
            <button class="avatar" id="userAvatar" type="button" aria-haspopup="menu" aria-expanded="false" title="{{ display_name }}">
              {{ display_name|slice:":1" }}
            </button>
            <div class="menu" id="userMenu" role="menu" aria-label="Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
              <div class="mi" tabindex="0" style="cursor:default">
                <div>
                  <div style="font-weight:900">{{ display_name }}</div>
                  <div class="meta">Ù…Ø±Ø­Ø¨Ø§Ù‹ ğŸ‘‹</div>
                </div>
              </div>
              <a href="{% url 'reports:logout' %}" class="mi" role="menuitem">ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</a>
            </div>
          </div>
        {% else %}
          <a class="{% if active == 'login' %}active{% endif %}" href="{% url 'reports:login' %}">
            <i class="fa-solid fa-right-to-bracket"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
          </a>
        {% endif %}
      </nav>
      {% endwith %}
    </div>
  </header>

  <!-- ===== Ø§Ù„Ø¯Ø±ÙˆÙØ± Ù„Ù„Ø¬ÙˆØ§Ù„ ===== -->
  <div class="drawer-overlay" id="drawerOverlay" hidden></div>
  <aside class="drawer" id="mobile-drawer" aria-hidden="true" aria-labelledby="drawerTitle">
    <div class="drawer-head">
      <div class="drawer-title" id="drawerTitle">{% if SCHOOL_NAME %}{{ SCHOOL_NAME }}{% else %}Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±{% endif %}</div>
      <button class="drawer-close" id="drawerClose" aria-label="Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©"><i class="fa-solid fa-xmark"></i></button>
    </div>
    {% with active=request.resolver_match.url_name %}
    <nav class="drawer-nav" aria-label="Ù‚Ø§Ø¦Ù…Ø© Ø¬ÙˆØ§Ù„">
      {% if request.user.is_authenticated %}
        <a class="{% if active == 'home' %}active{% endif %}" href="{% url 'reports:home' %}"><i class="fa-solid fa-house"></i> Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>

        {% url 'reports:assigned_to_me' as inbox_url %}
        {% if inbox_url %}
          <a class="{% if active == 'assigned_to_me' %}active{% endif %}" href="{{ inbox_url }}"><i class="fa-solid fa-inbox"></i> ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„ÙˆØ§Ø±Ø¯
            {% if NAV_ASSIGNED_TO_ME|default:0 > 0 %}&nbsp;<span class="badge">{{ NAV_ASSIGNED_TO_ME }}</span>{% endif %}
          </a>
        {% endif %}

        {% url 'reports:officer_reports' as officer_reports_url %}
        {% if officer_reports_url and SHOW_OFFICER_REPORTS_LINK %}
          <a class="{% if active == 'officer_reports' %}active{% endif %}" href="{{ officer_reports_url }}"><i class="fas fa-clipboard-list"></i> ØªÙ‚Ø§Ø±ÙŠØ± Ù‚Ø³Ù…ÙŠ
            {% if NAV_OFFICER_REPORTS|default:0 > 0 %}&nbsp;<span class="badge">{{ NAV_OFFICER_REPORTS }}</span>{% endif %}
          </a>
        {% endif %}

        {% if SHOW_ADMIN_DASHBOARD_LINK %}
          <a class="{% if active in 'admin_dashboard departments_list reporttypes_list manage_teachers admin_reports tickets_inbox' %}active{% endif %}" href="{% url 'reports:admin_dashboard' %}">
            <i class="fa-solid fa-gauge-high"></i> Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯ÙŠØ±
          </a>
        {% endif %}

        {% with send_url=SEND_NOTIFICATION_URL %}
          {% if not send_url %}{% url 'reports:notifications_create' as send_url %}{% endif %}
          {% if not send_url %}{% url 'reports:send_notification' as send_url %}{% endif %}
          {% if not send_url %}{% url 'reports:notification_create' as send_url %}{% endif %}
          {% if not send_url %}{% url 'reports:announcement_create' as send_url %}{% endif %}
          {% if not send_url %}{% url 'reports:admin_message_create' as send_url %}{% endif %}
          {% if not send_url %}{% url 'reports:notifications_send' as send_url %}{% endif %}
          {% if CAN_SEND_NOTIFICATIONS and send_url %}
            <a class="{% if active in 'notifications_create send_notification notification_create' %}active{% endif %}" href="{{ send_url }}"><i class="fa-solid fa-bullhorn"></i> Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø±</a>
          {% endif %}
        {% endwith %}

        {% url 'reports:my_notifications' as my_notifications_url %}
        {% if my_notifications_url %}
          <a class="{% if active == 'my_notifications' %}active{% endif %}" href="{{ my_notifications_url }}"><i class="fa-solid fa-bell"></i> Ø¥Ø´Ø¹Ø§Ø±Ø§ØªÙŠ
            {% if NAV_NOTIFICATIONS_UNREAD|default:0 > 0 %}&nbsp;<span class="badge">{{ NAV_NOTIFICATIONS_UNREAD }}</span>{% endif %}
          </a>
        {% endif %}

        <div class="drawer-footer">
          <a class="btn" href="{% url 'reports:logout' %}">ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</a>
        </div>
      {% else %}
        <a class="{% if active == 'login' %}active{% endif %}" href="{% url 'reports:login' %}"><i class="fa-solid fa-right-to-bracket"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</a>
      {% endif %}
    </nav>
    {% endwith %}
  </aside>

  <main class="container page-main">
    {% if messages %}
      <div class="messages" id="messages-container">
        {% for message in messages %}
          <div class="msg {{ message.tags }}">{{ message }}</div>
        {% endfor %}
      </div>
    {% endif %}

    {# Ù†Ø§ÙØ°Ø© Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (ÙƒÙ…Ø§ ÙƒØ§Ù†Øª) #}
    {% with active=request.resolver_match.url_name %}
    {% if NAV_NOTIFICATION_HERO and active == 'home' %}
      {% url 'reports:my_notifications' as my_notifications_url %}
      <div class="notify-overlay" id="notifyOverlay" role="dialog" aria-modal="true" aria-labelledby="notifyTitle">
        <div class="notify-card" data-notif-id="{{ NAV_NOTIFICATION_HERO.id }}">
          <button class="notify-close" id="notifyClose" aria-label="Ø¥ØºÙ„Ø§Ù‚">Ã—</button>
          <div class="notify-head">
            <div class="notify-icon" aria-hidden="true">ğŸ‰</div>
            <div>
              <h3 class="notify-title" id="notifyTitle">{{ NAV_NOTIFICATION_HERO.title|default:"Ø¥Ø´Ø¹Ø§Ø± ØªØ­ÙÙŠØ²ÙŠ" }}</h3>
              <div class="notify-sub">Ø¯ÙØ¹Ø© Ø­Ù…Ø§Ø³ ØµØºÙŠØ±Ø© Ù„Ø¨Ø¯Ø¡ ÙŠÙˆÙ…Ùƒ Ø¨Ù‚ÙˆØ© ğŸ’ª</div>
            </div>
          </div>
          <div class="notify-content">{{ NAV_NOTIFICATION_HERO.body|default:"Ù†Ø¤Ù…Ù† Ø¨Ù‚Ø¯Ø±ØªÙƒ Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ù†Ø¬Ø§Ø² â€” Ø®Ø° Ø®Ø·ÙˆØ© Ø§Ù„Ø¢Ù†ØŒ Ù…Ù‡Ù…Ø§ ÙƒØ§Ù†Øª ØµØºÙŠØ±Ø©." }}</div>
          <div class="notify-meta"><i class="fa-solid fa-user-tie"></i><span>Ù…Ù†: {{ NAV_NOTIFICATION_HERO.sender_name|default:"Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©" }}</span></div>
          <div class="notify-actions">
            {% if NAV_NOTIFICATION_HERO.action_url %}<a class="btn btn-primary" href="{{ NAV_NOTIFICATION_HERO.action_url }}" rel="noopener">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¢Ù† <i class="fa-solid fa-arrow-left-long"></i></a>{% endif %}
            {% if my_notifications_url %}<a class="btn btn-ghost" href="{{ my_notifications_url }}"><i class="fa-solid fa-bell"></i> ØµÙØ­Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</a>{% endif %}
            <button class="btn" id="notifyLater">Ø¥ØºÙ„Ø§Ù‚</button>
          </div>
          <div class="notify-confetti" aria-hidden="true"></div>
        </div>
      </div>
    {% endif %}
    {% endwith %}

    {% block content %}{% endblock %}
  </main>

  <footer class="site-footer">
    <div class="container wrap">
      <div class="foot-grid">
        <div>
          <div class="foot-title">{% if SCHOOL_NAME %}{{ SCHOOL_NAME }}{% else %}Ø«Ø§Ù†ÙˆÙŠØ© Ø¹Ø¨Ø¯Ø§Ù„Ø¹Ø²ÙŠØ² Ø¨Ù† Ø¨Ø§Ø²{% endif %}</div>
          <p>Tawtheeq</p>

          <p>Ù†Ø¸Ø§Ù… ØªÙˆØ«ÙŠÙ‚ Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† ÙˆØ§Ù„Ø·Ù„Ø¨Ø§Øª â€” Ø§Ù„ØªÙˆØ§ØµÙ„ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ.</p>
        </div>
        <nav class="foot-links" aria-label="Ø±ÙˆØ§Ø¨Ø·"></nav>
        <div>
          <div class="foot-title" style="font-size:1rem;">ØªÙˆØ§ØµÙ„</div>
          <p>{% if SCHOOL_NAME %}{{ SCHOOL_NAME }}{% else %}Ø«Ø§Ù†ÙˆÙŠØ© Ø¹Ø¨Ø¯Ø§Ù„Ø¹Ø²ÙŠØ² Ø¨Ù† Ø¨Ø§Ø²{% endif %}</p>
          <p>Ù„ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù….</p>
        </div>
      </div>
      <div class="foot-bottom">
        <span>Â© {% now "Y" %} ØªØµÙ…ÙŠÙ… <b>MANS</b> â€” Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©</span>
      </div>
    </div>
  </footer>

  <button id="toTop" title="Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø£Ø¹Ù„Ù‰" aria-label="Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø£Ø¹Ù„Ù‰" style="display:none;position:fixed;inset:auto calc(18px + var(--safe-right)) calc(24px + var(--safe-bottom)) auto;width:46px;height:46px;border:0;border-radius:50%;background:linear-gradient(135deg,var(--brand),#10b981);color:#fff;cursor:pointer;box-shadow:0 10px 28px rgba(37,99,235,.35);">â†‘</button>

  <script>
    // ===== CSRF (Ù„Ù„Ø·Ù„Ø¨ÙŠØ§Øª Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ©) =====
    (function(){function g(n){const v=`; ${document.cookie}`.split(`; ${n}=`);if(v.length===2)return decodeURIComponent(v.pop().split(';').shift())}window.csrfToken=g('csrftoken')})();

    document.addEventListener('DOMContentLoaded', function(){
      const header = document.getElementById('siteHeader');
      const progress = document.getElementById('scrollProgress');
      const onScroll = () => {
        const y = window.scrollY || document.documentElement.scrollTop;
        header.classList.toggle('scrolled', y > 6);
        const h = document.documentElement.scrollHeight - window.innerHeight;
        progress.style.transform = `scaleX(${h>0?(y/h):0})`;
      };
      window.addEventListener('scroll', onScroll, {passive:true}); onScroll();

      // Ø¥Ø®ÙØ§Ø¡ Ø±Ø³Ø§Ø¦Ù„ Django ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
      document.querySelectorAll('.msg').forEach(el=>{
        setTimeout(()=>{ el.style.opacity='0'; el.style.transform='translateY(-6px)'; setTimeout(()=>el.remove(), 300); }, 3000);
      });

      // ===== Ø¯Ø±ÙˆÙØ± Ø§Ù„Ø¬ÙˆØ§Ù„ =====
      const body = document.body;
      const burger = document.getElementById('hamburger');
      const drawer = document.getElementById('mobile-drawer');
      const overlay = document.getElementById('drawerOverlay');
      const btnClose = document.getElementById('drawerClose');

      let lastFocus = null;
      const focusableSel = 'a,button,input,select,textarea,[tabindex]:not([tabindex="-1"])';

      function openDrawer(){
        lastFocus = document.activeElement;
        overlay.hidden = false;
        requestAnimationFrame(()=>{
          overlay.classList.add('open');
          drawer.classList.add('open');
          drawer.setAttribute('aria-hidden','false');
          burger.classList.add('active'); burger.setAttribute('aria-expanded','true');
          body.style.overflow='hidden';
          // Focus trap
          const f = drawer.querySelector(focusableSel);
          f && f.focus({preventScroll:true});
        });
      }

      function closeDrawer(){
        overlay.classList.remove('open');
        drawer.classList.remove('open');
        drawer.setAttribute('aria-hidden','true');
        burger.classList.remove('active'); burger.setAttribute('aria-expanded','false');
        body.style.overflow='';
        setTimeout(()=>{ overlay.hidden = true; }, 220);
        if(lastFocus) lastFocus.focus({preventScroll:true});
      }

      if(burger){
        burger.addEventListener('click', ()=> (drawer.classList.contains('open') ? closeDrawer() : openDrawer()));
      }
      if(btnClose) btnClose.addEventListener('click', closeDrawer);
      if(overlay) overlay.addEventListener('click', closeDrawer);
      document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && drawer.classList.contains('open')) closeDrawer(); });

      // Ø³Ø­Ø¨ Ù„Ù„Ø¥ØºÙ„Ø§Ù‚ (ØªØ¬Ø±Ø¨Ø© Ø¬ÙˆØ§Ù„ Ù„Ø·ÙŠÙØ©)
      let startX=null;
      drawer.addEventListener('touchstart', (e)=>{ startX = e.touches[0].clientX; }, {passive:true});
      drawer.addEventListener('touchmove', (e)=>{
        if(startX===null) return;
        const dx = e.touches[0].clientX - startX;
        if(dx < -40) closeDrawer();
      }, {passive:true});
      drawer.addEventListener('touchend', ()=>{ startX=null; });

      // Ø¥Ø°Ø§ ÙƒØ¨Ø± Ø§Ù„Ø¹Ø±Ø¶ Ù†Ø¶Ù…Ù† Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¯Ø±ÙˆÙØ±
      matchMedia('(min-width:1025px)').addEventListener('change', (e)=>{ if(e.matches) closeDrawer(); });

      // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ø§Ø³Ù… + Ø®Ø±ÙˆØ¬)
      const avatar = document.getElementById('userAvatar');
      const menu = document.getElementById('userMenu');
      if(avatar && menu){
        const close = ()=>{ menu.classList.remove('open'); avatar.setAttribute('aria-expanded','false'); };
        avatar.addEventListener('click', ()=>{
          const open = menu.classList.toggle('open');
          avatar.setAttribute('aria-expanded', open ? 'true' : 'false');
        });
        document.addEventListener('click', (e)=>{ if(!e.target.closest('#userMenu') && !e.target.closest('#userAvatar')) close(); });
        document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') close(); });
      }

      // Ø²Ø± Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø£Ø¹Ù„Ù‰
      const toTop = document.getElementById('toTop');
      if(toTop){
        const toggle = ()=>{ window.scrollY > 260 ? (toTop.style.display='grid') : (toTop.style.display='none'); };
        window.addEventListener('scroll', toggle, {passive:true}); toggle();
        toTop.addEventListener('click', ()=>window.scrollTo({top:0, behavior:'smooth'}));
      }

      // ===== Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± =====
      const overlayN = document.getElementById('notifyOverlay');
      const btnNClose = document.getElementById('notifyClose');
      const btnNLater = document.getElementById('notifyLater');

      function getCookie(name){ const v=`; ${document.cookie}`.split(`; ${name}=`); if(v.length===2) return decodeURIComponent(v.pop().split(';').shift()); }
      async function markReadByNotification(notifId){
        if(!notifId) return;
        try{
          await fetch(`/notifications/${notifId}/read-by-notification/`, {
            method:'POST',
            headers:{'X-CSRFToken': (window.csrfToken || getCookie('csrftoken')),'X-Requested-With':'XMLHttpRequest'},
            credentials:'same-origin'
          });
        }catch(e){}
      }
      function launchConfetti(box){
        if(!box) return; const count=40;
        for(let i=0;i<count;i++){
          const s=document.createElement('span'); s.className='piece'; s.style.left=(Math.random()*100)+'%';
          const hue=Math.floor(Math.random()*360);
          s.style.background=`hsl(${hue}deg,85%,60%)`; s.style.animationDelay=(Math.random()*0.35)+'s'; s.style.setProperty('--rot',(Math.random()*360-180)+'deg');
          box.appendChild(s); setTimeout(()=>s.remove(),2200);
        }
      }
      if(overlayN){
        const card=overlayN.querySelector('.notify-card'); const confettiBox=overlayN.querySelector('.notify-confetti'); const id=card?card.getAttribute('data-notif-id'):null;
        if(id && document.cookie.includes(`notif_dismissed_${id}=1`)){ overlayN.style.display='none'; } else { setTimeout(()=>launchConfetti(confettiBox),120); }
        const dismiss=()=>{ Promise.resolve(markReadByNotification(id)).finally(()=>{ if(id) document.cookie=`notif_dismissed_${id}=1; path=/; max-age=2592000; SameSite=Lax`; overlayN.style.display='none'; }); };
        btnNClose && btnNClose.addEventListener('click', dismiss);
        btnNLater && btnNLater.addEventListener('click', dismiss);
        overlayN.addEventListener('click', (e)=>{ if(e.target===overlayN) dismiss(); });
        document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') dismiss(); });
      }
    });
  </script>

  {% block scripts %}{% endblock %}
</body>
</html>
