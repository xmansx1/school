{% load static %}
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>{% block title %}نظام التقارير{% endblock %}</title>

  <!-- أداء -->
  <link rel="preload" href="{% static 'css/app.css' %}" as="style">
  <link rel="stylesheet" href="{% static 'css/app.css' %}" />

  <!-- الخط والأيقونات (نبقي الأيقونات للجرس وبعض العناصر الثانوية فقط) -->
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <style>
    :root{
      --brand:#2563eb;--brand-ink:#1e3a8a;--brand-ghost:#e8efff;
      --accent:#10b981;--ink:#0f172a;--ink-soft:#1f2937;--muted:#64748b;
      --bg:#f8fafc;--card:#ffffff;--line:#e5e7eb;--line-2:#f1f5f9;
      --radius:14px;--t:all .22s ease;--shadow:0 4px 16px rgba(2,6,23,.08);--ring:0 0 0 3px rgba(37,99,235,.25);
      --tap:48px;
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-right: env(safe-area-inset-right, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
      --safe-left: env(safe-area-inset-left, 0px);
    }
    @media (prefers-color-scheme: dark){
      :root{
        --bg:#0b1220;--card:#0f1629;--ink:#e6ebff;--ink-soft:#d7e0ff;--muted:#98a3c7;
        --line:#1b2744;--line-2:#122043;--brand-ghost:#0d1a36;
      }
    }

    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    html,body{height:100%}
    body{
      margin:0;font-family:'Tajawal',system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
      color:var(--ink);background:var(--bg);line-height:1.7;
      display:flex;flex-direction:column;-webkit-font-smoothing:antialiased;text-rendering:optimizeLegibility;
    }
    img{max-width:100%;display:block}
    .container{width:100%;max-width:1240px;margin-inline:auto;padding:0 clamp(12px,3vw,24px)}
    .page-main{flex:1;padding:clamp(12px,2.5vw,24px) 0;animation:fadeUp .5s ease both}
    @keyframes fadeUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:none}}

    /* ===== شريط التقدم ===== */
    .progress-bar{position:fixed;top:0;right:0;height:3px;width:0;background:linear-gradient(90deg,#2563eb,#10b981);z-index:9999;transition:width .2s ease}

    /* ===== الهيدر ===== */
    .site-header{
      position:sticky;top:0;inset-inline:0;z-index:900;background:rgba(255,255,255,.82);
      border-bottom:1px solid var(--line-2);backdrop-filter:saturate(180%) blur(12px);
      transition:box-shadow .25s ease, background .25s ease, border-color .25s ease;
    }
    @media (prefers-color-scheme: dark){.site-header{background:rgba(7,11,22,.75)}}
    .site-header.scrolled{box-shadow:0 10px 30px rgba(2,6,23,.10);background:rgba(255,255,255,.92);border-color:#dfe7ff}
    @media (prefers-color-scheme: dark){.site-header.scrolled{background:rgba(7,11,22,.85);border-color:#1a294f}}
    .topbar{display:flex;align-items:center;gap:10px;min-height:64px;padding:8px 0}

    .brand{display:flex;align-items:center;gap:10px;text-decoration:none}
    .brand span{font-weight:900;font-size:clamp(1.02rem,1.5vw,1.15rem);white-space:nowrap}
    .brand img{width:40px;height:40px;object-fit:contain}
    @media(max-width:480px){.brand img{width:32px;height:32px}}

    /* زر الهمبرجر */
    .hamburger{display:none;width:var(--tap);height:var(--tap);border-radius:12px;border:1px solid var(--line);align-items:center;justify-content:center;gap:4px;cursor:pointer;background:var(--card)}
    .hamburger span{display:block;width:18px;height:2px;background:#334155;border-radius:2px;transition:var(--t)}
    @media (prefers-color-scheme: dark){.hamburger span{background:#c7d2fe}}
    .hamburger.active span:nth-child(1){transform:translateY(4px) rotate(45deg)}
    .hamburger.active span:nth-child(2){opacity:0}
    .hamburger.active span:nth-child(3){transform:translateY(-4px) rotate(-45deg)}
    @media(max-width:1024px){.hamburger{display:flex}}

    /* قائمة سطح المكتب — نصية بدون أيقونات لتفادي التكرار مع الصفحة الرئيسية */
    .nav-desktop{margin-inline-start:auto;display:flex;align-items:center;gap:6px;flex-wrap:wrap}
    .nav-desktop a{--h:40px;position:relative;display:inline-flex;align-items:center;gap:8px;height:var(--h);padding:0 12px;border-radius:10px;border:1px solid transparent;color:var(--ink);text-decoration:none;font-weight:800;transition:var(--t);white-space:nowrap}
    .nav-desktop a:hover{color:var(--brand)}
    .nav-desktop a::after{content:"";position:absolute;inset:auto 10px 6px 10px;height:2px;background:currentColor;transform:scaleX(0);transform-origin:50% 50%;transition:transform .25s ease}
    .nav-desktop a:hover::after{transform:scaleX(1)}
    .nav-desktop a.active{color:var(--brand);background:var(--brand-ghost)}
    .nav-desktop a.active::after{transform:scaleX(1)}
    @media(max-width:1024px){.nav-desktop{display:none}}

    /* شارة */
    .badge{min-width:20px;height:20px;padding:0 6px;border-radius:999px;display:inline-grid;place-items:center;font-size:.78rem;color:#fff;background:#ef4444}

    /* ===== الدروَر للجوال (RTL: من اليمين) ===== */
    .drawer-overlay{
      position:fixed;inset:0;background:rgba(2,6,23,.45);
      backdrop-filter:blur(6px);z-index:980;display:none;
    }
    .drawer{
      position:fixed;
      inset:0 0 0 auto;                /* أعلى-يمين-أسفل-يسار: نثبته يمين الشاشة */
      width:min(320px,86vw);
      background:var(--card);
      border-inline-start:1px solid var(--line);
      z-index:990;
      transform:translateX(110%);       /* خارج الشاشة يمينًا */
      transition:var(--t);
      display:flex;flex-direction:column;
      max-height:100vh;overflow:auto;
      padding-bottom:var(--safe-bottom);
    }
    .drawer.open{transform:translateX(0)}
    .drawer-overlay.show{display:block}
    .drawer-head{display:flex;align-items:center;justify-content:space-between;padding:12px;border-bottom:1px solid var(--line)}
    .drawer-title{font-weight:900}
    .drawer-nav{display:grid;padding:12px;gap:10px}
    .drawer-nav a{display:flex;align-items:center;gap:10px;padding:12px;border:1px solid var(--line);border-radius:12px;text-decoration:none;color:var(--ink);font-weight:800;background:linear-gradient(180deg,#fff,#fbfdff)}
    @media (prefers-color-scheme:dark){.drawer-nav a{background:linear-gradient(180deg,#0f1629,#0c1530)}}
    .drawer-nav a:hover{background:var(--line-2)}
    .drawer-footer{margin-top:auto;padding:12px;border-top:1px solid var(--line);display:flex;gap:8px;flex-wrap:wrap}

    /* صندوق المستخدم (نبقي الأفاتار فقط؛ لا نكرر الأيقونات الكبيرة) */
    .userbox{position:relative}
    .avatar{width:36px;height:36px;border-radius:50%;display:grid;place-items:center;background:linear-gradient(180deg,#eef2ff,#fff);color:#1e40af;font-weight:900;border:1px solid #dbeafe;box-shadow:var(--shadow);cursor:pointer;border:0;transition:transform .18s ease}
    .avatar:hover{transform:translateY(-2px)}
    .menu{position:absolute;inset:calc(100% + 10px) 0 auto auto;min-width:220px;background:var(--card);border:1px solid var(--line);border-radius:12px;box-shadow:0 20px 40px rgba(2,6,23,.12);padding:8px;opacity:0;transform:translateY(-6px) scale(.98);pointer-events:none;transition:var(--t);z-index:185}
    .menu.open{opacity:1;transform:translateY(0) scale(1);pointer-events:auto}
    .menu .mi{display:flex;gap:10px;align-items:center;padding:10px 12px;border-radius:10px;color:var(--ink);text-decoration:none;font-weight:700}
    .menu .mi:hover{background:var(--line-2)}
    .menu .meta{color:var(--muted);font-size:.9rem}

    /* رسائل Django */
    .messages{margin:16px 0}
    .msg{position:relative;padding:12px 14px;border-radius:12px;border:1px solid var(--line);background:#f8fbff;color:#0b1b3a;box-shadow:var(--shadow);margin-bottom:10px;animation:fadeUp .5s ease both}
    .msg.success{background:#f0fff6;border-color:#c8f3d6;color:#064e3b}
    .msg.error{background:#fff0f0;border-color:#ffd4d4;color:#7f1d1d}
    .msg.warning{background:#fffbeb;border-color:#fed7aa;color:#7c2d12}
    .msg-close{position:absolute;top:8px;left:8px;background:none;border:0;cursor:pointer;opacity:0.7;transition:opacity 0.2s ease;padding:0;font-size:14px}
    .msg-close:hover{opacity:1}
    .msg-progress{position:absolute;bottom:0;left:0;height:3px;width:100%;background:rgba(0,0,0,0.1);overflow:hidden}
    .msg-progress::after{content:'';position:absolute;bottom:0;left:0;height:3px;width:100%;background:currentColor;opacity:0.3;animation:progress 3s linear forwards}
    @media (prefers-color-scheme: dark){.msg{background:#0e1b35;color:#d8e3ff}}
    @keyframes progress{from{transform:translateX(-100%)}to{transform:none}}

    /* ===== نافذة الإشعار المنبثقة (Hero) ===== */
    .notify-overlay{position:fixed; inset:0; z-index:10000; display:grid; place-items:center; padding:10px; padding-top:calc(10px + var(--safe-top)); padding-bottom:calc(10px + var(--safe-bottom));}
    .notify-overlay[hidden]{display:none}
    .notify-card{
      position:relative; width:min(520px,92vw); max-height:min(80vh,520px); overflow:auto;
      border:1px solid #dbeafe; border-radius:16px; background:linear-gradient(135deg,#ffffff 0%, #f7fbff 100%);
      box-shadow:0 30px 60px rgba(2,6,23,.20); padding:16px;
    }
    @media (prefers-color-scheme: dark){
      .notify-card{ background:linear-gradient(135deg,#0f1b35,#0d1830); border-color:#1e2e59; }
    }
    .notify-head{display:flex;align-items:center;gap:14px}
    .notify-icon{font-size:2.1rem;width:54px;height:54px;display:grid;place-items:center;border-radius:16px;background:linear-gradient(135deg,#eef2ff,#ffffff);color:#1e40af;border:1px solid #e7efff;box-shadow:0 8px 20px rgba(37,99,235,.10)}
    @media (prefers-color-scheme: dark){.notify-icon{background:linear-gradient(135deg,#0f1b36,#111f3d);border-color:#1e2e59}}
    .notify-title{margin:0;font-weight:900;color:#0b1b3a;font-size:clamp(1.05rem,2.5vw,1.35rem)}
    .notify-sub{color:#475569;font-weight:800;font-size:.95rem;margin-top:2px}
    @media (prefers-color-scheme: dark){.notify-title{color:#e6ebff}.notify-sub{color:#9fb0d9}}
    .notify-content{margin-top:12px;color:#1f2937;font-weight:800;background:linear-gradient(180deg,#ffffff,#fbfdff);border:1px dashed #dbeafe;border-radius:14px;padding:12px 14px;white-space:pre-line}
    @media (prefers-color-scheme: dark){.notify-content{background:linear-gradient(180deg,#0f1b35,#0d1830);border-color:#28407b;color:#d9e5ff}}
    .notify-meta{margin-top:10px;color:#475569;font-weight:800;display:flex;align-items:center;gap:8px}
    @media (prefers-color-scheme: dark){.notify-meta{color:#a9b8de}}
    .notify-actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
    .notify-actions .btn{border-radius:999px;padding:10px 16px;min-height:var(--tap)}
    .btn{padding:8px 12px;border:1px solid var(--line);border-radius:12px;background:var(--card);cursor:pointer;font-weight:800;text-decoration:none;color:#1e293b}
    .btn-primary{background:var(--brand);color:#fff;border-color:var(--brand)}
    .btn-ghost{background:#eef2ff;border-color:#e5e7eb;color:#1e40af}
    .btn:hover{transform:translateY(-1px)}
    .notify-confetti{pointer-events:none; position:absolute; inset:0; overflow:hidden; border-radius:inherit}
    .notify-card.is-anchored{ position:fixed; width:min(520px,92vw); max-height:min(80vh,520px);}
    .notify-card.is-anchored::after{content:""; position:absolute; width:14px; height:14px; rotate:45deg; background:inherit; border:inherit; border-left:none; border-top:none;}

    /* زر العودة للأعلى */
    .to-top{position:fixed;left:16px;bottom:16px;z-index:880;display:none;width:40px;height:40px;border-radius:999px;border:1px solid var(--line);background:var(--card);display:grid;place-items:center;box-shadow:var(--shadow);cursor:pointer}
    .to-top:hover{transform:translateY(-2px)}
  </style>

  {% block head %}{% endblock %}
</head>
<body>
  <div class="progress-bar" id="scrollProgress"></div>

  <!-- ===== الهيدر ===== -->
  <header class="site-header" id="siteHeader">
    <div class="container topbar">
      <!-- زر همبرجر (جوال) -->
      <button class="hamburger" id="hamburger" aria-label="فتح القائمة" aria-controls="mobile-drawer" aria-expanded="false">
        <span></span><span></span><span></span>
      </button>

      <!-- الشعار -->
      <a href="{% url 'reports:home' %}" class="brand">
        <img src="{% if SCHOOL_LOGO_URL %}{{ SCHOOL_LOGO_URL }}{% else %}{% static 'img/logo.png' %}{% endif %}" alt="الشعار" loading="eager" decoding="async" width="40" height="40">
        <span>{% if SCHOOL_NAME %}{{ SCHOOL_NAME }}{% else %}نظام التقارير{% endif %}</span>
      </a>

      <!-- قائمة سطح المكتب (نصية بدون أيقونات لتجنّب التكرار) -->
      {% with active=request.resolver_match.url_name %}
      <nav class="nav-desktop" aria-label="روابط أساسية">
        {% if request.user.is_authenticated %}
          <a class="{% if active == 'home' %}active{% endif %}" href="{% url 'reports:home' %}">الرئيسية</a>

          {% url 'reports:assigned_to_me' as inbox_url %}
          {% if inbox_url %}
            <a class="{% if active == 'assigned_to_me' %}active{% endif %}" href="{{ inbox_url }}">
              الوارد{% if NAV_ASSIGNED_TO_ME|default:0 > 0 %} <span class="badge">{{ NAV_ASSIGNED_TO_ME }}</span>{% endif %}
            </a>
          {% endif %}

          {% if SHOW_OFFICER_REPORTS_LINK %}
            <a class="{% if active == 'officer_reports' %}active{% endif %}" href="{% url 'reports:officer_reports' %}">تقارير قسمي</a>
          {% endif %}

          {% if SHOW_ADMIN_DASHBOARD_LINK %}
            <a class="{% if active == 'admin_dashboard' %}active{% endif %}" href="{% url 'reports:admin_dashboard' %}">لوحة المدير</a>
          {% endif %}

          {% url 'reports:my_notifications' as my_notifications_url %}
          {% if my_notifications_url %}
            <!-- نُبقي أيقونة الجرس فقط (ليست مكررة في الصفحة الرئيسية) -->
            <a class="{% if active == 'my_notifications' %}active{% endif %}" href="{{ my_notifications_url }}" aria-label="إشعاراتي">
              <i class="fa-solid fa-bell"></i>
              {% if NAV_NOTIFICATIONS_UNREAD|default:0 > 0 %}<span class="badge">{{ NAV_NOTIFICATIONS_UNREAD }}</span>{% endif %}
            </a>
          {% endif %}

          <!-- حساب -->
          <div class="userbox">
            {% firstof request.user.name request.user.phone request.user.national_id "حسابي" as display_name %}
            <button class="avatar" id="userAvatar" type="button" aria-haspopup="menu" aria-expanded="false" title="{{ display_name }}">
              {{ display_name|slice:":1" }}
            </button>
            <div class="menu" id="userMenu" role="menu" aria-label="قائمة المستخدم">
              <div class="mi" tabindex="0" style="cursor:default">
                <div>
                  <div style="font-weight:900">{{ display_name }}</div>
                  <div class="meta">مرحباً 👋</div>
                </div>
              </div>
              <a href="{% url 'reports:logout' %}" class="mi" role="menuitem">تسجيل الخروج</a>
            </div>
          </div>
        {% else %}
          <a class="{% if active == 'login' %}active{% endif %}" href="{% url 'reports:login' %}">
            تسجيل الدخول
          </a>
        {% endif %}
      </nav>
      {% endwith %}
    </div>
  </header>

  <!-- ===== الدروَر للجوال (من اليمين) ===== -->
  <div class="drawer-overlay" id="drawerOverlay" hidden></div>
  <aside class="drawer" id="mobile-drawer" aria-hidden="true" aria-labelledby="drawerTitle">
    <div class="drawer-head">
      <div id="drawerTitle" class="drawer-title">القائمة</div>
      <button class="btn" id="drawerClose" aria-label="إغلاق">إغلاق</button>
    </div>
    {% with active=request.resolver_match.url_name %}
    <nav class="drawer-nav" aria-label="القائمة الجانبية">
      {% if request.user.is_authenticated %}
        <a class="{% if active == 'home' %}active{% endif %}" href="{% url 'reports:home' %}">الرئيسية</a>

        {% url 'reports:assigned_to_me' as inbox_url %}
        {% if inbox_url %}
          <a class="{% if active == 'assigned_to_me' %}active{% endif %}" href="{{ inbox_url }}">
            الوارد{% if NAV_ASSIGNED_TO_ME|default:0 > 0 %} <span class="badge">{{ NAV_ASSIGNED_TO_ME }}</span>{% endif %}
          </a>
        {% endif %}

        {% if SHOW_OFFICER_REPORTS_LINK %}
          <a class="{% if active == 'officer_reports' %}active{% endif %}" href="{% url 'reports:officer_reports' %}">تقارير قسمي</a>
        {% endif %}

        {% if SHOW_ADMIN_DASHBOARD_LINK %}
          <a class="{% if active == 'admin_dashboard' %}active{% endif %}" href="{% url 'reports:admin_dashboard' %}">لوحة المدير</a>
        {% endif %}

        {% url 'reports:my_notifications' as my_notifications_url %}
        {% if my_notifications_url %}
          <a class="{% if active == 'my_notifications' %}active{% endif %}" href="{{ my_notifications_url }}">
            إشعاراتي{% if NAV_NOTIFICATIONS_UNREAD|default:0 > 0 %} <span class="badge">{{ NAV_NOTIFICATIONS_UNREAD }}</span>{% endif %}
          </a>
        {% endif %}

        <div class="drawer-footer">
          <a class="btn" href="{% url 'reports:logout' %}">تسجيل الخروج</a>
        </div>
      {% else %}
        <a class="{% if active == 'login' %}active{% endif %}" href="{% url 'reports:login' %}">تسجيل الدخول</a>
      {% endif %}
    </nav>
    {% endwith %}
  </aside>

  <main class="container page-main">
    {% if messages %}
      <div class="messages" id="messages-container">
        {% for message in messages %}
          <div class="msg {{ message.tags }}" data-autohide="true">
            <button class="msg-close" aria-label="إغلاق"><i class="fa-solid fa-xmark"></i></button>
            {{ message }}
            <div class="msg-progress"></div>
          </div>
        {% endfor %}
      </div>
    {% endif %}

    {% block content %}{% endblock %}
  </main>

  <!-- زر العودة للأعلى -->
  <button class="to-top" id="toTop" aria-label="العودة للأعلى">
    <i class="fa-solid fa-arrow-left-long" style="transform:rotate(90deg)"></i>
  </button>

  <!-- ===== نافذة الإشعار التحفيزية (تظهر تلقائياً في الرئيسية إن وُجد NAV_NOTIFICATION_HERO) ===== -->
  {% if NAV_NOTIFICATION_HERO %}
  <div class="notify-overlay" id="notifyOverlay" hidden>
    <div class="notify-card" id="notifyCard" role="dialog" aria-modal="true" aria-labelledby="notifyTitle" aria-describedby="notifyBody" data-notif-id="{{ NAV_NOTIFICATION_HERO.id }}">
      <div class="notify-head">
        <div class="notify-icon"><i class="fa-solid fa-bullhorn"></i></div>
        <div>
          <h3 class="notify-title" id="notifyTitle">{{ NAV_NOTIFICATION_HERO.title }}</h3>
          <div class="notify-sub">من: {{ NAV_NOTIFICATION_HERO.sender_name|default:"الإدارة" }}</div>
        </div>
      </div>
      <div class="notify-content" id="notifyBody">{{ NAV_NOTIFICATION_HERO.body }}</div>
      {% if NAV_NOTIFICATION_HERO.action_url %}
        <div class="notify-actions">
          <a class="btn btn-primary" href="{{ NAV_NOTIFICATION_HERO.action_url }}" rel="noopener">فتح الرابط</a>
        </div>
      {% endif %}
      <div class="notify-meta">
        <small>يمكنك إغلاق الرسالة ولن تظهر مرة أخرى تلقائيًا.</small>
      </div>
      <div class="notify-confetti" id="notifyConfetti"></div>
      <button class="btn" id="notifyClose" style="position:absolute;top:10px;left:10px" aria-label="إغلاق">إغلاق</button>
    </div>
  </div>
  {% endif %}

  <script>
    // شريط تقدّم التمرير + ظل الهيدر
    (function(){
      const bar = document.getElementById('scrollProgress');
      const header = document.getElementById('siteHeader');
      const onScroll = ()=>{
        const h = document.documentElement; const sc = h.scrollTop; const max = h.scrollHeight - h.clientHeight;
        bar.style.width = (max ? (sc/max)*100 : 0) + '%';
        header.classList.toggle('scrolled', window.scrollY > 4);
      };
      window.addEventListener('scroll', onScroll, {passive:true});
      onScroll();
    })();

    // رسائل Django (إغلاق تلقائي + زر إغلاق)
    (function(){
      const container = document.getElementById('messages-container');
      if(!container) return;
      container.querySelectorAll('.msg').forEach((el)=>{
        const closeBtn = el.querySelector('.msg-close');
        closeBtn && closeBtn.addEventListener('click', ()=> el.remove());
        if(el.dataset.autohide === 'true'){
          setTimeout(()=>{ if (el && el.parentNode){ el.remove(); } }, 3200);
        }
      });
    })();

    // دروَر الجوال (RTL: يفتح من اليمين ويُغلق بذكاء)
    (function(){
      const drawer   = document.getElementById('mobile-drawer');
      const overlay  = document.getElementById('drawerOverlay');
      const hamburger= document.getElementById('hamburger');
      const closeBtn = document.getElementById('drawerClose');
      if(!(drawer && overlay && hamburger)) return;

      const lockScroll = (on)=>{ document.documentElement.style.overflow = on ? 'hidden' : ''; };

      const open = ()=>{
        drawer.classList.add('open');
        overlay.classList.add('show'); overlay.hidden=false;
        hamburger.classList.add('active'); hamburger.setAttribute('aria-expanded','true');
        drawer.setAttribute('aria-hidden','false');
        lockScroll(true);
      };
      const close = ()=>{
        drawer.classList.remove('open');
        overlay.classList.remove('show'); overlay.hidden=true;
        hamburger.classList.remove('active'); hamburger.setAttribute('aria-expanded','false');
        drawer.setAttribute('aria-hidden','true');
        lockScroll(false);
      };

      hamburger.addEventListener('click', ()=> drawer.classList.contains('open') ? close() : open());
      closeBtn && closeBtn.addEventListener('click', close);
      overlay.addEventListener('click', (e)=>{ if(e.target === overlay) close(); });
      document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') close(); });

      // إغلاق عند تغيير المقاس إلى سطح مكتب
      matchMedia('(min-width:1025px)').addEventListener('change', (e)=>{ if(e.matches) close(); });

      // إغلاق عند الضغط على أي رابط داخل الدروَر
      drawer.addEventListener('click', (e)=>{
        const a = e.target.closest('a');
        if(a && a.href) close();
      });

      // عند الرجوع/تحديث الصفحة
      window.addEventListener('pageshow', ()=> close());
    })();

    // قائمة المستخدم
    (function(){
      const avatar = document.getElementById('userAvatar');
      const menu = document.getElementById('userMenu');
      if(!(avatar && menu)) return;
      const close = ()=>{ menu.classList.remove('open'); avatar.setAttribute('aria-expanded','false'); };
      avatar.addEventListener('click', ()=>{ const isOpen = menu.classList.toggle('open'); avatar.setAttribute('aria-expanded', isOpen ? 'true' : 'false');});
      document.addEventListener('click', (e)=>{ if(!e.target.closest('#userMenu') && !e.target.closest('#userAvatar')) close(); });
      document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') close(); });
    })();

    // زر العودة للأعلى
    (function(){
      const toTop = document.getElementById('toTop');
      if(!toTop) return;
      const toggle = ()=>{ window.scrollY > 260 ? (toTop.style.display='grid') : (toTop.style.display='none'); };
      window.addEventListener('scroll', toggle, {passive:true}); toggle();
      toTop.addEventListener('click', ()=>window.scrollTo({top:0, behavior:'smooth'}));
    })();

    // ===== نافذة الإشعار: منتصف الشاشة + إمكانية الإلتحام بالكرت =====
    (function(){
      const overlayN = document.getElementById('notifyOverlay');
      if(!overlayN) return;
      const card = document.getElementById('notifyCard');
      const confettiBox = document.getElementById('notifyConfetti');
      const id = card ? card.getAttribute('data-notif-id') : null;

      // لا نعرض إذا سبق إخفاؤه
      const dismissed = id && document.cookie.includes(`notif_dismissed_${id}=1`);
      if(dismissed){ overlayN.remove(); return; }

      const openModal = ()=>{
        overlayN.hidden = false;
        // نثر بسيط للأداء
        try{
          confettiBox.innerHTML = '';
          const n = 18;
          for(let i=0;i<n;i++){
            const piece = document.createElement('div');
            piece.className = 'piece';
            piece.style.position='absolute';
            piece.style.width='8px'; piece.style.height='12px';
            piece.style.left = (Math.random()*100)+'%';
            piece.style.top = '-10%';
            piece.style.background = `hsl(${Math.random()*360},85%,60%)`;
            piece.style.transform = `rotate(${(Math.random()*160-80)}deg)`;
            piece.style.animation = 'confettiFall 1200ms ease-out forwards';
            confettiBox.appendChild(piece);
          }
        }catch(e){}
      };

      const closeModal = ()=>{
        overlayN.hidden = true;
        if(id){
          const ex = new Date(Date.now()+1000*60*60*24*7).toUTCString();
          document.cookie = `notif_dismissed_${id}=1; path=/; expires=${ex}; SameSite=Lax`;
        }
      };

      document.getElementById('notifyClose')?.addEventListener('click', closeModal);
      overlayN.addEventListener('click', (e)=>{ if(e.target === overlayN) closeModal(); });
      document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeModal(); });

      // تموضع ملتصق بعنصر (إذا تم استدعاؤها من الهوم)
      const positionAnchored = (anchorEl)=>{
        try{
          if(!anchorEl || !card) return false;
          const r = anchorEl.getBoundingClientRect();
          const cx = r.left + r.width/2;
          const top = Math.max(r.top - 14 - card.offsetHeight, 12);
          const left = Math.min(Math.max(cx - card.offsetWidth/2, 12), window.innerWidth - card.offsetWidth - 12);
          card.classList.add('is-anchored');
          card.style.top = top+'px';
          card.style.left = left+'px';
          return true;
        }catch(e){ return false; }
      };

      // API عالمي: allow home to call window.showNotification(anchor)
      window.showNotification = (anchorEl=null)=>{
        if(!anchorEl){ card && card.classList.remove('is-anchored'); card && (card.style.left = card.style.top = ''); }
        else{
          const ok = positionAnchored(anchorEl);
          if(!ok){ card && card.classList.remove('is-anchored'); card && (card.style.left = card.style.top = ''); }
        }
        openModal();
      };

      // سياسة العرض التلقائي في الرئيسية — وسط الشاشة
      window.showNotification(null);
    })();
  </script>

  {% block scripts %}{% endblock %}
</body>
</html>
