{# templates/reports/admin_reports.html — 2025 (نسخة مُحسّنة مع شريط فلاتر أفقي) #}
{% extends "base.html" %}
{% block title %}لوحة التقارير{% endblock %}

{% block head %}
<style>
/* ========== نظام ألوان ومتغيرات ========= */
:root{
  --ink:#0f172a; --muted:#64748b; --line:#e5e7eb; --card:#fff; --bg:#f8fafc;
  --brand:#2563eb; --accent:#10b981; --danger:#ef4444; --warn:#f59e0b;
  --radius:16px; --shadow:0 14px 36px rgba(2,6,23,.10); --t:all .22s ease;
}
@media (prefers-color-scheme:dark){
  :root{ --ink:#e6ebff; --muted:#9fb0d9; --line:#1b2744; --card:#0f1629; --bg:#0b1220 }
}

/* ========== الحاوية والعناصر العامة ========= */
.admin25{max-width:1400px;margin:auto;padding:18px}
.h1{margin:0 0 6px;font-size:clamp(1.15rem,2.4vw,1.5rem);font-weight:900;color:var(--ink);letter-spacing:-.2px;display:flex;gap:10px;align-items:center}
.sub{color:var(--muted);font-weight:800}
.card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px}

/* ========== شريط الفلاتر (أفقي) ========= */
/* استبدل كتلة CSS الخاصة بشريط الفلاتر بما يلي */
.filters { display:grid; gap:12px; margin-bottom:12px; }

/* شبكة مرنة: تاريخ من / إلى / اسم المعلم / التصنيف / أزرار */
.filters-bar{
  display:grid; align-items:end; gap:10px;
  grid-template-columns:
    minmax(160px, 1fr)    /* من تاريخ */
    minmax(160px, 1fr)    /* إلى تاريخ */
    minmax(220px, 1.4fr)  /* اسم المعلم */
    minmax(160px, 0.9fr)  /* التصنيف */
    auto;                 /* الأزرار */
}
.f{ min-width:0 }           /* يمنع انكماش غريب داخل الشبكة */
.f .label{ display:block; color:var(--muted); font-weight:900; font-size:.9rem; margin:0 0 6px; }
.field{ position:relative }
.input,.select{ width:100%; padding:10px 12px; border:1px solid var(--line); border-radius:12px; background:var(--card); color:var(--ink); font:inherit; }
.has-icon{ padding-inline-start:38px }
.field i{ position:absolute; inset-inline-start:12px; top:50%; transform:translateY(-50%); opacity:.7; font-size:.95rem; }

/* الأزرار تبقى في آخر عمود وتتمدد بقدر محتواها */
.f-actions{ display:flex; gap:8px; justify-content:flex-start; }

/* تفكيك تدريجي */
@media (max-width:1200px){
  .filters-bar{ grid-template-columns: repeat(3, minmax(180px, 1fr)); }
  .f-actions{ grid-column: 1 / -1; } /* الأزرار تسقط لسطر مستقل */
}
@media (max-width:820px){
  .filters-bar{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
}
@media (max-width:520px){
  .filters-bar{ grid-template-columns: 1fr; }
}

/* ========== جدول ديسكتوب ========= */
.table-wrap{overflow:auto}
.table{width:100%;border-collapse:collapse;font-size:14px}
.table th,.table td{padding:12px;border-bottom:1px solid var(--line);text-align:right;vertical-align:top}
.table thead th{background:linear-gradient(180deg,#f8fbff,#eef5ff);font-weight:900}
.table tbody tr:hover{background:#f8fafc}
@media (prefers-color-scheme:dark){
  .table thead th{background:linear-gradient(180deg,#0f1b36,#0d1830)}
  .table tbody tr:hover{background:#0f1528}
}
.imgs{display:flex;gap:6px;flex-wrap:wrap}
.imgs img{width:48px;height:48px;object-fit:cover;border-radius:8px;border:1px solid var(--line)}

/* ========== بطاقات موبايل ========= */
.desktop-only{display:block}
.mobile-only{display:none}
@media(max-width:820px){.desktop-only{display:none}.mobile-only{display:grid;gap:12px}}
.mcard{background:var(--card);border:1px solid var(--line);border-radius:14px;box-shadow:var(--shadow);padding:12px}
.mhead{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;color:var(--muted);font-size:13px}
.midea{margin:6px 0;color:var(--ink);font-size:14px}
.mimgs{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
.mimgs img{width:72px;height:72px;object-fit:cover;border-radius:10px;border:1px solid var(--line)}
.mactions{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}

/* ========== أزرار الإجراءات ========= */
.actions-row{display:flex;gap:6px;flex-wrap:wrap}
.btn-show{background:#3b82f6;color:#fff;border-color:#3b82f6}
.btn-print{background:#10b981;color:#fff;border-color:#10b981}
.btn-del{background:#ef4444;color:#fff;border-color:#ef4444}

/* ========== بادجات التصنيف ========= */
.pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid #e2e8f0;background:#f1f5f9;color:#334155;font-weight:800;font-size:.85rem}
.tone-blue{background:#e0f2fe;color:#075985;border-color:#bae6fd}
.tone-amber{background:#fef3c7;color:#92400e;border-color:#fde68a}
.tone-red{background:#fee2e2;color:#7f1d1d;border-color:#fecaca}
.tone-violet{background:#ede9fe;color:#5b21b6;border-color:#ddd6fe}
.tone-slate{background:#e2e8f0;color:#1e293b;border-color:#cbd5e1}
.tone-green{background:#dcfce7;color:#065f46;border-color:#bbf7d0}
.tone-fuchsia{background:#fae8ff;color:#86198f;border-color:#f5d0fe}
.tone-rose{background:#ffe4e6;color:#be123c;border-color:#fecdd3}
.tone-teal{background:#ccfbf1;color:#134e4a;border-color:#99f6e4}
.tone-emerald{background:#d1fae5;color:#065f46;border-color:#a7f3d0}
.tone-orange{background:#ffedd5;color:#9a3412;border-color:#fed7aa}
.tone-gray{background:#f1f5f9;color:#334155;border-color:#e2e8f0}

/* ========== المودال (متمركز + قابل للسحب على الديسكتوب) ========= */
.modal{position:fixed;inset:0;background:rgba(2,6,23,.42);backdrop-filter:blur(2px);
       z-index:2000;opacity:0;visibility:hidden;transition:opacity .16s ease,visibility .16s ease;display:grid;place-items:center;
       padding:max(12px,env(safe-area-inset-top)) max(12px,env(safe-area-inset-right)) max(12px,env(safe-area-inset-bottom)) max(12px,env(safe-area-inset-left))}
.modal.open{opacity:1;visibility:visible}
.sheet{position:fixed; /* ليس grid ليمكن سحبه */ 
       width:clamp(320px,92vw,560px);max-height:min(84svh,640px);background:var(--card);color:var(--ink);
       border:1px solid var(--line);border-radius:14px;box-shadow:0 22px 60px rgba(2,6,23,.18);
       overflow:hidden;display:flex;flex-direction:column;transform:translate(-50%,-50%) scale(.98);transition:transform .18s ease}
.modal.open .sheet{transform:translate(-50%,-50%) scale(1)}
.head{position:sticky;top:0;background:var(--card);border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between;gap:8px;padding:10px 12px;cursor:move}
.head h2{margin:0;font-weight:900;font-size:.98rem}
.close{background:#ef4444;color:#fff;border:0;width:28px;height:28px;border-radius:999px;cursor:pointer;display:grid;place-items:center}
.body{padding:10px 12px;overflow:auto}
.idea{white-space:pre-line;margin:8px 0;font-size:14px;line-height:1.7;padding:10px;background:#f9fafb;border:1px solid var(--line);border-radius:10px}
.meta p{margin:3px 0;color:var(--muted);font-size:13px}
.gal{margin-top:10px;display:grid;grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:8px}
.gal img{width:100%;height:110px;object-fit:cover;border-radius:10px;border:1px solid var(--line);box-shadow:0 3px 10px rgba(0,0,0,.12);cursor:pointer;transition:transform .2s,box-shadow .2s}
.gal img:hover{transform:scale(1.04);box-shadow:0 6px 16px rgba(0,0,0,.18)}
@media(max-width:420px){.sheet{width:96vw;max-height:78svh}.gal{grid-template-columns:repeat(2,1fr)}}
/* إعادة تحجيم اختيارية على الديسكتوب */
@media(min-width:1024px){ .sheet{ resize:both; overflow:auto } }
</style>
{% endblock %}

{% block content %}
<div class="admin25">
  <h1 class="h1"><i class="fa-solid fa-chart-simple"></i> لوحة التقارير</h1>
  <p class="sub">إدارة وعرض جميع التقارير المقدمة من المعلمين</p>

  <div class="card">
    <!-- ===== شريط الفلاتر (أفقي) ===== -->
    <form method="get" class="filters" novalidate>
      <div class="filters-bar">
        <div class="f f-date-from">
          <label class="label">من تاريخ <i class="fa-regular fa-calendar-days" style="opacity:.7"></i></label>
          <div class="field"><i class="fa-regular fa-calendar-days"></i>
            <input class="input has-icon" type="date" name="start_date" value="{{ start_date }}">
          </div>
        </div>
        <div class="f f-date-to">
          <label class="label">إلى تاريخ <i class="fa-regular fa-calendar-days" style="opacity:.7"></i></label>
          <div class="field"><i class="fa-regular fa-calendar-days"></i>
            <input class="input has-icon" type="date" name="end_date" value="{{ end_date }}">
          </div>
        </div>
        <div class="f f-teacher">
          <label class="label">اسم المعلم <i class="fa-solid fa-user-tie" style="opacity:.7"></i></label>
          <div class="field"><i class="fa-solid fa-user"></i>
            <input class="input has-icon" type="text" name="teacher_name" value="{{ teacher_name }}" placeholder="اكتب اسم المعلم أو جزء منه">
          </div>
        </div>

        {% if categories %}
        <div class="f f-category">
          <label class="label">التصنيف <i class="fa-solid fa-tags" style="opacity:.7"></i></label>
          <div class="field"><i class="fa-solid fa-tags"></i>
            <select class="select has-icon" name="category">
              <option value="">كل التصنيفات</option>
              {% for val,label in categories %}
                <option value="{{ val }}" {% if category == val %}selected{% endif %}>{{ label }}</option>
              {% endfor %}
            </select>
          </div>
        </div>
        {% endif %}

        <div class="f f-actions">
          <button class="btn btn-primary" type="submit"><i class="fa-solid fa-check"></i> تطبيق</button>
          {% if start_date or end_date or teacher_name or category %}
            <a class="btn btn-ghost" href="{% url 'reports:admin_reports' %}"><i class="fa-solid fa-rotate-left"></i> مسح</a>
          {% endif %}
        </div>
      </div>
    </form>

    <!-- ===== جدول ديسكتوب ===== -->
    <div class="table-wrap desktop-only">
      <table class="table">
        <thead>
          <tr>
            <th>📅 التاريخ</th>
            <th>👨‍🏫 المعلم</th>
            <th>📖 العنوان</th>
            <th>🏷️ التصنيف</th>
            <th>👥 المستفيدون</th>
            <th>💡 الفكرة</th>
            <th>🖼 الصور</th>
            <th>⚙️ الإجراءات</th>
          </tr>
        </thead>
        <tbody>
          {% for r in reports %}
          <tr>
            <td>
              {{ r.report_date|date:"Y-m-d" }}<br><small class="sub" style="font-weight:800">{{ r.day_name }}</small>
            </td>
            <td>{{ r.teacher_display_name }}</td>
            <td>{{ r.title }}</td>
            <td>
              <span class="pill" data-code="{{ r.category.code|default_if_none:'' }}">
                <i class="fa-solid fa-tag"></i>{{ r.category.name|default_if_none:'-' }}
              </span>
            </td>
            <td class="text-center">{{ r.beneficiaries_count }}</td>
            <td>
              <textarea id="idea-{{ r.pk }}" style="display:none;">{{ r.idea|default_if_none:''|escape }}</textarea>
              {{ r.idea|truncatewords:12 }}
            </td>
            <td>
              <div class="imgs">
                {% if r.image1 %}<img src="{{ r.image1.url }}" alt="صورة 1" decoding="async" loading="lazy">{% endif %}
                {% if r.image2 %}<img src="{{ r.image2.url }}" alt="صورة 2" decoding="async" loading="lazy">{% endif %}
                {% if r.image3 %}<img src="{{ r.image3.url }}" alt="صورة 3" decoding="async" loading="lazy">{% endif %}
                {% if r.image4 %}<img src="{{ r.image4.url }}" alt="صورة 4" decoding="async" loading="lazy">{% endif %}
              </div>
            </td>
            <td>
              <div class="actions-row">
                <button class="btn btn-show"
                        data-idea-id="idea-{{ r.pk }}"
                        data-teacher="{{ r.teacher.name|escapejs }}"
                        data-program="{{ r.title|escapejs }}"
                        data-date="{{ r.report_date|date:'Y-m-d' }} - {{ r.day_name|default_if_none:''|escapejs }}"
                        data-category="{{ r.category.name|default_if_none:''|escapejs }}"
                        data-images="{% if r.image1 %}{{ r.image1.url }}{% endif %}|{% if r.image2 %}{{ r.image2.url }}{% endif %}|{% if r.image3 %}{{ r.image3.url }}{% endif %}|{% if r.image4 %}{{ r.image4.url }}{% endif %}">
                  <i class="fa-solid fa-eye"></i>
                </button>
                <a class="btn btn-print" href="{% url 'reports:report_print' r.pk %}" target="_blank" rel="noopener"><i class="fa-solid fa-print"></i></a>
                <form method="post" action="{% url 'reports:admin_delete_report' r.pk %}" onsubmit="return confirm('تأكيد الحذف؟')" style="display:inline">
                  {% csrf_token %}
                  <input type="hidden" name="next" value="{{ request.get_full_path }}">
                  <button class="btn btn-del" type="submit"><i class="fa-solid fa-trash"></i></button>
                </form>
              </div>
            </td>
          </tr>
          {% empty %}
          <tr><td colspan="8" style="text-align:center;color:var(--muted);padding:14px">لا توجد تقارير</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- ===== بطاقات موبايل ===== -->
    <div class="mobile-only">
      {% for r in reports %}
      <div class="mcard">
        <div class="mhead">
          <span>📅 {{ r.report_date|date:"Y-m-d" }} – {{ r.day_name }}</span>
          <span>👨‍🏫 {{ r.teacher_display_name }}</span>
        </div>
        <p>📖 {{ r.title }} •
          <span class="pill" data-code="{{ r.category.code|default_if_none:'' }}"><i class="fa-solid fa-tag"></i>{{ r.category.name|default_if_none:'-' }}</span>
          • 👥 {{ r.beneficiaries_count }}
        </p>
        <textarea id="idea-m-{{ r.pk }}" style="display:none;">{{ r.idea|default_if_none:''|escape }}</textarea>
        <p class="midea">{{ r.idea|truncatewords:22 }}</p>
        <div class="mimgs">
          {% if r.image1 %}<img src="{{ r.image1.url }}" alt="img">{% endif %}
          {% if r.image2 %}<img src="{{ r.image2.url }}" alt="img">{% endif %}
          {% if r.image3 %}<img src="{{ r.image3.url }}" alt="img">{% endif %}
          {% if r.image4 %}<img src="{{ r.image4.url }}" alt="img">{% endif %}
        </div>
        <div class="mactions">
          <button class="btn btn-show"
                  data-idea-id="idea-m-{{ r.pk }}"
                  data-teacher="{{ r.teacher.name|escapejs }}"
                  data-program="{{ r.title|escapejs }}"
                  data-date="{{ r.report_date|date:'Y-m-d' }} - {{ r.day_name|default_if_none:''|escapejs }}"
                  data-category="{{ r.category.name|default_if_none:''|escapejs }}"
                  data-images="{% if r.image1 %}{{ r.image1.url }}{% endif %}|{% if r.image2 %}{{ r.image2.url }}{% endif %}|{% if r.image3 %}{{ r.image3.url }}{% endif %}|{% if r.image4 %}{{ r.image4.url }}{% endif %}">
            👁 عرض
          </button>
          <a class="btn btn-print" href="{% url 'reports:report_print' r.pk %}" target="_blank" rel="noopener">🖨 طباعة</a>
          <form method="post" action="{% url 'reports:admin_delete_report' r.pk %}">
            {% csrf_token %}
            <input type="hidden" name="next" value="{{ request.get_full_path }}">
            <button class="btn btn-del" type="submit" onclick="return confirm('تأكيد الحذف؟')">🗑 حذف</button>
          </form>
        </div>
      </div>
      {% empty %}
      <p class="sub" style="text-align:center">لا توجد تقارير</p>
      {% endfor %}
    </div>

    <!-- ===== ترقيم ===== -->
    {% if reports.paginator.num_pages > 1 %}
    <div style="display:flex;gap:10px;align-items:center;justify-content:center;margin-top:10px">
      {% if reports.has_previous %}
        <a class="btn" href="?page={{ reports.previous_page_number }}{% if start_date %}&start_date={{ start_date }}{% endif %}{% if end_date %}&end_date={{ end_date }}{% endif %}{% if teacher_name %}&teacher_name={{ teacher_name }}{% endif %}{% if category %}&category={{ category }}{% endif %}">السابق</a>
      {% endif %}
      <span class="sub" style="font-weight:800">صفحة {{ reports.number }} من {{ reports.paginator.num_pages }}</span>
      {% if reports.has_next %}
        <a class="btn" href="?page={{ reports.next_page_number }}{% if start_date %}&start_date={{ start_date }}{% endif %}{% if end_date %}&end_date={{ end_date }}{% endif %}{% if teacher_name %}&teacher_name={{ teacher_name }}{% endif %}{% if category %}&category={{ category }}{% endif %}">التالي</a>
      {% endif %}
    </div>
    {% endif %}
  </div>
</div>

<!-- ===== المودال ===== -->
<div id="reportModal" class="modal" aria-hidden="true">
  <div class="sheet" role="dialog" aria-modal="true" aria-labelledby="reportTitle">
    <div class="head" id="dragHandle">
      <h2 id="reportTitle">💡 التقرير</h2>
      <button class="close" aria-label="إغلاق"><i class="fa-solid fa-xmark"></i></button>
    </div>
    <div class="body">
      <div id="mIdea" class="idea"></div>
      <div class="meta">
        <p>👨‍🏫 <b>المعلم:</b> <span id="mTeacher"></span></p>
        <p>📖 <b>العنوان:</b> <span id="mProgram"></span></p>
        <p>🏷️ <b>التصنيف:</b> <span id="mCategory"></span></p>
        <p>📅 <b>التاريخ:</b> <span id="mDate"></span></p>
      </div>
      <div id="mImages" class="gal"></div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
(function(){
  /* تلوين التصنيفات */
  const toneMap={activity:"blue",volunteer:"amber",affairs:"violet",admin:"red",manager:"slate",
                 sports:"green",cultural:"fuchsia",culture:"fuchsia",social:"rose",
                 scientific:"teal",science:"teal",health:"emerald",safety:"orange",
                 other:"gray",general:"gray"};
  document.querySelectorAll('.pill').forEach(el=>{
    const code=(el.dataset.code||"").trim().toLowerCase();
    el.classList.add('tone-'+(toneMap[code]||'gray'));
  });

  /* عناصر المودال */
  const modal   = document.getElementById('reportModal');
  const sheet   = modal.querySelector('.sheet');
  const closeBt = modal.querySelector('.close');
  const dragHd  = document.getElementById('dragHandle');
  const mIdea   = document.getElementById('mIdea');
  const mTeacher= document.getElementById('mTeacher');
  const mProgram= document.getElementById('mProgram');
  const mDate   = document.getElementById('mDate');
  const mCat    = document.getElementById('mCategory');
  const mImages = document.getElementById('mImages');

  /* قفل تمرير الخلفية */
  const lockScroll = (on)=>{ document.documentElement.style.overflow = on ? 'hidden' : ''; };

  /* تمركز أولي */
  function centerSheet(){
    sheet.style.left = (window.innerWidth/2) + 'px';
    sheet.style.top  = (window.innerHeight/2) + 'px';
  }

  /* فتح المودال */
  function openFrom(btn){
    const taId = btn.dataset.ideaId;
    const ta = taId ? document.getElementById(taId) : null;
    const idea = (ta ? ta.value : '').replace(/\r/g,'');
    mIdea.innerText = idea;             // آمن ضد XSS
    mTeacher.innerText = btn.dataset.teacher || '';
    mProgram.innerText = btn.dataset.program || '';
    mDate.innerText    = btn.dataset.date || '';
    mCat.innerText     = btn.dataset.category || '';
    mImages.innerHTML  = '';

    (btn.dataset.images||'').split('|').map(s=>s.trim()).filter(Boolean).forEach(url=>{
      const img=new Image(); img.src=url; img.alt='صورة التقرير';
      img.addEventListener('click',()=>{
        const o=document.createElement('div');
        o.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.85);display:flex;align-items:center;justify-content:center;z-index:3000';
        o.innerHTML=`<img src="${url}" alt="" style="max-width:90%;max-height:90%;border-radius:12px;box-shadow:0 6px 30px rgba(0,0,0,.5)">`;
        o.addEventListener("click",()=>o.remove());
        document.body.appendChild(o);
      });
      mImages.appendChild(img);
    });

    centerSheet();
    modal.classList.add('open');
    modal.setAttribute('aria-hidden','false');
    lockScroll(true);
    setTimeout(()=>closeBt.focus(),30);
  }

  /* ربط أزرار العرض */
  document.querySelectorAll('.btn-show').forEach(b=>b.addEventListener('click',()=>openFrom(b)));

  /* إغلاق */
  function close(){
    modal.classList.remove('open');
    modal.setAttribute('aria-hidden','true');
    lockScroll(false);
  }
  closeBt.addEventListener('click',close);
  modal.addEventListener('click',e=>{ if(e.target===modal) close(); });
  document.addEventListener('keydown',e=>{ if(e.key==='Escape' && modal.classList.contains('open')) close(); });

  /* سحب المودال على الديسكتوب */
  let drag=false, sx=0, sy=0, ox=0, oy=0;
  function clamp(v, min, max){ return Math.max(min, Math.min(max, v)); }
  dragHd.addEventListener('mousedown', (e)=>{
    if(window.innerWidth < 1024) return; // على الجوال لا نسحب
    drag=true; sx=e.clientX; sy=e.clientY;
    const r=sheet.getBoundingClientRect(); ox=r.left; oy=r.top;
    e.preventDefault();
  });
  window.addEventListener('mousemove',(e)=>{
    if(!drag) return;
    const nx = clamp(ox + (e.clientX - sx), 12, window.innerWidth - sheet.offsetWidth - 12);
    const ny = clamp(oy + (e.clientY - sy), 12, window.innerHeight - sheet.offsetHeight - 12);
    sheet.style.left = (nx + sheet.offsetWidth/2) + 'px';
    sheet.style.top  = (ny + sheet.offsetHeight/2) + 'px';
  });
  window.addEventListener('mouseup', ()=> drag=false);
  window.addEventListener('resize', ()=> { if(modal.classList.contains('open')) centerSheet(); });

  /* فخ التركيز (وصولية) */
  modal.addEventListener('keydown', (e)=>{
    if(e.key!=='Tab') return;
    const focusables = modal.querySelectorAll('button,[href],input,select,textarea,[tabindex]:not([tabindex="-1"])');
    if(!focusables.length) return;
    const first = focusables[0], last = focusables[focusables.length-1];
    if(e.shiftKey && document.activeElement===first){ last.focus(); e.preventDefault(); }
    else if(!e.shiftKey && document.activeElement===last){ first.focus(); e.preventDefault(); }
  });
})();
</script>
{% endblock %}
