{# templates/reports/admin_reports.html â€” 2025 (Ø­ÙˆØ§Ø± ØªÙ‚Ø±ÙŠØ± + Ø­ÙˆØ§Ø± ØµÙˆØ±) #}
{% extends "base.html" %}
{% block title %}Ù„ÙˆØ­Ø© Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±{% endblock %}

{% block head %}
<style>
:root{
  --ink:#0f172a; --muted:#64748b; --line:#e5e7eb; --card:#fff; --bg:#f8fafc;
  --brand:#2563eb; --accent:#10b981; --danger:#ef4444;
  --radius:16px; --shadow:0 14px 36px rgba(2,6,23,.10); --t:all .22s ease;
}
@media (prefers-color-scheme:dark){
  :root{ --ink:#e6ebff; --muted:#9fb0d9; --line:#1b2744; --card:#0f1629; --bg:#0b1220 }
}

/* Ø¥Ø·Ø§Ø± Ø¹Ø§Ù… */
.admin25{max-width:1400px;margin:auto;padding:18px}
.h1{margin:0 0 6px;font-size:clamp(1.15rem,2.4vw,1.5rem);font-weight:900;color:var(--ink);display:flex;gap:10px;align-items:center}
.sub{color:var(--muted);font-weight:800}
.card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px}

/* Ø´Ø±ÙŠØ· ÙÙ„Ø§ØªØ± */
.filters{display:grid;gap:12px;margin-bottom:12px}
.filters-bar{
  display:grid;align-items:end;gap:10px;
  grid-template-columns:minmax(160px,1fr) minmax(160px,1fr) minmax(220px,1.4fr) minmax(160px,.9fr) auto;
}
.f{min-width:0}
.f .label{display:block;color:var(--muted);font-weight:900;font-size:.9rem;margin:0 0 6px}
.field{position:relative}
.input,.select{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:12px;background:var(--card);color:var(--ink);font:inherit}
.has-icon{padding-inline-start:38px}
.field i{position:absolute;inset-inline-start:12px;top:50%;transform:translateY(-50%);opacity:.7;font-size:.95rem}
.f-actions{display:flex;gap:8px;flex-wrap:wrap}
@media (max-width:1200px){.filters-bar{grid-template-columns:repeat(3,minmax(180px,1fr))}.f-actions{grid-column:1/-1}}
@media (max-width:820px){.filters-bar{grid-template-columns:repeat(2,minmax(0,1fr))}}
@media (max-width:520px){.filters-bar{grid-template-columns:1fr}}

/* Ø¬Ø¯ÙˆÙ„ */
.table-wrap{overflow:auto}
.table{width:100%;border-collapse:collapse;font-size:14px}
.table th,.table td{padding:12px;border-bottom:1px solid var(--line);text-align:right;vertical-align:top}
.table thead th{background:linear-gradient(180deg,#f8fbff,#eef5ff);font-weight:900}
.table tbody tr:hover{background:#f8fafc}
@media (prefers-color-scheme:dark){
  .table thead th{background:linear-gradient(180deg,#0f1b36,#0d1830)}
  .table tbody tr:hover{background:#0f1528}
}
.imgs{display:flex;gap:6px;flex-wrap:wrap}
.imgs img{width:48px;height:48px;object-fit:cover;border-radius:8px;border:1px solid var(--line)}

/* Ø¨Ø·Ø§Ù‚Ø§Øª Ù„Ù„Ø¬ÙˆØ§Ù„ */
.desktop-only{display:block}
.mobile-only{display:none}
@media(max-width:820px){.desktop-only{display:none}.mobile-only{display:grid;gap:12px}}
.mcard{background:var(--card);border:1px solid var(--line);border-radius:14px;box-shadow:var(--shadow);padding:12px}
.mhead{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;color:var(--muted);font-size:13px}
.midea{margin:6px 0;color:var(--ink);font-size:14px}
.mimgs{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
.mimgs img{width:72px;height:72px;object-fit:cover;border-radius:10px;border:1px solid var(--line)}
.mactions{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}

/* Ø£Ø²Ø±Ø§Ø± */
.actions-row{display:flex;gap:6px;flex-wrap:wrap}
.btn{padding:8px 10px;border-radius:10px;border:1px solid var(--line);background:var(--card);cursor:pointer}
.btn-show{background:#3b82f6;color:#fff;border-color:#3b82f6}
.btn-print{background:#10b981;color:#fff;border-color:#10b981}
.btn-del{background:#ef4444;color:#fff;border-color:#ef4444}

/* ÙƒØ§Ø¨Ø³ÙˆÙ„Ø§Øª Ø§Ù„ØªØµÙ†ÙŠÙ */
.pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid #e2e8f0;background:#f1f5f9;color:#334155;font-weight:800;font-size:.85rem}
.tone-blue{background:#e0Ù2fe;color:#075985;border-color:#bae6fd}
.tone-amber{background:#fef3c7;color:#92400e;border-color:#fde68a}
.tone-red{background:#fee2e2;color:#7f1d1d;border-color:#fecaca}
.tone-violet{background:#ede9fe;color:#5b21b6;border-color:#ddd6fe}
.tone-slate{background:#e2e8f0;color:#1e293b;border-color:#cbd5e1}
.tone-green{background:#dcfce7;color:#065f46;border-color:#bbf7d0}
.tone-fuchsia{background:#fae8ff;color:#86198f;border-color:#f5d0fe}
.tone-rose{background:#ffe4e6;color:#be123c;border-color:#fecdd3}
.tone-teal{background:#ccfbf1;color:#134e4a;border-color:#99f6e4}
.tone-emerald{background:#d1fae5;color:#065f46;border-color:#a7f3d0}
.tone-orange{background:#ffedd5;color:#9a3412;border-color:#fed7aa}
.tone-gray{background:#f1f5f9;color:#334155;border-color:#e2e8f0}

/* ===== Ø­ÙˆØ§Ø± Ø§Ù„ØªÙ‚Ø±ÙŠØ± <dialog> ===== */
dialog.report-dialog{
  border:1px solid var(--line); border-radius:14px; padding:0; width:clamp(320px,92vw,620px);
  color:var(--ink); background:var(--card); box-shadow:0 24px 80px rgba(2,6,23,.25);
}
dialog.report-dialog::backdrop{ background:rgba(2,6,23,.45); backdrop-filter:blur(2px) }
.dialog-head{position:sticky;top:0;background:var(--card);border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between;gap:8px;padding:12px}
.dialog-head h2{margin:0;font-weight:900;font-size:1rem}
.dialog-close{background:#ef4444;color:#fff;border:0;width:30px;height:30px;border-radius:999px;cursor:pointer;display:grid;place-items:center}
.dialog-body{padding:12px;max-height:70svh;overflow:auto;overscroll-behavior:contain;-webkit-overflow-scrolling:touch}
.idea{white-space:pre-line;margin:8px 0;font-size:14px;line-height:1.7;padding:10px;background:#f9fafb;border:1px solid var(--line);border-radius:10px}
.meta p{margin:3px 0;color:var(--muted);font-size:13px}
.gal{margin-top:10px;display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:8px}
.gal img{width:100%;height:120px;object-fit:cover;border-radius:10px;border:1px solid var(--line);box-shadow:0 3px 10px rgba(0,0,0,.12);cursor:pointer;transition:transform .2s,box-shadow .2s}
.gal img:hover{transform:scale(1.04);box-shadow:0 6px 16px rgba(0,0,0,.18)}
@media (max-width:820px){
  dialog.report-dialog{ width:100vw; max-width:none; margin:0; border-radius:16px 16px 0 0 }
  dialog.report-dialog[open]{ inset:auto 0 0 0 } /* Bottom sheet */
  .dialog-body{ max-height:66svh }
}

/* ===== Ø­ÙˆØ§Ø± Ø§Ù„ØµÙˆØ± (Lightbox) Ø£Ø¹Ù„Ù‰ ÙƒÙ„ Ø´ÙŠØ¡ ===== */
dialog.imgbox{
  padding:0; border:0; background:transparent;
  width:auto; max-width:none;
}
dialog.imgbox[open]{ inset:0; width:100vw; height:100svh }
dialog.imgbox::backdrop{ background:rgba(0,0,0,.86) }
.imgbox figure{margin:0; width:100%; height:100%; display:flex; align-items:center; justify-content:center}
.imgbox img{max-width:94vw; max-height:94svh; border-radius:12px; box-shadow:0 8px 30px rgba(0,0,0,.6); cursor:zoom-out}
</style>
{% endblock %}

{% block content %}
<div class="admin25">
  <h1 class="h1"><i class="fa-solid fa-chart-simple"></i> Ù„ÙˆØ­Ø© Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</h1>
  <p class="sub">Ø¥Ø¯Ø§Ø±Ø© ÙˆØ¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ù‚Ø¯Ù…Ø© Ù…Ù† Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†</p>

  <div class="card">
    <!-- ===== ÙÙ„Ø§ØªØ± ===== -->
    <form method="get" class="filters" novalidate>
      <div class="filters-bar">
        <div class="f f-date-from">
          <label class="label">Ù…Ù† ØªØ§Ø±ÙŠØ® <i class="fa-regular fa-calendar-days" style="opacity:.7"></i></label>
          <div class="field"><i class="fa-regular fa-calendar-days"></i>
            <input class="input has-icon" type="date" name="start_date" value="{{ start_date }}">
          </div>
        </div>
        <div class="f f-date-to">
          <label class="label">Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ® <i class="fa-regular fa-calendar-days" style="opacity:.7"></i></label>
          <div class="field"><i class="fa-regular fa-calendar-days"></i>
            <input class="input has-icon" type="date" name="end_date" value="{{ end_date }}">
          </div>
        </div>
        <div class="f f-teacher">
          <label class="label">Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù… <i class="fa-solid fa-user-tie" style="opacity:.7"></i></label>
          <div class="field"><i class="fa-solid fa-user"></i>
            <input class="input has-icon" type="text" name="teacher_name" value="{{ teacher_name }}" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù… Ø£Ùˆ Ø¬Ø²Ø¡ Ù…Ù†Ù‡">
          </div>
        </div>

        {% if categories %}
        <div class="f f-category">
          <label class="label">Ø§Ù„ØªØµÙ†ÙŠÙ <i class="fa-solid fa-tags" style="opacity:.7"></i></label>
          <div class="field"><i class="fa-solid fa-tags"></i>
            <select class="select has-icon" name="category">
              <option value="">ÙƒÙ„ Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª</option>
              {% for val,label in categories %}
                <option value="{{ val }}" {% if category == val %}selected{% endif %}>{{ label }}</option>
              {% endfor %}
            </select>
          </div>
        </div>
        {% endif %}

        <div class="f f-actions">
          <button class="btn" style="background:var(--brand);color:#fff;border-color:var(--brand)" type="submit"><i class="fa-solid fa-check"></i> ØªØ·Ø¨ÙŠÙ‚</button>
          {% if start_date or end_date or teacher_name or category %}
            <a class="btn" style="background:#eef2ff;border-color:#e5e7eb;color:#1e40af" href="{% url 'reports:admin_reports' %}"><i class="fa-solid fa-rotate-left"></i> Ù…Ø³Ø­</a>
          {% endif %}
        </div>
      </div>
    </form>

    <!-- ===== Ø¬Ø¯ÙˆÙ„ Ø¯ÙŠØ³ÙƒØªÙˆØ¨ ===== -->
    <div class="table-wrap desktop-only">
      <table class="table">
        <thead>
          <tr>
            <th>ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
            <th>ğŸ‘¨â€ğŸ« Ø§Ù„Ù…Ø¹Ù„Ù…</th>
            <th>ğŸ“– Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th>
            <th>ğŸ·ï¸ Ø§Ù„ØªØµÙ†ÙŠÙ</th>
            <th>ğŸ‘¥ Ø§Ù„Ù…Ø³ØªÙÙŠØ¯ÙˆÙ†</th>
            <th>ğŸ’¡ Ø§Ù„ÙÙƒØ±Ø©</th>
            <th>ğŸ–¼ Ø§Ù„ØµÙˆØ±</th>
            <th>âš™ï¸ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
          </tr>
        </thead>
        <tbody>
          {% for r in reports %}
          <tr>
            <td>{{ r.report_date|date:"Y-m-d" }}<br><small class="sub" style="font-weight:800">{{ r.day_name }}</small></td>
            <td>{{ r.teacher_display_name }}</td>
            <td>{{ r.title }}</td>
            <td>
              <span class="pill" data-code="{{ r.category.code|default_if_none:'' }}"><i class="fa-solid fa-tag"></i>{{ r.category.name|default_if_none:'-' }}</span>
            </td>
            <td class="text-center">{{ r.beneficiaries_count }}</td>
            <td>
              <textarea id="idea-{{ r.pk }}" style="display:none;">{{ r.idea|default_if_none:''|escape }}</textarea>
              {{ r.idea|truncatewords:12 }}
            </td>
            <td>
              <div class="imgs">
                {% if r.image1 %}<img src="{{ r.image1.url }}" alt="ØµÙˆØ±Ø© 1" decoding="async" loading="lazy">{% endif %}
                {% if r.image2 %}<img src="{{ r.image2.url }}" alt="ØµÙˆØ±Ø© 2" decoding="async" loading="lazy">{% endif %}
                {% if r.image3 %}<img src="{{ r.image3.url }}" alt="ØµÙˆØ±Ø© 3" decoding="async" loading="lazy">{% endif %}
                {% if r.image4 %}<img src="{{ r.image4.url }}" alt="ØµÙˆØ±Ø© 4" decoding="async" loading="lazy">{% endif %}
              </div>
            </td>
            <td>
              <div class="actions-row">
                <button class="btn btn-show" type="button"
                        data-idea-id="idea-{{ r.pk }}"
                        data-teacher="{{ r.teacher.name|escapejs }}"
                        data-program="{{ r.title|escapejs }}"
                        data-date="{{ r.report_date|date:'Y-m-d' }} - {{ r.day_name|default_if_none:''|escapejs }}"
                        data-category="{{ r.category.name|default_if_none:''|escapejs }}"
                        data-images="{% if r.image1 %}{{ r.image1.url }}{% endif %}|{% if r.image2 %}{{ r.image2.url }}{% endif %}|{% if r.image3 %}{{ r.image3.url }}{% endif %}|{% if r.image4 %}{{ r.image4.url }}{% endif %}"
                        data-print-url="{% url 'reports:report_print' r.pk %}">
                  <i class="fa-solid fa-eye"></i>
                </button>
                <a class="btn btn-print" href="{% url 'reports:report_print' r.pk %}" target="_blank" rel="noopener"><i class="fa-solid fa-print"></i></a>
                <form method="post" action="{% url 'reports:admin_delete_report' r.pk %}" onsubmit="return confirm('ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°ÙØŸ')" style="display:inline">
                  {% csrf_token %}
                  <input type="hidden" name="next" value="{{ request.get_full_path }}">
                  <button class="btn btn-del" type="submit"><i class="fa-solid fa-trash"></i></button>
                </form>
              </div>
            </td>
          </tr>
          {% empty %}
          <tr><td colspan="8" style="text-align:center;color:var(--muted);padding:14px">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚Ø§Ø±ÙŠØ±</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- ===== Ø¨Ø·Ø§Ù‚Ø§Øª Ù…ÙˆØ¨Ø§ÙŠÙ„ ===== -->
    <div class="mobile-only">
      {% for r in reports %}
      <div class="mcard">
        <div class="mhead">
          <span>ğŸ“… {{ r.report_date|date:"Y-m-d" }} â€“ {{ r.day_name }}</span>
          <span>ğŸ‘¨â€ğŸ« {{ r.teacher_display_name }}</span>
        </div>
        <p>ğŸ“– {{ r.title }} â€¢
          <span class="pill" data-code="{{ r.category.code|default_if_none:'' }}"><i class="fa-solid fa-tag"></i>{{ r.category.name|default_if_none:'-' }}</span>
          â€¢ ğŸ‘¥ {{ r.beneficiaries_count }}
        </p>
        <textarea id="idea-m-{{ r.pk }}" style="display:none;">{{ r.idea|default_if_none:''|escape }}</textarea>
        <p class="midea">{{ r.idea|truncatewords:22 }}</p>
        <div class="mimgs">
          {% if r.image1 %}<img src="{{ r.image1.url }}" alt="img">{% endif %}
          {% if r.image2 %}<img src="{{ r.image2.url }}" alt="img">{% endif %}
          {% if r.image3 %}<img src="{{ r.image3.url }}" alt="img">{% endif %}
          {% if r.image4 %}<img src="{{ r.image4.url }}" alt="img">{% endif %}
        </div>
        <div class="mactions">
          <button class="btn btn-show" type="button"
                  data-idea-id="idea-m-{{ r.pk }}"
                  data-teacher="{{ r.teacher.name|escapejs }}"
                  data-program="{{ r.title|escapejs }}"
                  data-date="{{ r.report_date|date:'Y-m-d' }} - {{ r.day_name|default_if_none:''|escapejs }}"
                  data-category="{{ r.category.name|default_if_none:''|escapejs }}"
                  data-images="{% if r.image1 %}{{ r.image1.url }}{% endif %}|{% if r.image2 %}{{ r.image2.url }}{% endif %}|{% if r.image3 %}{{ r.image3.url }}{% endif %}|{% if r.image4 %}{{ r.image4.url }}{% endif %}"
                  data-print-url="{% url 'reports:report_print' r.pk %}">
            ğŸ‘ Ø¹Ø±Ø¶
          </button>
          <a class="btn btn-print" href="{% url 'reports:report_print' r.pk %}" target="_blank" rel="noopener">ğŸ–¨ Ø·Ø¨Ø§Ø¹Ø©</a>
          <form method="post" action="{% url 'reports:admin_delete_report' r.pk %}">
            {% csrf_token %}
            <input type="hidden" name="next" value="{{ request.get_full_path }}">
            <button class="btn btn-del" type="submit" onclick="return confirm('ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°ÙØŸ')">ğŸ—‘ Ø­Ø°Ù</button>
          </form>
        </div>
      </div>
      {% empty %}
      <p class="sub" style="text-align:center">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚Ø§Ø±ÙŠØ±</p>
      {% endfor %}
    </div>

    {% if reports.paginator.num_pages > 1 %}
    <div style="display:flex;gap:10px;align-items:center;justify-content:center;margin-top:10px">
      {% if reports.has_previous %}
        <a class="btn" href="?page={{ reports.previous_page_number }}{% if start_date %}&start_date={{ start_date }}{% endif %}{% if end_date %}&end_date={{ end_date }}{% endif %}{% if teacher_name %}&teacher_name={{ teacher_name }}{% endif %}{% if category %}&category={{ category }}{% endif %}">Ø§Ù„Ø³Ø§Ø¨Ù‚</a>
      {% endif %}
      <span class="sub" style="font-weight:800">ØµÙØ­Ø© {{ reports.number }} Ù…Ù† {{ reports.paginator.num_pages }}</span>
      {% if reports.has_next %}
        <a class="btn" href="?page={{ reports.next_page_number }}{% if start_date %}&start_date={{ start_date }}{% endif %}{% if end_date %}&end_date={{ end_date }}{% endif %}{% if teacher_name %}&teacher_name={{ teacher_name }}{% endif %}{% if category %}&category={{ category }}{% endif %}">Ø§Ù„ØªØ§Ù„ÙŠ</a>
      {% endif %}
    </div>
    {% endif %}
  </div>
</div>

<!-- ===== Ø­ÙˆØ§Ø± Ø§Ù„ØªÙ‚Ø±ÙŠØ± ===== -->
<dialog id="reportDialog" class="report-dialog" aria-labelledby="reportTitle" aria-describedby="reportDesc">
  <div class="dialog-head">
    <h2 id="reportTitle">ğŸ’¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</h2>
    <button class="dialog-close" type="button" aria-label="Ø¥ØºÙ„Ø§Ù‚"><i class="fa-solid fa-xmark"></i></button>
  </div>
  <div class="dialog-body" id="reportDesc">
    <div id="mIdea" class="idea"></div>
    <div class="meta">
      <p>ğŸ‘¨â€ğŸ« <b>Ø§Ù„Ù…Ø¹Ù„Ù…:</b> <span id="mTeacher"></span></p>
      <p>ğŸ“– <b>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</b> <span id="mProgram"></span></p>
      <p>ğŸ·ï¸ <b>Ø§Ù„ØªØµÙ†ÙŠÙ:</b> <span id="mCategory"></span></p>
      <p>ğŸ“… <b>Ø§Ù„ØªØ§Ø±ÙŠØ®:</b> <span id="mDate"></span></p>
    </div>
    <div id="mImages" class="gal"></div>
  </div>
</dialog>

<!-- ===== Ø­ÙˆØ§Ø± Ø§Ù„ØµÙˆØ± (Lightbox) ===== -->
<dialog id="imgDialog" class="imgbox" aria-label="ØµÙˆØ±Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±">
  <figure>
    <img id="imgDialogSrc" alt="" />
  </figure>
</dialog>
{% endblock %}

{% block scripts %}
<script>
(function(){
  /* ØªÙ„ÙˆÙŠÙ† Ø§Ù„ØªØµÙ†ÙŠÙ */
  const toneMap={activity:"blue",volunteer:"amber",affairs:"violet",admin:"red",manager:"slate",
                 sports:"green",cultural:"fuchsia",culture:"fuchsia",social:"rose",
                 scientific:"teal",science:"teal",health:"emerald",safety:"orange",
                 other:"gray",general:"gray"};
  document.querySelectorAll('.pill').forEach(el=>{
    const code=(el.dataset.code||"").trim().toLowerCase();
    el.classList.add('tone-'+(toneMap[code]||'gray'));
  });

  const dlg = document.getElementById('reportDialog');
  const closeBtn = dlg.querySelector('.dialog-close');
  const mIdea   = document.getElementById('mIdea');
  const mTeacher= document.getElementById('mTeacher');
  const mProgram= document.getElementById('mProgram');
  const mDate   = document.getElementById('mDate');
  const mCat    = document.getElementById('mCategory');
  const mImages = document.getElementById('mImages');

  const imgDlg   = document.getElementById('imgDialog');
  const imgDlgEl = document.getElementById('imgDialogSrc');

  function openImage(url){
    if('showModal' in imgDlg){
      imgDlgEl.src = url;
      imgDlg.showModal();  // ÙŠÙˆØ¶Ø¹ ÙÙŠ Top Layer ÙÙˆÙ‚ Ø­ÙˆØ§Ø± Ø§Ù„ØªÙ‚Ø±ÙŠØ±
    }else{
      window.open(url, '_blank', 'noopener');
    }
  }
  imgDlg.addEventListener('click', ()=> imgDlg.close());
  imgDlg.addEventListener('cancel', (e)=>{ e.preventDefault(); imgDlg.close(); });

  function openFrom(btn){
    const ta = document.getElementById(btn.dataset.ideaId);
    const idea = (ta ? ta.value : '').replace(/\r/g,'');
    mIdea.textContent   = idea;
    mTeacher.textContent= btn.dataset.teacher || '';
    mProgram.textContent= btn.dataset.program || '';
    mDate.textContent   = btn.dataset.date || '';
    mCat.textContent    = btn.dataset.category || '';
    mImages.innerHTML   = '';

    (btn.dataset.images||'').split('|').map(s=>s.trim()).filter(Boolean).forEach(url=>{
      const img=new Image(); img.src=url; img.alt='ØµÙˆØ±Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±';
      img.addEventListener('click', ()=> openImage(url));
      mImages.appendChild(img);
    });

    if ('showModal' in dlg){
      dlg.showModal();
      requestAnimationFrame(()=> closeBtn.focus({preventScroll:true}));
    }else{
      const url = btn.dataset.printUrl;
      if(url) window.open(url, '_blank', 'noopener');
    }
  }

  document.addEventListener('click', (e)=>{
    const b = e.target.closest('.btn-show');
    if(!b) return;
    e.preventDefault();
    openFrom(b);
  });

  closeBtn.addEventListener('click', ()=> dlg.close());
  dlg.addEventListener('click', (e)=>{ if(e.target === dlg) dlg.close(); });
  dlg.addEventListener('cancel', (e)=>{ e.preventDefault(); dlg.close(); });
})();
</script>
{% endblock %}
