{% extends "base.html" %}
{% block title %}لوحة المدير - التقارير{% endblock %}

{% block content %}
<div class="admin-container">
  <!-- العنوان -->
  <div class="admin-header">
    <h1 class="admin-title"><i class="fas fa-chart-bar"></i> جـديدة</h1>
    <p class="admin-subtitle">إدارة وعرض جميع التقارير المقدمة من المعلمين</p>
  </div>

  <div class="admin-card">
    <!-- ✅ فلاتر البحث -->
    <form method="GET" class="filters-form">
      <div class="filters-grid">
        <div class="filter-group">
          <label>📅 من تاريخ</label>
          <input type="date" name="start_date" value="{{ start_date }}" class="filter-input">
        </div>
        <div class="filter-group">
          <label>📅 إلى تاريخ</label>
          <input type="date" name="end_date" value="{{ end_date }}" class="filter-input">
        </div>
        <div class="filter-group">
          <label>👨‍🏫 اسم المعلم</label>
          <input type="text" name="teacher_name" value="{{ teacher_name }}" placeholder="اكتب اسم المعلم أو جزء منه" class="filter-input"/>
        </div>

        {% if categories %}
        <div class="filter-group">
          <label>🏷️ التصنيف</label>
          <select name="category" class="filter-input">
            <option value="">كل التصنيفات</option>
            {% for c_val, c_label in categories %}
              <option value="{{ c_val }}" {% if category == c_val %}selected{% endif %}>{{ c_label }}</option>
            {% endfor %}
          </select>
        </div>
        {% endif %}
      </div>

      <div class="filter-actions">
        <button class="btn btn-primary" type="submit"><i class="fas fa-check"></i> تطبيق الفلاتر</button>
        {% if start_date or end_date or teacher_national_id or category %}
          <a href="{% url 'reports:admin_reports' %}" class="btn btn-outline"><i class="fas fa-times"></i> مسح الفلاتر</a>
        {% endif %}
      </div>
    </form>

    <!-- ✅ جدول (ديسكتوب) -->
    <div class="table-responsive desktop-only">
      <table class="reports-table">
        <thead>
          <tr>
            <th>📅 التاريخ</th>
            <th>👨‍🏫 المعلم</th>
            <th>📖 العنوان</th>
            <th>🏷️ التصنيف</th>
            <th>👥 المستفيدون</th>
            <th>💡 الفكرة</th>
            <th>🖼 الصور</th>
            <th>⚙️ الإجراءات</th>
          </tr>
        </thead>
        <tbody>
          {% for r in reports %}
          <tr>
            <td>
              {{ r.report_date|date:"Y-m-d" }}<br>
              <small class="text-muted">{{ r.day_name }}</small>
            </td>
            <td>{{ r.teacher_display_name }}</td>
            <td>{{ r.title }}</td>

            <!-- ✅ التصنيف كبادج ملوّن -->
            <td>
              <span class="cat-pill" title="{{ r.category.name|default_if_none:'-' }}" data-code="{{ r.category.code|default_if_none:'' }}">
                <i class="fas fa-tag"></i>
                {{ r.category.name|default_if_none:'-' }}
              </span>
            </td>

            <td class="text-center">{{ r.beneficiaries_count }}</td>

            <td>
              <textarea id="idea-{{ r.pk }}" style="display:none;">{{ r.idea|default_if_none:''|escape }}</textarea>
              {{ r.idea|truncatewords:12 }}
            </td>

            <td>
              <div class="table-images">
                {% if r.image1 %}<img src="{{ r.image1.url }}" alt="صورة 1">{% endif %}
                {% if r.image2 %}<img src="{{ r.image2.url }}" alt="صورة 2">{% endif %}
                {% if r.image3 %}<img src="{{ r.image3.url }}" alt="صورة 3">{% endif %}
                {% if r.image4 %}<img src="{{ r.image4.url }}" alt="صورة 4">{% endif %}
              </div>
            </td>
            <td>
              <div class="action-buttons">
                <button class="btn btn-show-idea"
                        data-idea-id="idea-{{ r.pk }}"
                        data-teacher="{{ r.teacher.name|escapejs }}"
                        data-program="{{ r.title|escapejs }}"
                        data-date="{{ r.report_date|date:'Y-m-d' }} - {{ r.day_name|default_if_none:''|escapejs }}"
                        data-category="{{ r.category.name|default_if_none:''|escapejs }}"
                        data-images="{% if r.image1 %}{{ r.image1.url }}{% endif %}|{% if r.image2 %}{{ r.image2.url }}{% endif %}|{% if r.image3 %}{{ r.image3.url }}{% endif %}|{% if r.image4 %}{{ r.image4.url }}{% endif %}">
                  <i class="fas fa-eye"></i>
                </button>
                <a href="{% url 'reports:report_print' r.pk %}" target="_blank" class="btn btn-print"><i class="fas fa-print"></i></a>
                <form method="POST" action="{% url 'reports:admin_delete_report' r.pk %}">
                  {% csrf_token %}
                  <input type="hidden" name="next" value="{{ request.get_full_path }}">
                  <button class="btn btn-danger" type="submit" onclick="return confirm('هل أنت متأكد من الحذف؟')"><i class="fas fa-trash"></i></button>
                </form>
              </div>
            </td>
          </tr>
          {% empty %}
          <tr><td colspan="8" class="text-center">لا توجد تقارير</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- ✅ عرض كبطاقات (موبايل) -->
    <div class="cards-view mobile-only">
      {% for r in reports %}
      <div class="report-card">
        <div class="report-header">
          <span>📅 {{ r.report_date|date:"Y-m-d" }} – {{ r.day_name }}</span>
          <span>👨‍🏫 {{ r.teacher_display_name }}</span>
        </div>
        <p class="report-program">
          📖 {{ r.title }}
          • <span class="cat-pill" data-code="{{ r.category.code|default_if_none:'' }}">
              <i class="fas fa-tag"></i>{{ r.category.name|default_if_none:'-' }}
            </span>
          • 👥 {{ r.beneficiaries_count }}
        </p>

        <textarea id="idea-m-{{ r.pk }}" style="display:none;">{{ r.idea|default_if_none:''|escape }}</textarea>
        <p class="report-idea">{{ r.idea|truncatewords:20 }}</p>

        <div class="report-images">
          {% if r.image1 %}<img src="{{ r.image1.url }}" alt="img">{% endif %}
          {% if r.image2 %}<img src="{{ r.image2.url }}" alt="img">{% endif %}
          {% if r.image3 %}<img src="{{ r.image3.url }}" alt="img">{% endif %}
          {% if r.image4 %}<img src="{{ r.image4.url }}" alt="img">{% endif %}
        </div>
        <div class="card-actions">
          <button class="btn btn-show-idea"
                  data-idea-id="idea-m-{{ r.pk }}"
                  data-teacher="{{ r.teacher.name|escapejs }}"
                  data-program="{{ r.title|escapejs }}"
                  data-date="{{ r.report_date|date:'Y-m-d' }} - {{ r.day_name|default_if_none:''|escapejs }}"
                  data-category="{{ r.category.name|default_if_none:''|escapejs }}"
                  data-images="{% if r.image1 %}{{ r.image1.url }}{% endif %}|{% if r.image2 %}{{ r.image2.url }}{% endif %}|{% if r.image3 %}{{ r.image3.url }}{% endif %}|{% if r.image4 %}{{ r.image4.url }}{% endif %}">
            👁 عرض
          </button>
          <a href="{% url 'reports:report_print' r.pk %}" target="_blank" class="btn btn-print">🖨 طباعة</a>
          <form method="POST" action="{% url 'reports:admin_delete_report' r.pk %}">
            {% csrf_token %}
            <input type="hidden" name="next" value="{{ request.get_full_path }}">
            <button class="btn btn-danger" type="submit" onclick="return confirm('هل أنت متأكد من الحذف؟')">🗑 حذف</button>
          </form>
        </div>
      </div>
      {% empty %}
      <p class="text-center">لا توجد تقارير</p>
      {% endfor %}
    </div>

    <!-- ✅ ترقيم الصفحات -->
    {% if reports.paginator.num_pages > 1 %}
    <div class="pagination">
      {% if reports.has_previous %}
        <a class="page-btn" href="?page={{ reports.previous_page_number }}{% if start_date %}&start_date={{ start_date }}{% endif %}{% if end_date %}&end_date={{ end_date }}{% endif %}{% if teacher_national_id %}&teacher_national_id={{ teacher_national_id }}{% endif %}{% if category %}&category={{ category }}{% endif %}">السابق</a>
      {% endif %}
      <span class="page-current">صفحة {{ reports.number }} من {{ reports.paginator.num_pages }}</span>
      {% if reports.has_next %}
        <a class="page-btn" href="?page={{ reports.next_page_number }}{% if start_date %}&start_date={{ start_date }}{% endif %}{% if end_date %}&end_date={{ end_date }}{% endif %}{% if teacher_national_id %}&teacher_national_id={{ teacher_national_id }}{% endif %}{% if category %}&category={{ category }}{% endif %}">التالي</a>
      {% endif %}
    </div>
    {% endif %}
  </div>
</div>

<!-- ✅ المودال (Side/Bottom Sheet) -->
<div id="ideaModal" class="modern-modal" aria-hidden="true">
  <div class="modal-sheet" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <header class="sheet-head">
      <h2 id="modalTitle">💡 التقرير كامل</h2>
      <button class="sheet-close" aria-label="إغلاق"><i class="fas fa-xmark"></i></button>
    </header>

    <section class="sheet-body">
      <div id="modalIdea" class="modal-idea"></div>

      <div class="modal-meta">
        <p>👨‍🏫 <b>المعلم:</b> <span id="modalTeacher"></span></p>
        <p>📖 <b>العنوان:</b> <span id="modalProgram"></span></p>
        <p>🏷️ <b>التصنيف:</b> <span id="modalCategory"></span></p>
        <p>📅 <b>التاريخ:</b> <span id="modalDate"></span></p>
      </div>

      <div id="modalImages" class="modal-images"></div>
    </section>
  </div>
</div>

<style>
/* ============ إطار عام ============ */
.admin-container { padding:20px; max-width:1400px; margin:auto; }
.admin-title { font-size:24px; font-weight:800; display:flex; gap:8px; color:#1e293b; align-items:center }
.admin-subtitle { color:#64748b; margin-top:4px; }
.admin-card { background:#fff; border-radius:16px; box-shadow:0 4px 20px rgba(0,0,0,0.08); padding:20px; }

/* ============ الفلاتر ============ */
.filters-form { margin-bottom:20px; }
.filters-grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(220px,1fr)); gap:12px; }
.filter-input { padding:10px; border:1px solid #d1d5db; border-radius:8px; font-size:14px; }
.filter-actions { margin-top:12px; display:flex; gap:10px; flex-wrap:wrap; }

/* ============ الجدول ============ */
.reports-table { width:100%; border-collapse:collapse; font-size:14px; }
.reports-table th, .reports-table td { padding:12px; border-bottom:1px solid #e5e7eb; text-align:right }
.reports-table th { background:#f9fafb; }
.reports-table tr:hover { background:#f3f4f6; }

/* ============ الصور ============ */
.table-images img, .report-images img { width:48px; height:48px; object-fit:cover; border-radius:6px; }

/* ============ الأزرار ============ */
.btn { padding:6px 12px; border-radius:6px; font-size:13px; cursor:pointer; border:none; }
.btn-primary { background:#3b82f6; color:#fff; }
.btn-outline { background:#fff; color:#1f2937; border:1px solid #cbd5e1; }
.btn-show-idea { background:#3b82f6; color:#fff; }
.btn-print { background:#10b981; color:#fff; }
.btn-danger { background:#ef4444; color:#fff; }
.btn:hover { opacity:0.9; }
.action-buttons { display:flex; gap:6px; }

/* ============ بادج التصنيف ============ */
.cat-pill{
  display:inline-flex; align-items:center; gap:6px;
  padding:6px 10px; border-radius:999px; font-weight:800; font-size:.85rem;
  border:1px solid; background:#f1f5f9; color:#334155; border-color:#e2e8f0;
}
.tone-blue    { background:#e0f2fe; color:#075985; border-color:#bae6fd; }
.tone-amber   { background:#fef3c7; color:#92400e; border-color:#fde68a; }
.tone-red     { background:#fee2e2; color:#7f1d1d; border-color:#fecaca; }
.tone-violet  { background:#ede9fe; color:#5b21b6; border-color:#ddd6fe; }
.tone-slate   { background:#e2e8f0; color:#1e293b; border-color:#cbd5e1; }
.tone-green   { background:#dcfce7; color:#065f46; border-color:#bbf7d0; }
.tone-fuchsia { background:#fae8ff; color:#86198f; border-color:#f5d0fe; }
.tone-rose    { background:#ffe4e6; color:#be123c; border-color:#fecdd3; }
.tone-teal    { background:#ccfbf1; color:#134e4a; border-color:#99f6e4; }
.tone-emerald { background:#d1fae5; color:#065f46; border-color:#a7f3d0; }
.tone-orange  { background:#ffedd5; color:#9a3412; border-color:#fed7aa; }
.tone-gray    { background:#f1f5f9; color:#334155; border-color:#e2e8f0; }

/* ============ بطاقات الموبايل ============ */
.cards-view { display:grid; gap:15px; }
.report-card { background:#fff; padding:15px; border-radius:12px; box-shadow:0 2px 10px rgba(0,0,0,0.05); }
.report-header { display:flex; justify-content:space-between; font-size:13px; color:#334155; margin-bottom:8px; gap:10px; flex-wrap:wrap }
.report-program { font-size:13px; margin:4px 0; color:#475569; }
.report-idea { font-size:14px; margin:6px 0; color:#1e293b; }
.report-images { display:flex; gap:6px; flex-wrap:wrap; margin-top:6px; }
.card-actions { display:flex; gap:6px; margin-top:10px; flex-wrap:wrap; }

/* ============ المودال (Side/Bottom Sheet) ============ */
.modern-modal{
  position:fixed; inset:0; background:rgba(2,6,23,.55);
  z-index:2000; opacity:0; visibility:hidden; transition:opacity .22s ease, visibility .22s ease;
}
.modern-modal.open{ opacity:1; visibility:visible; }

.modal-sheet{
  position:fixed; top:0; bottom:0; inset-inline-end:0; /* يمين في RTL */
  width:min(720px, 96vw); background:#fff; border-inline-start:1px solid #e5e7eb;
  box-shadow:-24px 0 60px rgba(2,6,23,.12); transform:translateX(110%); transition:transform .28s ease;
  display:flex; flex-direction:column; border-radius:0;
}
.modern-modal.open .modal-sheet{ transform:translateX(0); }

@media (max-width: 768px){
  .modal-sheet{
    inset:auto 0 0 0; width:100%; height:90%; border-inline-start:none;
    border-top:1px solid #e5e7eb; border-top-left-radius:16px; border-top-right-radius:16px;
    transform:translateY(110%);
  }
  .modern-modal.open .modal-sheet{ transform:translateY(0); }
}

/* رأس وجسم اللوح */
.sheet-head{
  position:sticky; top:0; display:flex; align-items:center; justify-content:space-between; gap:10px;
  padding:14px 16px; border-bottom:1px solid #e5e7eb; background:#fff; z-index:1;
}
.sheet-head h2{ margin:0; font-weight:800; color:#0f172a; font-size:1.05rem }
.sheet-close{ background:#ef4444; color:#fff; border:none; width:34px; height:34px; border-radius:999px; cursor:pointer }
.sheet-close:hover{ opacity:.9 }
.sheet-body{ padding:14px 16px; overflow:auto }

/* نص التقرير داخل المودال */
.modal-idea{
  white-space:pre-line; margin:12px 0; font-size:15px; line-height:1.8; color:#1e293b;
  padding:12px; background:#f9fafb; border-radius:10px; border:1px solid #e5e7eb;
}
.modal-meta p{ margin:4px 0; font-size:14px; color:#475569; }

/* صور المودال */
.modal-images{
  margin-top:16px; display:grid; grid-template-columns:repeat(auto-fill, minmax(140px,1fr)); gap:12px;
}
.modal-images img{
  width:100%; height:140px; object-fit:cover; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.15);
  cursor:pointer; transition:transform .3s, box-shadow .3s;
}
.modal-images img:hover{ transform:scale(1.06); box-shadow:0 8px 20px rgba(0,0,0,0.25); }

/* الترقيم */
.pagination { display:flex; gap:10px; align-items:center; justify-content:center; margin-top:16px; }
.page-btn { padding:6px 12px; border:1px solid #cbd5e1; border-radius:6px; background:#fff; color:#111827; text-decoration:none; }
.page-current { color:#374151; font-size:13px; }

/* التجاوب */
.desktop-only { display:block; }
.mobile-only { display:none; }
@media (max-width: 768px){
  .desktop-only { display:none; }
  .mobile-only { display:block; }
}
</style>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const modal = document.getElementById("ideaModal");
  const sheet = modal.querySelector(".modal-sheet");
  const closeBtn = modal.querySelector(".sheet-close");

  const modalIdea = document.getElementById("modalIdea");
  const modalTeacher = document.getElementById("modalTeacher");
  const modalProgram = document.getElementById("modalProgram");
  const modalDate = document.getElementById("modalDate");
  const modalCategory = document.getElementById("modalCategory");
  const modalImages = document.getElementById("modalImages");

  // تلوين البادجات حسب كود التصنيف
  const toneMap = {
    activity:"blue", volunteer:"amber", affairs:"violet", admin:"red", manager:"slate",
    sports:"green", cultural:"fuchsia", culture:"fuchsia", social:"rose", scientific:"teal",
    science:"teal", health:"emerald", safety:"orange", other:"gray", general:"gray"
  };
  document.querySelectorAll(".cat-pill").forEach(el=>{
    const code=(el.dataset.code||"").toLowerCase().trim();
    const tone=toneMap[code]||"gray";
    el.classList.add("tone-"+tone);
  });

  function openModalFromBtn(btn){
    const ideaId = btn.dataset.ideaId;
    const ta = ideaId ? document.getElementById(ideaId) : null;
    const idea = (ta ? ta.value : "").replace(/\r/g,"");
    modalIdea.innerText = idea;                // آمن ضد XSS
    modalTeacher.innerText = btn.dataset.teacher || "";
    modalProgram.innerText = btn.dataset.program || "";
    modalDate.innerText = btn.dataset.date || "";
    modalCategory.innerText = btn.dataset.category || "";

    // الصور
    modalImages.innerHTML = "";
    (btn.dataset.images || "")
      .split("|").map(s=>s.trim()).filter(Boolean)
      .forEach(url => {
        const img = document.createElement("img");
        img.src = url;
        img.alt = "صورة التقرير";
        modalImages.appendChild(img);
      });

    modal.classList.add("open");
    modal.setAttribute("aria-hidden","false");
    // تركيز على زر الإغلاق لسهولة الخروج
    setTimeout(()=>closeBtn.focus(), 50);
  }

  // فتح من كل الأزرار
  document.querySelectorAll(".btn-show-idea").forEach(btn=>{
    btn.addEventListener("click", ()=> openModalFromBtn(btn));
  });

  // إغلاق
  const closeModal = ()=>{
    modal.classList.remove("open");
    modal.setAttribute("aria-hidden","true");
  };
  closeBtn.addEventListener("click", closeModal);

  // إغلاق بالنقر خارج اللوح
  modal.addEventListener("click", (e)=>{
    if(e.target === modal) closeModal();
  });

  // إغلاق بـ ESC
  document.addEventListener("keydown", (e)=>{
    if(e.key === "Escape" && modal.classList.contains("open")) closeModal();
  });

  // Lightbox بسيط للصورة داخل المودال
  document.addEventListener("click", function(e) {
    if (e.target.matches(".modal-images img")) {
      const img = e.target;
      const overlay = document.createElement("div");
      overlay.style.position = "fixed";
      overlay.style.inset = 0;
      overlay.style.background = "rgba(0,0,0,0.85)";
      overlay.style.display = "flex";
      overlay.style.alignItems = "center";
      overlay.style.justifyContent = "center";
      overlay.style.zIndex = 3000;
      overlay.innerHTML = `<img src="${img.src}" style="max-width:90%; max-height:90%; border-radius:12px; box-shadow:0 6px 30px rgba(0,0,0,0.5);" alt="صورة مكبرة">`;
      overlay.addEventListener("click", () => overlay.remove());
      document.body.appendChild(overlay);
    }
  });
});
</script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
{% endblock %}
