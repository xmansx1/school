{% extends "base.html" %}
{% load static %}
{% block title %}إشعاراتي{% endblock %}

{% block head %}
<style>
  /* تخطيط عام للرأس */
  .page-head{display:flex;align-items:center;justify-content:space-between;gap:12px;margin:8px 0 18px;flex-wrap:wrap}
  .page-title{margin:0;font-size:clamp(1.05rem,2.2vw,1.35rem);font-weight:900;color:var(--ink);display:flex;align-items:center;gap:10px;white-space:nowrap}
  .chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;font-weight:900;font-size:.86rem}
  .chip.badge{background:#eef2ff;border:1px solid var(--line);color:#1e40af}
  .chip.danger{background:#fff5f5;border:1px solid #ffe0e0;color:#b91c1c}
  .chip.muted{background:#f8fafc;border:1px solid var(--line);color:#475569}

  .head-actions{display:flex;gap:8px;flex-wrap:wrap}
  .btn-outline{--tap:46px;min-height:var(--tap);padding:8px 12px;border-radius:12px;border:1px solid var(--line);background:var(--card);font-weight:800;color:var(--ink);cursor:pointer}
  .btn-outline:hover{box-shadow:0 4px 14px rgba(2,6,23,.08)}
  .btn-outline:focus-visible{outline:2px solid var(--brand);outline-offset:2px;box-shadow:0 0 0 3px rgba(37,99,235,.25)}

  /* شبكة البطاقات (شبكة مرنة ومتوازنة) */
  .cards{display:grid;gap:16px}
  @media(min-width:760px){.cards{grid-template-columns:repeat(2, minmax(0,1fr))}}
  @media(min-width:1200px){.cards{grid-template-columns:repeat(3, minmax(0,1fr))}}

  /* البطاقة – نجعلها عمودية ليتثبت الشريط السفلي أسفلها */
  .n-card{
    position:relative;display:flex;flex-direction:column;gap:10px;
    background:var(--card);border:1px solid var(--line);border-radius:16px;
    padding:14px;box-shadow:var(--shadow);
    transition:transform .18s ease, box-shadow .18s ease, border-color .18s ease;
  }
  .n-card:hover{transform:translateY(-2px);box-shadow:0 14px 36px rgba(2,6,23,.12);border-color:#dfe7ff}
  .n-card.read{background:var(--line-2)}
  .n-head{display:flex;align-items:flex-start;justify-content:space-between;gap:12px}
  .n-title{margin:0;font-weight:900;color:#0b1b3a;line-height:1.5;display:flex;align-items:center;gap:8px;font-size:clamp(1rem,2vw,1.1rem)}
  .n-time{white-space:nowrap;color:#64748b;font-weight:800;font-size:.88rem}

  /* محتوى قابل للقص للحفاظ على توازن الارتفاع */
  .n-body{
    color:#334155;font-weight:700;line-height:1.9;overflow-wrap:anywhere;word-break:break-word;
    display:-webkit-box;-webkit-box-orient:vertical;
    --lines:6; -webkit-line-clamp:var(--lines); /* قصّ ذكي */
    overflow:hidden;margin:2px 0 4px;
  }
  @media(max-width:900px){ .n-body{ --lines:5 } }
  @media(max-width:600px){ .n-body{ --lines:4 } }

  /* المرسل */
  .sender{display:flex;align-items:center;gap:10px;color:#0f172a;flex-wrap:wrap}
  .avatar-dot{--c:var(--brand);width:10px;height:10px;border-radius:50%;background:var(--c);box-shadow:0 0 0 3px rgba(37,99,235,.20)}
  .read .avatar-dot{--c:#10b981;box-shadow:0 0 0 3px rgba(16,185,129,.20)}
  .sender-name{font-weight:900}
  .sender-role{color:#475569;font-weight:800;font-size:.9rem}

  /* شريط الإجراءات مثبت أسفل البطاقة */
  .n-actions{margin-top:auto;display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
  .n-actions .left{display:flex;gap:8px;flex-wrap:wrap}
  .btn-sm{--tap:40px;min-height:var(--tap);padding:8px 12px;border-radius:12px;border:1px solid var(--line);background:var(--card);font-weight:800;text-decoration:none;color:#1e293b;display:inline-flex;align-items:center;gap:8px}
  .btn-sm.primary{background:var(--brand);border-color:var(--brand);color:#fff}
  .btn-sm.ghost{background:#eef2ff;border-color:#e5e7eb;color:#1e40af}
  .btn-sm.success{background:#ecfdf5;border-color:#d1fae5;color:#065f46}
  .btn-sm:focus-visible{outline:2px solid var(--brand);outline-offset:2px}

  .time-badge{display:inline-flex;align-items:center;gap:6px;padding:8px 12px;border-radius:999px;background:#f1f5ff;border:1px solid #e5edff;color:#1e3a8a;font-weight:900}
  .status-badge{display:inline-flex;align-items:center;gap:6px;padding:8px 12px;border-radius:12px}

  .empty{padding:28px;border:1px dashed var(--line);border-radius:14px;background:var(--card);text-align:center;color:#475569;font-weight:800}

  /* ترقيم */
  .pager{display:flex;gap:10px;align-items:center;justify-content:center;margin-top:16px;flex-wrap:wrap}
  .pager a,.pager span{padding:8px 12px;border:1px solid var(--line);border-radius:12px;background:var(--card);font-weight:800;text-decoration:none;color:#1e293b}
  .pager .on{background:var(--brand-ghost);color:var(--brand);border-color:#cfe0ff}

  /* ===== المودال ===== */
  .modal-overlay{position:fixed;inset:0;z-index:140;display:none;place-items:center}
  .modal-overlay.open{display:grid}
  .modal-overlay::before{content:"";position:absolute;inset:0;background:rgba(2,6,23,.55);backdrop-filter:blur(4px)}
  .modal{position:relative;width:min(820px,94vw);max-height:88vh;overflow:auto;background:linear-gradient(180deg,#ffffff 0%, #fbfdff 100%);border:1px solid #e5edff;border-radius:20px;box-shadow:0 30px 80px rgba(2,6,23,.35);padding:18px 18px 16px;animation:popIn .22s ease both}
  .m-head{display:flex;align-items:center;gap:12px}
  .m-icon{font-size:1.6rem;width:44px;height:44px;display:grid;place-items:center;border-radius:12px;background:linear-gradient(135deg,#e9f0ff,#ffffff);border:1px solid #e7efff}
  .m-title{margin:0;font-weight:900;color:#0b1b3a;font-size:1.25rem}
  .m-meta{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
  .m-chip{display:inline-flex;align-items:center;gap:6px;background:#eef2ff;border:1px solid #e5edff;color:#1e40af;border-radius:999px;padding:6px 10px;font-weight:900}
  .m-body{margin-top:12px;color:#1f2937;font-weight:800;line-height:1.95;white-space:pre-wrap;overflow-wrap:anywhere}
  .m-actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:14px}
  .btn{padding:10px 14px;border-radius:12px;border:1px solid var(--line);background:#fff;font-weight:800;cursor:pointer}
  .btn-primary{background:var(--brand);color:#fff;border-color:var(--brand)}
  .btn-ghost{background:#eef2ff;border-color:#e5e7eb;color:#1e40af}
  .m-close{position:absolute;inset:10px 10px auto auto;width:38px;height:38px;border-radius:50%;border:0;background:#ef4444;color:#fff;cursor:pointer}

  @keyframes popIn{from{opacity:0;transform:translateY(10px) scale(.98)}to{opacity:1;transform:none}}
  @media(prefers-reduced-motion:reduce){*{animation-duration:.01ms!important;animation-iteration-count:1!important;transition-duration:.01ms!important}}
</style>
{% endblock %}

{% block content %}
<div class="container" dir="rtl">

  <header class="page-head">
    <h1 class="page-title">
      <i class="fa-solid fa-bell" aria-hidden="true"></i> إشعاراتي
      {% if NAV_NOTIFICATIONS_UNREAD|default:0 > 0 %}
        <span class="chip badge" id="unreadCount" aria-live="polite">{{ NAV_NOTIFICATIONS_UNREAD }} غير مقروءة</span>
      {% endif %}
    </h1>

    <form class="head-actions" method="post" action="{% url 'reports:notifications_mark_all_read' %}">
      {% csrf_token %}
      <button class="btn-outline" type="submit" id="markAllBtn">
        <i class="fa-solid fa-check-double" aria-hidden="true"></i> تحديد جميع الإشعارات كمقروءة
      </button>
    </form>
  </header>

  {% if page_obj and page_obj.object_list %}
    <section class="cards">
      {% for r in page_obj %}
        {% with n=r.notification %}
        <article class="n-card {% if r.is_read %}read{% endif %}">
          <div class="n-head">
            <h3 class="n-title">
              {% if n.is_important %}<span class="chip danger">هام</span>{% endif %}
              {{ n.title|default:"رسالة من الإدارة" }}
            </h3>
            <time class="n-time" datetime="{{ r.created_at|date:'c' }}">{{ r.created_at|date:"Y-m-d H:i" }}</time>
          </div>

          {% firstof n.message n.body n.content n.text n.details as body %}
          {% if body %}<div class="n-body">{{ body|linebreaksbr }}</div>{% endif %}

          <div class="sender" aria-label="المرسِل">
            <span class="avatar-dot" aria-hidden="true"></span>
            <span class="sender-name">
              {% with s=n.created_by %}{% firstof s.name s.phone s.username "الإدارة" %}{% endwith %}
            </span>
            <span class="sender-role">
              {% with s=n.created_by %}{% if s and s.role %}— {% firstof s.role.name s.role.slug %}{% endif %}{% endwith %}
            </span>
          </div>

          <div class="n-actions">
            <div class="left">
              <span class="time-badge"><i class="fa-regular fa-clock" aria-hidden="true"></i> {{ r.created_at|date:"Y-m-d H:i" }}</span>

              <button type="button"
                      class="btn-sm ghost btn-view"
                      aria-label="عرض الإشعار كاملًا"
                      data-title="{{ n.title|default:'رسالة من الإدارة'|escape }}"
                      data-body="{{ body|default_if_none:''|striptags|escape }}"
                      data-sender="{% with s=n.created_by %}{% firstof s.name|escape s.phone|escape s.username|escape 'الإدارة' %}{% endwith %}{% with s=n.created_by %}{% if s and s.role %} — {% firstof s.role.name|escape s.role.slug|escape %}{% endif %}{% endwith %}"
                      data-time="{{ r.created_at|date:'Y-m-d H:i' }}"
                      {% if n.action_url %}data-url="{{ n.action_url|escape }}"{% endif %}>
                <i class="fa-regular fa-eye" aria-hidden="true"></i> عرض
              </button>

              {% if n.action_url %}
                <a class="btn-sm primary" href="{{ n.action_url }}" rel="noopener">
                  <i class="fa-solid fa-up-right-from-square" aria-hidden="true"></i> فتح الرابط
                </a>
              {% endif %}
            </div>

            <div class="right">
              {% if r.is_read %}
                <span class="btn-sm success"><i class="fa-solid fa-circle-check" aria-hidden="true"></i> مقروء</span>
                {% if r.read_at %}
                  <span class="chip muted"><i class="fa-regular fa-clock" aria-hidden="true"></i> {{ r.read_at|date:"Y-m-d H:i" }}</span>
                {% endif %}
              {% else %}
                <form method="post" action="{% url 'reports:notification_mark_read' r.pk %}">
                  {% csrf_token %}
                  <button class="btn-sm" type="submit"><i class="fa-solid fa-check" aria-hidden="true"></i> تمت القراءة</button>
                </form>
              {% endif %}
            </div>
          </div>
        </article>
        {% endwith %}
      {% endfor %}
    </section>

    {% if page_obj.paginator.num_pages > 1 %}
      <nav class="pager" aria-label="pagination">
        {% if page_obj.has_previous %}
          <a href="?page={{ page_obj.previous_page_number }}">السابق</a>
        {% endif %}
        <span class="on">صفحة {{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</span>
        {% if page_obj.has_next %}
          <a href="?page={{ page_obj.next_page_number }}">التالي</a>
        {% endif %}
      </nav>
    {% endif %}
  {% else %}
    <div class="empty">لا توجد إشعارات حتى الآن.</div>
  {% endif %}
</div>

<!-- نافذة عرض الإشعار -->
<div class="modal-overlay" id="nModal" role="dialog" aria-modal="true" aria-labelledby="mTitle" aria-describedby="mBody">
  <div class="modal">
    <button class="m-close" id="mClose" aria-label="إغلاق">×</button>

    <div class="m-head">
      <div class="m-icon">🔔</div>
      <div>
        <h3 class="m-title" id="mTitle">عنوان الإشعار</h3>
        <div class="m-meta">
          <span class="m-chip" id="mSender">الإدارة</span>
          <span class="m-chip" id="mTime"><i class="fa-regular fa-clock"></i> —</span>
        </div>
      </div>
    </div>

    <div class="m-body" id="mBody">—</div>

    <div class="m-actions">
      <a class="btn btn-primary" id="mAction" href="#" target="_blank" rel="noopener" style="display:none">
        <i class="fa-solid fa-up-right-from-square" aria-hidden="true"></i> فتح الرابط
      </a>
      <button class="btn btn-ghost" id="mOk">إغلاق</button>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function(){
    // منع الإرسال المزدوج لزر "تحديد جميع الإشعارات كمقروءة"
    const markAll = document.getElementById('markAllBtn');
    if(markAll){ markAll.addEventListener('click', ()=>{ markAll.disabled = true; markAll.style.opacity='.7'; }); }

    // منع الإرسال المزدوج لأزرار "تمت القراءة"
    document.querySelectorAll('.n-actions form').forEach(f=>{
      f.addEventListener('submit', ()=>{
        const btn = f.querySelector('button[type="submit"]');
        if(btn){ btn.disabled = true; btn.style.opacity = '.7'; }
      });
    });

    // ===== نافذة عرض الإشعار =====
    const modal  = document.getElementById('nModal');
    const mTitle = document.getElementById('mTitle');
    const mBody  = document.getElementById('mBody');
    const mSender= document.getElementById('mSender');
    const mTime  = document.getElementById('mTime');
    const mAction= document.getElementById('mAction');
    const mClose = document.getElementById('mClose');
    const mOk    = document.getElementById('mOk');

    function openModal(data){
      mTitle.textContent  = data.title || 'إشعار';
      mSender.textContent = data.sender || 'الإدارة';
      mTime.innerHTML     = '<i class="fa-regular fa-clock" aria-hidden="true"></i> ' + (data.time || '');
      mBody.textContent   = data.body || '';

      if(data.url){ mAction.href = data.url; mAction.style.display='inline-flex'; }
      else{ mAction.style.display='none'; }

      modal.classList.add('open');
      document.body.style.overflow='hidden';
      mOk.focus();
    }
    function closeModal(){
      modal.classList.remove('open');
      document.body.style.overflow='';
    }

    document.querySelectorAll('.btn-view').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        openModal({
          title:  btn.dataset.title || '',
          body:   btn.dataset.body || '',
          sender: btn.dataset.sender || '',
          time:   btn.dataset.time || '',
          url:    btn.dataset.url || ''
        });
      });
    });

    [mClose,mOk].forEach(el=> el.addEventListener('click', closeModal));
    document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') closeModal(); });
    document.getElementById('nModal').addEventListener('click', (e)=>{ if(e.target === e.currentTarget) closeModal(); });
  });
</script>
{% endblock %}
