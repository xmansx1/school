{% extends "base.html" %}
{% block title %}طلباتي{% endblock %}

{% block head %}
<style>
  :root{
    --ink:#0f172a;--ink-soft:#1f2937;--muted:#6b7280;
    --line:#e5e7eb;--card:#ffffff;--bg:#f8fafc;
    --brand:#2563eb;--brand2:#0ea5e9;--accent:#059669;
    --danger:#ef4444;
    --shadow:0 16px 40px rgba(2,6,23,.08);
    --radius:18px; --rsm:12px;
  }

  /* كل شيء داخل req-scope لتجنّب تأثيره على الهيدر */
  .req-scope .wrap{max-width:1200px;margin:0 auto;padding:16px 12px}

  /* ===== Hero ===== */
  .req-scope .hero{
    background:linear-gradient(135deg,#1d4ed8,#0ea5e9);
    border-radius:22px;color:#fff;box-shadow:var(--shadow);
    padding:18px 20px;display:flex;align-items:center;justify-content:space-between;gap:14px
  }
  .req-scope .hero .title{margin:0;font-weight:900;font-size:1.5rem;display:flex;align-items:center;gap:10px}
  .req-scope .you-chip{
    background:rgba(255,255,255,.15);backdrop-filter:saturate(140%) blur(2px);
    border:1px solid rgba(255,255,255,.25);
    border-radius:20px;padding:10px 14px;display:flex;align-items:center;gap:10px
  }
  .req-scope .you-ava{width:36px;height:36px;border-radius:50%;background:#1e3a8a;display:grid;place-items:center}
  .req-scope .you-ava svg{width:18px;height:18px;color:#c7d2fe}
  .req-scope .you-name{font-weight:800}
  .req-scope .you-role{display:inline-block;margin-top:2px;font-size:.78rem;opacity:.9}

  /* ===== Toolbar ===== */
  .req-scope .toolbar{margin-top:14px;background:#fff;border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:12px;display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .req-scope .tb-group{display:flex;gap:10px;align-items:center}
  .req-scope .input,
  .req-scope .select,
  .req-scope .btn{border:1px solid var(--line);border-radius:12px;background:#fff;color:#0f172a;padding:10px 12px;font-size:.95rem}
  .req-scope .input{min-width:320px}
  .req-scope .btn{background:#eef2ff;color:#1e3a8a;font-weight:800;border-color:#c7d2fe}
  .req-scope .btn:hover{background:#e0e7ff}
  .req-scope .view-switch a{padding:9px 12px;border-radius:10px;border:1px solid var(--line);background:#fff;font-weight:800;color:#1e3a8a;text-decoration:none}
  .req-scope .view-switch .active{background:#2563eb;color:#fff;border-color:#2563eb}

  /* ===== Stats ===== */
  .req-scope .stats{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-top:14px}
  .req-scope .stat{background:#fff;border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow);padding:16px;display:flex;align-items:center;justify-content:space-between;gap:8px}
  .req-scope .stat .num{font-weight:900;font-size:1.4rem}
  .req-scope .stat .lbl{color:var(--muted);font-weight:700}
  .req-scope .ico{width:40px;height:40px;border-radius:12px;display:grid;place-items:center}
  .req-scope .o{background:#ecfdf5;color:#065f46}
  .req-scope .i{background:#f5f3ff;color:#5b21b6}
  .req-scope .d{background:#e0f2fe;color:#075985}
  .req-scope .r{background:#fee2e2;color:#991b1b}

  /* ===== List ===== */
  .req-scope .list{margin-top:10px;display:grid;gap:12px}
  .req-scope .ticket{background:#fff;border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow);
          padding:14px;display:grid;grid-template-columns:1fr 280px;gap:16px;position:relative;overflow:hidden}
  .req-scope .ticket::after{content:"";position:absolute;top:0;bottom:0;left:0;width:6px;background:#e5e7eb}
  .req-scope .t-head{display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:6px}
  .req-scope .tid{background:#eef2ff;color:#1e40af;border:1px solid #c7d2fe;border-radius:11px;padding:4px 10px;font-weight:800;font-size:.85rem}
  .req-scope .t-title{margin:0;font-weight:900;color:#1f2937;font-size:1.08rem}
  .req-scope .t-title a{color:inherit;text-decoration:none}
  .req-scope .t-title a:hover{color:#2563eb}

  .req-scope .meta{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .req-scope .pill{border:1px solid var(--line);border-radius:999px;background:#f8fafc;padding:8px 12px;display:inline-flex;align-items:center;gap:8px;font-size:.9rem}
  .req-scope .dot{width:8px;height:8px;border-radius:50%}
  .req-scope .da{background:#06b6d4} .req-scope .dd{background:linear-gradient(135deg,#2563eb,#10b981)} .req-scope .dt{background:#94a3b8}

  .req-scope .last-note{margin-top:10px;border:1px dashed var(--line);border-radius:12px;background:#fcfcff;padding:10px 12px;color:var(--muted)}
  .req-scope .last-note b{color:#1f2937}

  .req-scope .aside{display:flex;flex-direction:column;gap:10px;align-items:flex-start;justify-content:center}
  .req-scope .badge{--bg:#f1f5f9;--fg:#0f172a;--bd:#e2e8f0;background:var(--bg);color:var(--fg);border:1px solid var(--bd);
         padding:10px 14px;border-radius:14px;font-weight:900;display:inline-flex;align-items:center;gap:8px}
  .req-scope .b-open{--bg:#ecfdf5;--fg:#065f46;--bd:#a7f3d0}
  .req-scope .b-in{--bg:#f5f3ff;--fg:#5b21b6;--bd:#ddd6fe}
  .req-scope .b-done{--bg:#e0f2fe;--fg:#075985;--bd:#bae6fd}
  .req-scope .b-rej{--bg:#fee2e2;--fg:#991b1b;--bd:#fecaca}

  .req-scope .meter{height:6px;width:100%;border-radius:999px;background:#eef2f7;border:1px solid #e6ebf2;overflow:hidden}
  .req-scope .fill{height:100%;display:block;width:100%}
  .req-scope .m-open .fill{width:34%;background:linear-gradient(90deg,#34d399,#10b981)}
  .req-scope .m-in .fill{width:67%;background:linear-gradient(90deg,#a78bfa,#7c3aed)}
  .req-scope .m-done .fill{width:100%;background:linear-gradient(90deg,#60a5fa,#2563eb)}
  .req-scope .m-rej .fill{width:100%;background:linear-gradient(90deg,#fda4af,#ef4444)}

  .req-scope .ticket.state-open::after{background:#10b981}
  .req-scope .ticket.state-in::after{background:#7c3aed}
  .req-scope .ticket.state-done::after{background:#2563eb}
  .req-scope .ticket.state-rej::after{background:#ef4444}

  .req-scope .btn{background:#eef2ff;color:#1e3a8a;border:1px solid #c7d2fe;border-radius:12px;font-weight:800;padding:11px 16px;text-decoration:none}
  .req-scope .btn:hover{background:#e0e7ff;border-color:#b6c3ff}

  /* ===== Table ===== */
  .req-scope .table-wrap{margin-top:12px;background:#fff;border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow);overflow:auto}
  .req-scope table{width:100%;border-collapse:collapse}
  .req-scope thead th{background:#f8fafc;border-bottom:1px solid var(--line);padding:12px 10px;text-align:right;color:#0f172a;font-weight:900;white-space:nowrap}
  .req-scope td{border-bottom:1px solid var(--line);padding:11px 10px;white-space:nowrap}
  .req-scope .tbl-id{font-weight:800;color:#1e40af}
  .req-scope .tbl-title a{text-decoration:none;color:#1f2937}
  .req-scope .tbl-title a:hover{color:#2563eb}
  .req-scope .note-preview{max-width:520px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:var(--muted)}

  /* Pager */
  .req-scope .pager{display:flex;gap:8px;justify-content:center;margin-top:14px}
  .req-scope .pager a, .req-scope .pager span{background:#fff;border:1px solid var(--line);border-radius:10px;padding:8px 12px;text-decoration:none;color:#111827}
  .req-scope .pager .current{background:#eef2ff;border-color:#c7d2fe;color:#1e3a8a;font-weight:800}

  /* Responsive */
  @media (max-width: 980px){
    .req-scope .ticket{grid-template-columns:1fr;gap:12px}
    .req-scope .input{min-width:unset;width:100%}
    .req-scope .stats{grid-template-columns:repeat(2,1fr)}
  }
  @media (max-width: 560px){
    .req-scope .stats{grid-template-columns:1fr}
  }
</style>
{% endblock %}

{% block content %}
  {{ block.super }}
  <div class="req-scope">
  <div class="wrap">

    <!-- Hero -->
    <section class="hero" aria-label="رأس الصفحة">
      <h1 class="title">📦 طلباتي</h1>
      <div class="you-chip" title="مستخدم حالي">
        <div class="you-ava">
          <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5Zm0 2c-4 0-8 2-8 5v1h16v-1c0-3-4-5-8-5Z"/></svg>
        </div>
        <div>
          <div class="you-name">{{ request.user.name|default:"أنا" }}</div>
          <div class="you-role">مرسل الطلبات</div>
        </div>
      </div>
    </section>

    <!-- Toolbar -->
    <form class="toolbar" method="get" aria-label="شريط أدوات">
      <div class="tb-group">
        <input class="input" type="search" name="q" placeholder="ابحث في طلباتك…" value="{{ request.GET.q }}">
        <button class="btn" type="submit">بحث</button>
      </div>
      <div class="tb-group">
        <label for="status">الحالة:</label>
        <select id="status" class="select" name="status">
          <option value="">جميع الحالات</option>
          <option value="open" {% if request.GET.status == "open" %}selected{% endif %}>جـديدة/جديدة</option>
          <option value="in_progress" {% if request.GET.status == "in_progress" %}selected{% endif %}>قيد المعالجة</option>
          <option value="done" {% if request.GET.status == "done" %}selected{% endif %}>مكتملة</option>
          <option value="rejected" {% if request.GET.status == "rejected" %}selected{% endif %}>مرفوضة</option>
        </select>

        <label for="order">فرز حسب:</label>
        <select id="order" class="select" name="order">
          <option value="-created_at" {% if request.GET.order|default:"-created_at" == "-created_at" %}selected{% endif %}>الأحدث</option>
          <option value="created_at" {% if request.GET.order == "created_at" %}selected{% endif %}>الأقدم</option>
          <option value="-id" {% if request.GET.order == "-id" %}selected{% endif %}>رقم الطلب (تنازلي)</option>
          <option value="id" {% if request.GET.order == "id" %}selected{% endif %}>رقم الطلب (تصاعدي)</option>
        </select>
      </div>

      <div class="tb-group view-switch" style="margin-inline-start:auto">
        {% with bq=request.GET.q|urlencode bs=request.GET.status bo=request.GET.order %}
          <a href="?{% if bq %}q={{ bq }}&{% endif %}{% if bs %}status={{ bs }}&{% endif %}{% if bo %}order={{ bo }}&{% endif %}view=list"
             class="{% if view_mode != 'table' %}active{% endif %}" aria-current="{% if view_mode != 'table' %}page{% endif %}">قائمة ▤</a>
          <a href="?{% if bq %}q={{ bq }}&{% endif %}{% if bs %}status={{ bs }}&{% endif %}{% if bo %}order={{ bo }}&{% endif %}view=table"
             class="{% if view_mode == 'table' %}active{% endif %}" aria-current="{% if view_mode == 'table' %}page{% endif %}">جدول ▦</a>
        {% endwith %}
      </div>
    </form>

    <!-- Stats -->
    <section class="stats" aria-label="إحصاءات الطلبات">
      <div class="stat"><div><div class="num">{{ stats.open|default:0 }}</div><div class="lbl">جـديدة</div></div><div class="ico o">✔</div></div>
      <div class="stat"><div><div class="num">{{ stats.in_progress|default:0 }}</div><div class="lbl">قيد المعالجة</div></div><div class="ico i">≡</div></div>
      <div class="stat"><div><div class="num">{{ stats.done|default:0 }}</div><div class="lbl">مكتملة</div></div><div class="ico d">✓</div></div>
      <div class="stat"><div><div class="num">{{ stats.rejected|default:0 }}</div><div class="lbl">مرفوضة</div></div><div class="ico r">!</div></div>
    </section>

    {% if view_mode == "table" %}
      <section class="table-wrap" aria-label="جدول طلباتي">
        <table class="req-table">
          <thead>
            <tr>
              <th>#</th>
              <th>التاريخ</th>
              <th>القسم</th>
              <th>المستلم</th>
              <th>العنوان</th>
              <th>الحالة</th>
              <th>آخر إجراء</th>
            </tr>
          </thead>
          <tbody>
            {% for t in tickets %}
            <tr>
              <td class="tbl-id">#{{ t.pk }}</td>
              <td>{{ t.created_at|date:"Y-m-d H:i" }}</td>
              <td>{{ t.get_department_display|default:t.department|default:"—" }}</td>
              <td>{% firstof t.assignee.name t.assignee "—" %}</td>
              <td class="tbl-title"><a href="{% url 'reports:ticket_detail' t.pk %}">عرض التفاصيل / إضافة ملاحظة</a></td>
              <td>
                <span class="badge
                  {% if t.status in 'open,new' %}b-open
                  {% elif t.status == 'in_progress' or t.status == 'pending' %}b-in
                  {% elif t.status == 'done' %}b-done
                  {% else %}b-rej{% endif %}">
                  {{ t.get_status_display|default:t.status }}
                </span>
              </td>
              <td style="min-width:260px;max-width:560px;">
                {% if t.pub_notes %}
                  {% with n=t.pub_notes.0 %}
                    {% if n %}
                      <div class="note-preview"><b>{{ n.author.name|default:"—" }}</b> • {{ n.created_at|date:"Y-m-d H:i" }} — {{ n.body|default:"—"|truncatechars:100 }}</div>
                    {% else %}—{% endif %}
                  {% endwith %}
                {% else %}—{% endif %}
              </td>
            </tr>
            {% empty %}
              <tr><td colspan="7" style="text-align:center;color:var(--muted)">لا توجد طلبات</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </section>
    {% else %}
      <section class="list" aria-label="قائمة طلباتي">
        {% for t in tickets %}
        <article class="ticket
          {% if t.status == 'open' or t.status == 'new' %}state-open
          {% elif t.status == 'in_progress' or t.status == 'pending' %}state-in
          {% elif t.status == 'done' %}state-done
          {% else %}state-rej{% endif %}">
          <div>
            <div class="t-head">
              <span class="tid">#{{ t.pk }}</span>
              <h3 class="t-title"><a href="{% url 'reports:ticket_detail' t.pk %}">{{ t.title|default:"طلب بدون عنوان" }}</a></h3>
            </div>

            <div class="meta">
              <span class="pill"><span class="dot dd"></span> القسم: {{ t.get_department_display|default:t.department|default:"—" }}</span>
              <span class="pill"><span class="dot da"></span> المستلم: {% if t.assignee and t.assignee.name %}{{ t.assignee.name }}{% else %}—{% endif %}</span>
              <span class="pill"><span class="dot dt"></span> {{ t.created_at|default_if_none:"—"|date:"Y-m-d H:i" }}</span>
            </div>

            {% if t.pub_notes %}
              {% with n=t.pub_notes.0 %}
                {% if n %}
                <div class="last-note">
                  <b>آخر إجراء:</b>
                  {{ n.author.name|default:"—" }} • {{ n.created_at|date:"Y-m-d H:i" }} —
                  {{ n.body|default:"—"|truncatechars:120 }}
                </div>
                {% endif %}
              {% endwith %}
            {% endif %}
          </div>

          <aside class="aside">
            <span class="badge
              {% if t.status == 'open' or t.status == 'new' %}b-open
              {% elif t.status == 'in_progress' or t.status == 'pending' %}b-in
              {% elif t.status == 'done' %}b-done
              {% else %}b-rej{% endif %}">
              {{ t.get_status_display|default:t.status }}
            </span>

            <div class="meter
              {% if t.status == 'open' or t.status == 'new' %}m-open
              {% elif t.status == 'in_progress' or t.status == 'pending' %}m-in
              {% elif t.status == 'done' %}m-done
              {% else %}m-rej{% endif %}">
              <span class="fill"></span>
            </div>

            <a class="btn" href="{% url 'reports:ticket_detail' t.pk %}">عرض التفاصيل / إضافة ملاحظة ←</a>
          </aside>
        </article>
        {% empty %}
          <div class="btn" style="background:#fff;color:var(--muted);border:1px dashed var(--line)">لا توجد طلبات حالياً</div>
        {% endfor %}
      </section>
    {% endif %}

    <!-- Pager -->
    {% if tickets.paginator and tickets.paginator.num_pages > 1 %}
    <nav class="pager" aria-label="ترقيم الصفحات">
      {% with bq=request.GET.q|urlencode bs=request.GET.status bo=request.GET.order %}
        {% if tickets.has_previous %}
          <a href="?{% if bq %}q={{ bq }}&{% endif %}{% if bs %}status={{ bs }}&{% endif %}{% if bo %}order={{ bo }}&{% endif %}view={{ view_mode }}&page={{ tickets.previous_page_number }}">السابق</a>
        {% endif %}
        <span class="current">صفحة {{ tickets.number }} من {{ tickets.paginator.num_pages }}</span>
        {% if tickets.has_next %}
          <a href="?{% if bq %}q={{ bq }}&{% endif %}{% if bs %}status={{ bs }}&{% endif %}{% if bo %}order={{ bo }}&{% endif %}view={{ view_mode }}&page={{ tickets.next_page_number }}">التالي</a>
        {% endif %}
      {% endwith %}
    </nav>
    {% endif %}

  </div>
  </div>
{% endblock %}
