{% extends "base.html" %}
{% load static %}
{% block title %}لوحة المعلم{% endblock %}

{% block head %}
<style>
  :root{
    --ink:#0f172a; --ink-soft:#1f2937; --muted:#64748b; --line:#e5e7eb;
    --brand:#1e3a8a; --brand-2:#1e40af; --accent:#0b7d62;
    --card:#ffffff; --bg:#f8fafc; --shadow:0 6px 20px rgba(2,6,23,.08); --radius:22px; --t:all .22s ease;
  }
  @media (prefers-color-scheme: dark) {
    :root{
      --ink:#e5e7eb; --ink-soft:#f8fafc; --muted:#cbd5e1; --line:#334155;
      --brand:#93c5fd; --brand-2:#60a5fa; --accent:#34d399;
      --card:#0b1220; --bg:#0a0f1c; --shadow:0 6px 20px rgba(0,0,0,.35);
    }
  }
  *{box-sizing:border-box}
  .container{max-width:1200px;margin:0 auto;padding:18px}

  /* HERO (رسمي وبسيط) */
  .hero{
    background:
      radial-gradient(900px 220px at 100% 0, rgba(99,102,241,.06), transparent 60%),
      linear-gradient(180deg,#fff, #f5f7fb);
    border:1px solid var(--line); border-radius:20px; padding:22px; box-shadow:var(--shadow);
  }
  .hello{font-size:1.6rem; font-weight:900; color:var(--brand)}
  .sub{color:var(--muted); font-weight:700}

  /* GRID */
  .grid{display:grid; gap:22px; margin-top:18px}
  @media(min-width:1024px){ .grid{ grid-template-columns:1.1fr .9fr } }

  /* بطاقات مؤشرات */
  .kpis{display:grid; gap:14px}
  @media(min-width:640px){ .kpis{ grid-template-columns:repeat(3,1fr) } }
  .kpi{background:var(--card); border:1px solid var(--line); border-radius:var(--radius); padding:18px; text-align:center; box-shadow:var(--shadow)}
  .kpi .num{font-size:1.9rem; font-weight:900; color:var(--brand-2)}
  .kpi .lbl{color:var(--ink-soft); font-weight:900; margin-top:6px}
  .kpi .hint{color:var(--muted); font-size:.9rem}

  /* إجراءات سريعة */
  .actions{display:grid; gap:14px; margin-top:16px}
  @media(min-width:640px){ .actions{ grid-template-columns:repeat(2,1fr) } }
  .tile{display:flex; gap:14px; align-items:center; background:var(--card); border:1px solid var(--line); border-radius:16px; padding:16px; text-decoration:none; color:var(--ink); box-shadow:var(--shadow); transition:var(--t)}
  .tile:hover{transform:translateY(-4px)}
  .ico{ width:48px; height:48px; border-radius:12px; display:grid; place-items:center; color:#fff; font-size:1.25rem }
  .ico.plus{ background:linear-gradient(135deg, #0ea5e9, #2563eb) }
  .ico.list{ background:linear-gradient(135deg, #6366f1, #3b82f6) }
  .ico.req{ background:linear-gradient(135deg, #10b981, #34d399) }
  .ico.myreq{ background:linear-gradient(135deg, #1e40af, #3b82f6) }
  .ico.mgr{ background:linear-gradient(135deg, #7c3aed, #8b5cf6) }
  .tile-title{ font-weight:900; color:var(--ink-soft) }
  .tile-desc{ color:var(--muted); font-size:.92rem }

  /* بطاقات القوائم */
  .card{ background:var(--card); border:1px solid var(--line); border-radius:16px; box-shadow:var(--shadow) }
  .card-hd{ padding:16px 18px; border-bottom:1px solid var(--line); display:flex; align-items:center; justify-content:space-between; gap:12px }
  .card-title{ margin:0; font-size:1.05rem; font-weight:900; color:var(--ink-soft) }
  .list{ display:grid; gap:10px; padding:16px }
  .item{ display:grid; grid-template-columns:1fr auto; gap:12px; border:1px solid var(--line); border-radius:14px; padding:12px; background:var(--card); transition:var(--t) }
  .item:hover{ border-color:#c7d2fe; box-shadow:0 10px 24px rgba(30,58,138,.08) }
  .name{ font-weight:900; color:var(--ink-soft); line-height:1.3 }
  .meta{ color:var(--muted); font-size:.92rem }
  .btns{ display:flex; gap:8px; align-items:center }
  .chip-id{ background:#eff6ff; color:#1e40af; padding:6px 10px; border-radius:999px; font-weight:800; font-size:.85rem }
  .btn-xs{ padding:8px 11px; border-radius:10px; background:#eef2ff; color:#1e3a8a; font-weight:800; text-decoration:none; line-height:1 }
  .btn-xs:hover{ background:#e0e7ff }

  /* حالات الطلب */
  .status{ padding:6px 12px; border-radius:999px; font-weight:900; font-size:.85rem; display:inline-flex; align-items:center; gap:8px }
  .dot{ width:8px; height:8px; border-radius:50% }
  .s-new{ background:#dcfce7; color:#166534 } .s-new .dot{ background:#16a34a }
  .s-in{ background:#ede9fe; color:#5b21b6 } .s-in .dot{ background:#7c3aed }
  .s-done{ background:#e0f2fe; color:#075985 } .s-done .dot{ background:#0ea5e9 }
  .s-rej{ background:#fee2e2; color:#991b1b } .s-rej .dot{ background:#ef4444 }

  .empty{display:flex; gap:10px; align-items:center; color:var(--muted)}
  .btn-ghost{padding:8px 12px; border-radius:10px; border:1px solid var(--line); background:var(--card); color:var(--ink); font-weight:800; text-decoration:none}
  .btn-ghost:hover{background:#f3f4f6}

  /* A11y */
  .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
</style>
{% endblock %}

{% block content %}
<div class="container">

  <!-- HERO رسمي -->
  <section class="hero" role="region" aria-label="مقدمة">
    <div>
      {% if request.user.is_authenticated %}
        <div class="hello">مرحباً {{ request.user.name|default:"مستخدم" }} 👋</div>
      {% else %}
        <div class="hello">مرحباً ضيف 👋</div>
      {% endif %}
      <div class="sub">التاريخ: {% now "Y-m-d" %}</div>
    </div>
  </section>

  <!-- الشبكة الرئيسية -->
  <section class="grid" aria-label="لوحة المعلومات">
    <div>

      <!-- إجراءات سريعة (بدون بطاقات المدير هنا) -->
      <nav class="actions" aria-label="إجراءات سريعة">
        <a class="tile" href="{% url 'reports:add_report' %}">
          <span class="ico plus" aria-hidden="true">＋</span>
          <div>
            <div class="tile-title">إضافة تقرير جديد</div>
            <div class="tile-desc">سجّل التفاصيل والصور بسهولة</div>
          </div>
        </a>

        <a class="tile" href="{% url 'reports:my_reports' %}">
          <span class="ico list" aria-hidden="true">📋</span>
          <div>
            <div class="tile-title">عرض تقاريري</div>
            <div class="tile-desc">فلترة حسب التاريخ واستعراض الصور</div>
          </div>
        </a>

        <a class="tile" href="{% url 'reports:request_create' %}">
          <span class="ico req" aria-hidden="true">📝</span>
          <div>
            <div class="tile-title">إرسال طلب جديد</div>
            <div class="tile-desc">اختر القسم والمستلم وتابع الحالة</div>
          </div>
        </a>

        <a class="tile" href="{% url 'reports:my_requests' %}">
          <span class="ico myreq" aria-hidden="true">📦</span>
          <div>
            <div class="tile-title">عرض طلباتي</div>
            <div class="tile-desc">اطّلع على الحالات والتعليقات</div>
          </div>
        </a>

        {# بطاقة واحدة للمدير فقط، تنقل إلى لوحة المدير #}
        {% url 'reports:manager_dashboard' as manager_url %}
        {% url 'reports:admin_reports' as fallback_admin %}
        {% if request.user.is_superuser or request.user.role == 'manager' %}
          {% if manager_url %}
          <a class="tile" href="{{ manager_url }}">
            <span class="ico mgr" aria-hidden="true">🛡️</span>
            <div>
              <div class="tile-title">لوحة تحكم المدير</div>
              <div class="tile-desc">كل كروت الإدارة والتقارير في صفحة واحدة</div>
            </div>
          </a>
          {% elif fallback_admin %}
          <a class="tile" href="{{ fallback_admin }}">
            <span class="ico mgr" aria-hidden="true">🛡️</span>
            <div>
              <div class="tile-title">لوحة تحكم المدير</div>
              <div class="tile-desc">إدارة التقارير والطلبات</div>
            </div>
          </a>
          {% endif %}
        {% endif %}
      </nav>
    </div>

    <!-- أحدث عنصرين: تقارير + طلبات -->
    <aside class="card" aria-label="أحدث العناصر">
      <!-- آخر تقاريري (آخر 2 فقط) -->
      <div class="card-hd">
        <h3 class="card-title">🕘 آخر تقاريري</h3>
        <a class="btn-ghost" href="{% url 'reports:my_reports' %}">عرض الكل</a>
      </div>
      <div class="list">
        {% for r in recent_reports|slice:":2" %}
          <div class="item">
            <div>
              <div class="name">{{ r.title|default:"بدون عنوان" }}</div>
              <div class="meta">
                التاريخ: {{ r.report_date|date:"Y-m-d"|default:"—" }}
                {% if r.day_name %} • {{ r.day_name }}{% endif %}
                • المستفيدون: {{ r.beneficiaries_count|default:"0" }}
              </div>
            </div>
            <div class="btns">
              <span class="chip-id" title="رقم التقرير">#{{ r.pk }}</span>
              <a class="btn-xs" href="{% url 'reports:report_print' r.pk %}" target="_blank" rel="noopener">🖨️ طباعة</a>
            </div>
          </div>
        {% empty %}
          <div class="item"><div class="empty">لا توجد تقارير حتى الآن.</div></div>
        {% endfor %}
      </div>

      <!-- آخر طلباتي (آخر 2 فقط) -->
      <div class="card-hd">
        <h3 class="card-title">📦 آخر طلباتي</h3>
        <a class="btn-ghost" href="{% url 'reports:my_requests' %}">عرض الكل</a>
      </div>
      <div class="list">
        {% for t in recent_tickets|slice:":2" %}
          <div class="item">
            <div>
              <div class="name">{{ t.title|default:"طلب بدون عنوان" }}</div>
              <div class="meta">
                القسم: {{ t.get_department_display|default:t.department }} •
                المستلم: {% firstof t.assignee.name "—" %} •
                بتاريخ: {{ t.created_at|date:"Y-m-d H:i" }}
              </div>
            </div>
            <div class="btns">
              <span class="status
                {% if t.status in 'new,open' %}s-new{% elif t.status in 'in_progress,pending' %}s-in
                {% elif t.status == 'done' %}s-done{% else %}s-rej{% endif %}">
                <span class="dot" aria-hidden="true"></span>
                {{ t.get_status_display|default:t.status }}
              </span>
            </div>
          </div>
        {% empty %}
          <div class="item"><div class="empty">لا توجد طلبات حتى الآن.</div></div>
        {% endfor %}
      </div>
    </aside>
  </section>

</div>
{% endblock %}
