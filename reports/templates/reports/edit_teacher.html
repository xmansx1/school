{% extends "base.html" %}
{% block title %}تعديل بيانات المعلم{% endblock %}

{% block head %}
<style>
  :root{
    --ink:#0f172a;--muted:#6b7280;--line:#e5e7eb;--line2:#f1f5f9;--card:#fff;
    --brand:#2563eb;--brand2:#3b82f6;--danger:#b91c1c;--ok:#065f46;
    --radius:16px;--shadow:0 8px 24px rgba(2,6,23,.06);--ring:0 0 0 3px rgba(37,99,235,.25);--tap:48px;
  }
  @media (prefers-color-scheme:dark){
    :root{--ink:#e6ebff;--muted:#a9b8de;--line:#1b2744;--line2:#142246;--card:#0f1629}
  }

  .wrap{max-width:880px;margin:0 auto;padding:clamp(8px,2.5vw,16px)}
  .teacher-card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}
  .card-header{background:linear-gradient(135deg,#ffc107,#ff9800);color:#1f2937;padding:clamp(18px,2.2vw,26px) clamp(18px,3vw,30px);text-align:center}
  .title{margin:0 0 6px;font-weight:900;font-size:clamp(1.3rem,2.4vw,1.8rem);display:flex;gap:10px;align-items:center;justify-content:center}
  .subtitle{margin:0;opacity:.95;font-weight:700}

  .teacher-form{padding:clamp(16px,3vw,26px)}
  .form-grid{display:grid;grid-template-columns:repeat(2,minmax(240px,1fr));gap:16px}
  @media(max-width:820px){.form-grid{grid-template-columns:1fr}}

  .form-group{display:block}
  .form-group label{display:flex;align-items:center;gap:8px;margin-bottom:8px;font-weight:800;color:var(--ink)}
  .icon{color:#2563eb}

  /* عناصر الإدخال (تنطبق سواء لديها class=ctrl أو لا) */
  .ctrl,
  .teacher-form input:not([type="checkbox"]),
  .teacher-form select,
  .teacher-form textarea{
    width:100%;min-height:var(--tap);padding:12px 14px;border:1px solid var(--line);border-radius:12px;
    background:#f8fafc;font-size:1rem;transition:box-shadow .18s ease,border-color .18s ease
  }
  .ctrl:focus,
  .teacher-form input:not([type="checkbox"]):focus,
  .teacher-form select:focus,
  .teacher-form textarea:focus{outline:none;border-color:var(--brand);box-shadow:var(--ring)}
  @media(prefers-color-scheme:dark){
    .ctrl,
    .teacher-form input:not([type="checkbox"]),
    .teacher-form select,
    .teacher-form textarea{background:#0e1b35}
  }

  .field-error{color:var(--danger);font-size:.9rem;margin-top:6px}
  .form-hint{color:var(--muted);font-size:.85rem;margin-top:6px}

  /* كلمة المرور */
  .password-container{position:relative;display:flex;align-items:center}
  .password-container .ctrl,
  .password-container input{padding-right:44px}
  .toggle-password{position:absolute;inset:0 10px 0 auto;width:36px;height:36px;margin:auto;border:0;border-radius:10px;background:transparent;color:#64748b;cursor:pointer}
  .toggle-password:focus-visible{outline:2px solid var(--brand);outline-offset:2px}

  /* سويتش نشط */
  .switch-container{display:flex;align-items:center;margin-top:10px}
  .switch{position:relative;display:inline-block;width:54px;height:30px;margin-left:10px}
  .switch input{opacity:0;width:0;height:0}
  .slider{position:absolute;cursor:pointer;inset:0;background:#cbd5e1;border-radius:999px;transition:.25s}
  .slider:before{content:"";position:absolute;height:22px;width:22px;left:4px;top:4px;background:#fff;border-radius:50%;transition:.25s}
  input:checked + .slider{background:var(--brand)}
  input:checked + .slider:before{transform:translateX(24px)}
  .switch-label{flex:1}
  .switch-label .form-hint{margin-top:4px}

  /* select */
  .select-wrapper{position:relative}
  .select-wrapper select,
  .select-wrapper .ctrl{appearance:none;padding-left:42px}
  .select-arrow{position:absolute;top:50%;left:12px;transform:translateY(-50%);pointer-events:none;color:#64748b}

  /* أزرار */
  .form-actions{display:flex;gap:12px;justify-content:center;margin-top:18px;padding-top:16px;border-top:1px solid var(--line)}
  .btn{display:inline-flex;align-items:center;gap:10px;justify-content:center;min-height:var(--tap);padding:10px 16px;border-radius:12px;border:1px solid var(--line);background:var(--card);font-weight:800;cursor:pointer;text-decoration:none}
  .btn-primary{background:#2563eb;border-color:#2563eb;color:#fff}
  .btn-outline{background:var(--card)}
  .btn:hover{transform:translateY(-1px)}
  .btn:focus-visible{outline:2px solid var(--brand);outline-offset:2px}

  /* التنبيهات */
  .alert{padding:12px 14px;border-radius:12px;margin-bottom:10px;border:1px solid var(--line);background:#f8fbff;color:#0b1b3a}
  .alert.success{background:#ecfdf5;color:#065f46}
  .alert.error{background:#fef2f2;color:#991b1b}
  .alert.warning{background:#fffbeb;color:#92400e}
  .alert.info{background:#eff6ff;color:#1e40af}

  /* استجابة إضافية */
  @media(max-width:560px){
    .teacher-form{padding:16px}
    .form-actions{flex-direction:column}
  }
</style>
{% endblock %}

{% block content %}
<div class="wrap" dir="rtl">
  <div class="teacher-card">
    <div class="card-header">
      <h2 class="title"><i class="fas fa-user-edit" aria-hidden="true"></i> تعديل بيانات المعلم</h2>
      <p class="subtitle">
        قم بتعديل البيانات الخاصة بالمعلم
        {% if teacher %}{{ teacher.name }}{% else %}{{ form.initial.name }}{% endif %}
      </p>
    </div>

    <form method="POST" class="teacher-form" novalidate>
      {% csrf_token %}

      {% if messages %}
        <div id="flash">
          {% for m in messages %}
            <div class="alert {{ m.tags }}">{{ m }}</div>
          {% endfor %}
        </div>
        <script>setTimeout(()=>{ const f=document.getElementById('flash'); if(f) f.remove(); }, 3000);</script>
      {% endif %}

      {% if form.non_field_errors %}
        <div class="alert error" role="alert">
          {% for e in form.non_field_errors %}{{ e }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
        </div>
      {% endif %}

      <div class="form-grid">
        <div class="form-group">
          <label for="{{ form.name.id_for_label }}"><i class="fas fa-user icon" aria-hidden="true"></i> اسم المعلم</label>
          {{ form.name }}
          {% for e in form.name.errors %}<div class="field-error">{{ e }}</div>{% endfor %}
          <div class="form-hint">الاسم الكامل للمعلم</div>
        </div>

        <div class="form-group">
          <label for="{{ form.national_id.id_for_label }}"><i class="fas fa-id-card icon" aria-hidden="true"></i> رقم الهوية</label>
          {{ form.national_id }}
          {% for e in form.national_id.errors %}<div class="field-error">{{ e }}</div>{% endfor %}
          <div class="form-hint">رقم الهوية الوطنية مكوّن من 10 أرقام (اختياري)</div>
        </div>

        <div class="form-group">
          <label for="{{ form.phone.id_for_label }}"><i class="fas fa-phone icon" aria-hidden="true"></i> رقم الجوال</label>
          {{ form.phone }}
          {% for e in form.phone.errors %}<div class="field-error">{{ e }}</div>{% endfor %}
          <div class="form-hint">يبدأ بـ 05 ويحتوي على 10 أرقام</div>
        </div>

        <div class="form-group">
          <label for="{{ form.password.id_for_label }}"><i class="fas fa-key icon" aria-hidden="true"></i> كلمة المرور</label>
          <div class="password-container">
            {{ form.password }}
            <button type="button" class="toggle-password" id="togglePassword" aria-label="إظهار/إخفاء كلمة المرور">
              <i class="fas fa-eye" aria-hidden="true"></i>
            </button>
          </div>
          {% for e in form.password.errors %}<div class="field-error">{{ e }}</div>{% endfor %}
          <div class="form-hint">اترك الحقل فارغًا للحفاظ على كلمة المرور الحالية</div>
        </div>

        <div class="form-group switch-container">
          <label class="switch">
            {{ form.is_active }}
            <span class="slider round"></span>
          </label>
          {% for e in form.is_active.errors %}<div class="field-error" style="margin-top:6px">{{ e }}</div>{% endfor %}
          <div class="switch-label">
            <i class="fas fa-toggle-on icon" aria-hidden="true"></i> نشط
            <div class="form-hint">تفعيل أو إلغاء تفعيل حساب المعلم</div>
          </div>
        </div>

        <div class="form-group">
          <label for="{{ form.department.id_for_label }}"><i class="fas fa-building icon" aria-hidden="true"></i> القسم</label>
          <div class="select-wrapper">
            {{ form.department }}
            <div class="select-arrow"><i class="fas fa-chevron-down" aria-hidden="true"></i></div>
          </div>
          {% for e in form.department.errors %}<div class="field-error">{{ e }}</div>{% endfor %}
          <div class="form-hint">اختر القسم الذي يتبع له المعلم</div>
        </div>

        <div class="form-group">
          <label for="{{ form.membership_role.id_for_label }}"><i class="fas fa-user-shield icon" aria-hidden="true"></i> الدور داخل القسم</label>
          <div class="select-wrapper">
            {{ form.membership_role }}
            <div class="select-arrow"><i class="fas fa-chevron-down" aria-hidden="true"></i></div>
          </div>
          {% for e in form.membership_role.errors %}<div class="field-error">{{ e }}</div>{% endfor %}
          <div class="form-hint">“مسؤول القسم” يمنح صلاحيات الاطلاع على تقارير القسم. في قسم المعلّمين يظهر خيار “معلم” فقط.</div>
        </div>
      </div>

      <div class="form-actions">
        <button type="submit" class="btn btn-primary">
          <i class="fas fa-save" aria-hidden="true"></i> حفظ التعديلات
        </button>
        <a href="{% url 'reports:manage_teachers' %}" class="btn btn-outline">
          <i class="fas fa-arrow-right" aria-hidden="true"></i> رجوع للقائمة
        </a>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    // أضف class=ctrl لكل الحقول (بدون فلاتر/ملفات)
    document.querySelectorAll('.teacher-form input:not([type="checkbox"]), .teacher-form select, .teacher-form textarea')
      .forEach(el => el.classList.add('ctrl'));

    // منع الإرسال المزدوج
    const form = document.querySelector(".teacher-form");
    if(form){
      form.addEventListener("submit", function(){
        const btn = form.querySelector('button[type="submit"]');
        if(btn){ btn.disabled = true; btn.style.opacity = ".7"; btn.textContent = "جارٍ الحفظ..."; }
      });
    }

    // تحسين تجربة إدخال الهوية والجوال
    const national = document.getElementById('{{ form.national_id.id_for_label }}') || document.getElementById('id_national_id');
    const phone = document.getElementById('{{ form.phone.id_for_label }}') || document.getElementById('id_phone');
    if(national){ national.setAttribute('inputmode','numeric'); national.setAttribute('pattern','\\d{10}'); national.setAttribute('maxlength','10'); national.dir='ltr'; national.style.textAlign='left'; }
    if(phone){ phone.setAttribute('inputmode','tel'); phone.setAttribute('pattern','05\\d{8}'); phone.setAttribute('maxlength','10'); phone.dir='ltr'; phone.style.textAlign='left'; }

    // إظهار/إخفاء كلمة المرور
    const togglePassword = document.getElementById("togglePassword");
    const password = document.getElementById('{{ form.password.id_for_label }}') || document.getElementById('id_password') || document.querySelector('input[name="password"]');
    if (togglePassword && password) {
      togglePassword.addEventListener("click", function () {
        const type = password.getAttribute("type") === "password" ? "text" : "password";
        password.setAttribute("type", type);
        const ic = this.querySelector("i");
        if(ic){ ic.classList.toggle("fa-eye"); ic.classList.toggle("fa-eye-slash"); }
      });
    }

    // تعطيل "officer" عند قسم المعلّمين
    const dept = document.getElementById('{{ form.department.id_for_label }}') || document.getElementById('id_department');
    const role = document.getElementById('{{ form.membership_role.id_for_label }}') || document.getElementById('id_membership_role') || document.getElementById('membership_role');
    const TEACHERS = new Set(["teachers","معلمين","المعلمين"]);
    function adjustRoleChoices() {
      if (!dept || !role || !role.options) return;
      const val = (dept.value || "").trim().toLowerCase();
      const isTeachers = TEACHERS.has(val);
      for (const opt of role.options) {
        if ((opt.value || '').toLowerCase() === "officer") {
          opt.disabled = isTeachers;
          if (isTeachers && (role.value || '').toLowerCase() === "officer") {
            for (const o of role.options) if ((o.value || '').toLowerCase() === "teacher"){ role.value = o.value; break; }
          }
        }
      }
    }
    if(dept){ dept.addEventListener('change', adjustRoleChoices); adjustRoleChoices(); }

    // تمييز الحقول المطلوبة بعلامة *
    document.querySelectorAll("input[required], select[required], textarea[required]").forEach((field) => {
      const group = field.closest(".form-group"); if(!group) return;
      const label = group.querySelector("label"); if(label && !label.querySelector(".required")){
        label.insertAdjacentHTML('beforeend',' <span class="required" style="color:#ef4444">*</span>');
      }
    });
  });
</script>
{% endblock %}
