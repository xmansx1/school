{% extends "base.html" %}
{% load static %}
{% block title %}تفاصيل الإشعار{% endblock %}

{% block head %}
<style>
  .wrap{max-width:1100px;margin:0 auto;padding:18px}
  .page-head{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:14px}
  .title{margin:0;font-weight:900;color:#0b1b3a}
  .hint{color:#64748b;font-weight:700}

  .grid{display:grid;gap:18px}
  @media(min-width:1000px){.grid{grid-template-columns:1.1fr .9fr}}

  .card{background:#fff;border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow)}
  .card-hd{padding:14px 16px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between;gap:10px}
  .card-bd{padding:16px}

  .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border:1px solid var(--line);background:#f8fbff;color:#0b1b3a;border-radius:999px;font-weight:800;font-size:.86rem}
  .pill.important{background:#fff5f5;border-color:#ffe0e0;color:#b91c1c}
  .pill.blue{background:#eef2ff;border-color:#e5e7eb;color:#1e40af}
  .time{color:#64748b;font-weight:800}
  .body{white-space:pre-wrap;line-height:1.95;color:#334155;font-weight:700}

  .tools{display:flex;gap:10px;flex-wrap:wrap}
  .btn{padding:8px 12px;border-radius:10px;border:1px solid var(--line);background:#fff;font-weight:800;text-decoration:none;color:#1e293b}
  .btn.primary{background:var(--brand);border-color:var(--brand);color:#fff}
  .btn.danger{background:#fff0f0;border-color:#fecaca;color:#b91c1c}

  .table-wrap{overflow:auto}
  table{width:100%;border-collapse:separate;border-spacing:0;border:1px solid var(--line);border-radius:14px;overflow:hidden}
  thead th{background:#f8fbff;color:#0b1b3a;font-weight:900;text-align:right;padding:10px;border-bottom:1px solid var(--line);white-space:nowrap}
  tbody td{padding:10px;border-bottom:1px solid var(--line);color:#334155;font-weight:700;white-space:nowrap}
  tbody tr:nth-child(even){background:#fafcff}

  .chip{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;font-weight:900}
  .chip.read{background:#ecfdf5;border:1px solid #bbf7d0;color:#166534}      /* أخضر ناعم */
  .chip.unread{background:#f1f5f9;border:1px solid #e2e8f0;color:#334155}   /* رمادي */

  .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:10px}
  .toolbar input[type="search"]{border:1px solid var(--line);border-radius:10px;padding:8px 10px;font:inherit;width:100%}
  .toggle{display:inline-flex;border:1px solid var(--line);border-radius:10px;overflow:hidden}
  .toggle button{padding:7px 10px;border:0;background:#fff;font-weight:800;cursor:pointer}
  .toggle button.on{background:var(--brand-ghost);color:var(--brand)}
</style>
{% endblock %}

{% block content %}
<div class="wrap" dir="rtl">
  <header class="page-head">
    <h1 class="title">تفاصيل الإشعار</h1>
    <a class="btn" href="{% url 'reports:notifications_sent' %}">↩︎ رجوع إلى المرسلة</a>
  </header>

  <div class="grid">
    <!-- بطاقة الإشعار -->
    <section class="card">
      <div class="card-hd">
        <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
          <strong style="font-weight:900">{{ n.title|default:"رسالة" }}</strong>
          {% if n.is_important %}<span class="pill important">هام</span>{% endif %}
          {% if n.is_broadcast %}<span class="pill blue">للجميع</span>{% endif %}
        </div>
        <div class="time">{{ n.created_at|date:"Y-m-d H:i" }}</div>
      </div>
      <div class="card-bd">
        {% if body %}<div class="body">{{ body|linebreaksbr }}</div>{% else %}<div class="hint">لا يوجد محتوى نصي.</div>{% endif %}
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:12px">
          {% if n.expires_at %}<span class="pill">ينتهي: {{ n.expires_at|date:"Y-m-d H:i" }}</span>{% endif %}
          {% if n.created_by and n.created_by.name %}<span class="pill">مرسِل: {{ n.created_by.name }}</span>{% endif %}
        </div>
        <div class="tools" style="margin-top:12px">
          {% if n.action_url %}<a class="btn primary" href="{{ n.action_url }}" rel="noopener">فتح الرابط</a>{% endif %}
          {% url 'reports:notification_delete' n.id as del_url %}
          {% if del_url %}
            <form method="post" action="{{ del_url }}" onsubmit="return confirm('حذف الإشعار نهائيًا؟');">
              {% csrf_token %}
              <button class="btn danger" type="submit">حذف</button>
            </form>
          {% endif %}
        </div>
      </div>
    </section>

    <!-- بطاقة المستلمين -->
    <aside class="card">
      <div class="card-hd">
        <strong>المستلمون</strong>
        <span class="hint">الاسم — الدور — الحالة</span>
      </div>
      <div class="card-bd">
        {% if recipients %}
          <div class="toolbar">
            <input type="search" id="recSearch" placeholder="ابحث بالاسم أو الدور…">
            <div class="toggle" role="tablist" aria-label="تصفية">
              <button id="toggleAll"   class="on"  type="button">الكل</button>
              <button id="toggleUnread"        type="button">غير المقروء فقط</button>
            </div>
          </div>
          <div class="table-wrap">
            <table id="recTable">
              <thead>
                <tr>
                  <th style="width:45%">الاسم</th>
                  <th style="width:25%">الدور</th>
                  <th style="width:30%">الحالة</th>
                </tr>
              </thead>
              <tbody>
                {% for r in recipients %}
                  <tr data-read="{{ r.read|yesno:'1,0' }}">
                    <td>{{ r.name }}</td>
                    <td>{{ r.role }}</td>
                    <td>
                      {% if r.read %}
                        <span class="chip read" title="{% if r.read_at %}{{ r.read_at }}{% else %}مقروء{% endif %}">مقروء</span>
                      {% else %}
                        <span class="chip unread" title="غير مقروء">غير مقروء</span>
                      {% endif %}
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          {% if n.is_broadcast %}
            <div class="hint">هذا الإشعار مُرسل للجميع.</div>
          {% else %}
            <div class="hint">لا يوجد مستلمون مسجّلون.</div>
          {% endif %}
        {% endif %}
      </div>
    </aside>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  (function(){
    const q = document.getElementById('recSearch');
    const tbl = document.getElementById('recTable');
    const btnAll = document.getElementById('toggleAll');
    const btnUn  = document.getElementById('toggleUnread');
    if(!tbl) return;

    const rows = Array.from(tbl.querySelectorAll('tbody tr'));
    function applyFilter(){
      const term = (q && q.value || '').trim().toLowerCase();
      const unreadOnly = btnUn && btnUn.classList.contains('on');
      rows.forEach(tr=>{
        const txt = tr.textContent.toLowerCase();
        const isRead = tr.getAttribute('data-read') === '1';
        const match = !term || txt.includes(term);
        const pass  = (!unreadOnly || !isRead);
        tr.style.display = (match && pass) ? '' : 'none';
      });
    }

    if(q){ q.addEventListener('input', applyFilter); }
    if(btnAll && btnUn){
      btnAll.addEventListener('click', ()=>{ btnAll.classList.add('on'); btnUn.classList.remove('on'); applyFilter(); });
      btnUn .addEventListener('click', ()=>{ btnUn.classList.add('on');  btnAll.classList.remove('on'); applyFilter(); });
    }
  })();
</script>
{% endblock %}
