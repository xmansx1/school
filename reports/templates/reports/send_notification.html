{# reports/templates/reports/send_notification.html #}
{% extends "base.html" %}
{% load static %}

{% block title %}Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø±{% endblock %}

{% block head %}
<style>
  :root{
    --brand:#2563eb; --brand-2:#1e40af; --accent:#10b981;
    --ink:#0f172a; --muted:#64748b; --line:#e5e7eb; --bg:#f8fafc; --card:#fff;
    --shadow:0 10px 30px rgba(2,6,23,.08); --radius:16px; --t:all .22s ease
  }
  .wrap{max-width:1200px;margin:0 auto;padding:18px}
  .page-head{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:18px}
  .title{margin:0;font-weight:900;color:var(--brand-2)}
  .hint{color:var(--muted);font-weight:700}

  .grid{display:grid;gap:18px}
  @media(min-width:1040px){.grid{grid-template-columns:1.15fr .85fr}}

  .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow)}
  .card-hd{padding:14px 16px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between;gap:10px}
  .card-bd{padding:16px}

  .form-grid{display:grid;gap:14px}
  @media(min-width:640px){.form-grid{grid-template-columns:1fr 1fr}}
  .field{display:flex;flex-direction:column;gap:8px}
  .field.full{grid-column:1/-1}
  label{font-weight:900;color:#111827}
  input[type="text"],input[type="url"],input[type="datetime-local"],textarea,select{
    border:1px solid var(--line);border-radius:12px;padding:10px 12px;font:inherit;background:#fff
  }
  input[type="file"]{font:inherit}
  textarea{min-height:160px;resize:vertical}
  .help{color:var(--muted);font-size:.9rem}
  .errors{color:#b91c1c;font-weight:800}

  .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
  .btn{padding:10px 14px;border-radius:12px;border:1px solid var(--line);background:#fff;font-weight:900;cursor:pointer;text-decoration:none;color:#111827}
  .btn-primary{background:var(--brand);border-color:var(--brand);color:#fff}
  .btn-ghost{background:#eef2ff;border-color:#e5e7eb;color:#1e40af}
  .btn:disabled{opacity:.7;cursor:not-allowed}

  /* Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© */
  .preview{background:linear-gradient(180deg,#f9fbff,#ffffff)}
  .notif{border:1px dashed #dbeafe;border-radius:14px;padding:12px;background:#fff}
  .nt-h{display:flex;align-items:center;justify-content:space-between;gap:10px}
  .nt-title{margin:0;font-weight:900;color:#0b1b3a}
  .nt-ico{font-size:1.2rem}
  .nt-body{white-space:pre-wrap;margin-top:8px;color:#334155;font-weight:700;line-height:1.9}
  .nt-meta{margin-top:8px;color:#475569;font-weight:800;display:flex;gap:10px;flex-wrap:wrap}
  .pill{
    display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border:1px solid var(--line);
    background:#f8fbff;color:#0b1b3a;border-radius:999px;font-weight:800;font-size:.9rem
  }
  .pill.important{background:#fff5f5;border-color:#ffe0e0;color:#b91c1c}
  .badge{display:inline-grid;place-items:center;min-width:20px;height:20px;padding:0 6px;border-radius:999px;background:#ef4444;color:#fff;font-size:12px;font-weight:900}
</style>
{% endblock %}

{% block content %}
<div class="wrap">

  <header class="page-head">
    <div>
      <h1 class="title">Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø±</h1>
      <div class="hint">Ø§ÙƒØªØ¨ Ø¹Ù†ÙˆØ§Ù†Ù‹Ø§ Ø¬Ø°Ø§Ø¨Ù‹Ø§ ÙˆÙ…Ø­ØªÙˆÙ‰ ÙˆØ§Ø¶Ø­Ù‹Ø§. ÙŠÙ…ÙƒÙ†Ùƒ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø´ÙƒÙ„ Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„.</div>
    </div>
    <div class="hint">
      <a class="btn btn-ghost" href="{% url 'reports:notifications_sent' %}">Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø±Ø³Ù„Ø©</a>
    </div>
  </header>

  <div class="grid">

    {# â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø£ÙŠØ³Ø±: Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” #}
    <section class="card" aria-labelledby="form-title">
      <div class="card-hd">
        <strong id="form-title">Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±</strong>
        <span class="help">ÙŠØ¸Ù‡Ø± Ù‡Ø°Ø§ Ø§Ù„Ø®ÙŠØ§Ø± Ù„Ù„Ù…ØµØ±Ù‘Ø­ Ù„Ù‡Ù… ÙÙ‚Ø·</span>
      </div>
      <div class="card-bd">

        {% if form %}
          {% if form.media %}{{ form.media }}{% endif %}
          <form method="post" enctype="multipart/form-data" action="" id="notifyForm" novalidate>
            {% csrf_token %}

            {% if form.non_field_errors %}
              <div class="errors">{{ form.non_field_errors }}</div>
            {% endif %}

            <div class="form-grid">
              {# Ù†Ø¹Ø±Ø¶ Ø§Ù„Ø­Ù‚ÙˆÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¨Ø¯ÙˆÙ† Ø£ÙˆØ³Ù…Ø© ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…Ø© #}
              {% for field in form.visible_fields %}
                <div class="field" data-name="{{ field.html_name|lower }}">
                  <label for="{{ field.id_for_label }}">{{ field.label|default:"Ø§Ù„Ø­Ù‚Ù„" }}</label>
                  {{ field }}
                  {% if field.help_text %}<div class="help">{{ field.help_text|safe }}</div>{% endif %}
                  {% for e in field.errors %}<div class="errors">{{ e }}</div>{% endfor %}
                </div>
              {% endfor %}
            </div>

            <div class="actions">
              <button class="btn btn-primary" type="submit">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±</button>
              <a class="btn" href="{% url 'reports:home' %}">Ø§Ù„Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
            </div>
          </form>
        {% else %}
          {# ÙØ§Ù„Ø¨Ø§Ùƒ Ø¨Ø³ÙŠØ· Ø¥Ø°Ø§ Ù„Ù… ÙŠÙÙ…Ø±Ø± ÙÙˆØ±Ù… Ù…Ù† Ø§Ù„Ù€ view #}
          <form method="post" enctype="multipart/form-data" action="" id="notifyForm" novalidate>
            {% csrf_token %}
            <div class="form-grid">
              <div class="field full">
                <label for="id_title">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
                <input type="text" id="id_title" name="title" maxlength="120" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±">
                <div class="help">Ø­ØªÙ‰ 120 Ø­Ø±ÙÙ‹Ø§</div>
              </div>

              <div class="field full">
                <label for="id_message">Ø§Ù„Ù…Ø­ØªÙˆÙ‰</label>
                <textarea id="id_message" name="message" placeholder="Ù†Øµ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±"></textarea>
              </div>

              <div class="field">
                <label for="id_action_url">Ø±Ø§Ø¨Ø· Ø¥Ø¬Ø±Ø§Ø¡ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                <input type="url" id="id_action_url" name="action_url" placeholder="https://...">
              </div>

              <div class="field">
                <label class="row" style="display:flex;align-items:center;gap:8px">
                  <input type="checkbox" id="id_is_important" name="is_important" value="1">
                  <span>ÙˆØ¶Ø¹Ù‡ ÙƒÙ‡Ø§Ù…</span>
                </label>
              </div>

              <div class="field">
                <label for="id_expires_at">ÙŠÙ†ØªÙ‡ÙŠ ÙÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                <input type="datetime-local" id="id_expires_at" name="expires_at">
              </div>

              <div class="field full">
                <label for="id_recipients">Ø§Ù„Ù…Ø³ØªÙ„Ù…ÙˆÙ† (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                <input type="text" id="id_recipients" name="recipients" placeholder="Ù…Ø¹Ø±Ù‘ÙØ§Øª/Ø£Ø³Ù…Ø§Ø¡/Ø£Ø±Ù‚Ø§Ù… Ù…ÙØµÙˆÙ„Ø© Ø¨ÙÙˆØ§ØµÙ„">
                <div class="help">Ø§ØªØ±ÙƒÙ‡ ÙØ§Ø±ØºØ§Ù‹ Ù„Ø¥Ø±Ø³Ø§Ù„Ù‡ ÙˆÙÙ‚ Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø§Ø³ØªÙ‡Ø¯Ø§Ù ÙÙŠ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ÙØ¹Ù„ÙŠ.</div>
              </div>
            </div>

            <div class="actions">
              <button class="btn btn-primary" type="submit">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±</button>
              <a class="btn" href="{% url 'reports:home' %}">Ø§Ù„Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
            </div>
          </form>
        {% endif %}
      </div>
    </section>

    {# â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø£ÙŠÙ…Ù†: Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” #}
    <aside class="card preview" aria-labelledby="preview-title">
      <div class="card-hd"><strong id="preview-title">Ù…Ø¹Ø§ÙŠÙ†Ø© ÙÙˆØ±ÙŠØ©</strong><span class="help">ØªØ­Ø¯Ù‘ÙØ« ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§</span></div>
      <div class="card-bd">
        <div class="notif">
          <div class="nt-h">
            <h3 class="nt-title" id="pv_title">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±</h3>
            <div class="nt-ico" id="pv_important" title="Ù‡Ø§Ù…" style="display:none">âš ï¸</div>
          </div>
          <div class="nt-body" id="pv_body">Ø³ÙŠØ¸Ù‡Ø± Ù†Øµ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ù‡Ù†Ø§â€¦</div>
          <div class="nt-meta">
            <span class="pill">
              <i class="fa-solid fa-user-tie" aria-hidden="true"></i>
              <span>Ù…Ø±Ø³Ù„: {% firstof request.user.name request.user.phone "Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©" %}</span>
            </span>
            <span class="pill" id="pv_action" style="display:none">ğŸ”— ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø±Ø§Ø¨Ø· Ø¥Ø¬Ø±Ø§Ø¡</span>
            <span class="pill" id="pv_expires" style="display:none">â³ ÙŠÙ†ØªÙ‡ÙŠ Ù„Ø§Ø­Ù‚Ù‹Ø§</span>
          </div>
        </div>
      </div>
    </aside>

  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  (function(){
    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));

    // Ø¹Ù†Ø§ØµØ± Ø­Ù‚ÙˆÙ„ Ù…ØªÙˆÙ‚Ø¹Ø© (Ù…Ù† Ø§Ù„ÙÙˆØ±Ù… Ø£Ùˆ Ø§Ù„ÙØ§Ù„Ø¨Ø§Ùƒ)
    const titleInput = $("#id_title") || document.querySelector('[name*="title"],[name*="subject"],[name*="heading"]');
    const msgInput   = $("#id_message") || document.querySelector('textarea[name*="message"],textarea[name*="body"],textarea[name*="content"],textarea[name*="text"],textarea[name*="details"]');
    const urlInput   = $("#id_action_url") || document.querySelector('input[type="url"],input[name*="action_url"]');
    const impInput   = $("#id_is_important") || document.querySelector('input[name*="is_important"]');
    const expInput   = $("#id_expires_at") || document.querySelector('input[name*="expires_at"],input[name*="ends_at"]');

    const pvTitle = $("#pv_title");
    const pvBody  = $("#pv_body");
    const pvImportant = $("#pv_important");
    const pvAction = $("#pv_action");
    const pvExpires = $("#pv_expires");

    function updatePreview(){
      if(pvTitle && titleInput){ pvTitle.textContent = (titleInput.value || "").trim() || "Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±"; }
      if(pvBody  && msgInput ){ pvBody.textContent  = (msgInput.value  || "").trim() || "Ø³ÙŠØ¸Ù‡Ø± Ù†Øµ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ù‡Ù†Ø§â€¦"; }
      if(pvImportant && impInput){ pvImportant.style.display = impInput.checked ? "block" : "none"; }
      if(pvAction && urlInput){ const has = !!(urlInput.value || "").trim(); pvAction.style.display = has ? "inline-flex" : "none"; }
      if(pvExpires && expInput){ pvExpires.style.display = (expInput.value || "").trim() ? "inline-flex" : "none"; }
    }
    [titleInput, msgInput, urlInput, impInput, expInput].forEach(el=>{
      if(el){ el.addEventListener("input", updatePreview); el.addEventListener("change", updatePreview); }
    });
    updatePreview();

    // Ø§Ø¬Ø¹Ù„ Ø¨Ø¹Ø¶ Ø§Ù„Ø­Ù‚ÙˆÙ„ ØªÙ…ØªØ¯ Ø¨Ø¹Ø±Ø¶ Ø§Ù„Ø´Ø¨ÙƒØ© (Ø¨Ø¯ÙˆÙ† Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙˆØ³ÙˆÙ… ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…Ø©)
    $$('.form-grid .field').forEach(box=>{
      const input = box.querySelector('input, textarea, select');
      if(!input) return;
      const nm = (input.getAttribute('name') || '').toLowerCase();
      if(input.tagName === 'TEXTAREA' ||
         nm.includes('title') || nm.includes('subject') || nm.includes('heading') ||
         nm.includes('message') || nm.includes('body') || nm.includes('content') ||
         nm.includes('text') || nm.includes('details')){
        box.classList.add('full');
      }
    });

    // Ù…Ù†Ø¹ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ø²Ø¯ÙˆØ¬
    const form = document.getElementById('notifyForm');
    if(form){
      form.addEventListener('submit', function(){
        const btn = form.querySelector('button[type="submit"]');
        if(btn){ btn.disabled = true; btn.textContent = 'Ø¬Ø§Ø±Ù Ø§Ù„Ø¥Ø±Ø³Ø§Ù„â€¦'; }
      });
    }
  })();
</script>
{% endblock %}
