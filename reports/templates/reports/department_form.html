{# templates/reports/department_form.html #}
{% extends "base.html" %}
{% block title %}{% if form.instance.pk %}ØªØ¹Ø¯ÙŠÙ„ Ù‚Ø³Ù…{% else %}Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù…{% endif %}{% endblock %}

{% block head %}
<style>
  :root{
    --bg:#f8fafc; --card:#ffffff; --line:#e5e7eb; --text:#0f172a; --muted:#6b7280;
    --brand:#2563eb; --brand-2:#3b82f6; --danger:#b91c1c; --ok:#16a34a; --warn:#d97706;
  }
  @media (prefers-color-scheme: dark){
    :root{ --bg:#0b1220; --card:#0f172a; --line:#1f2937; --text:#e5e7eb; --muted:#94a3b8; --brand:#3b82f6; --brand-2:#60a5fa; }
  }
  body{background:var(--bg)}
  .wrap{max-width:980px;margin:24px auto;padding:0 16px}
  .crumbs{color:var(--muted);font-size:.9rem;margin-bottom:10px}
  .crumbs a{color:inherit;text-decoration:none}
  .card{background:var(--card);border:1px solid var(--line);border-radius:18px;box-shadow:0 10px 30px rgba(2,6,23,.08);padding:22px}
  .title{display:flex;align-items:center;gap:10px;font-weight:900;font-size:1.35rem;margin:0 0 6px}
  .sub{color:var(--muted);font-size:.95rem;margin-bottom:14px}
  .grid{display:grid;gap:16px}
  .row{display:grid;gap:14px}
  @media(min-width:780px){.row{grid-template-columns:1fr 1fr}}
  label{font-weight:700;margin-bottom:6px;display:block;color:var(--text)}
  .help{color:var(--muted);font-size:.86rem;margin-top:6px}
  .control{
    width:100%;padding:12px 14px;border:1px solid var(--line);border-radius:12px;background:var(--card);color:var(--text);
    transition:border .2s, box-shadow .2s; box-shadow:0 1px 0 rgba(2,6,23,.02) inset;
  }
  .control[readonly]{opacity:.85; background:color-mix(in srgb, var(--card) 92%, var(--bg) 8%)}
  .control:focus{outline:none;border-color:var(--brand);box-shadow:0 0 0 3px color-mix(in srgb, var(--brand) 25%, transparent)}
  textarea.control{min-height:110px;resize:vertical}
  .switch{display:flex;gap:8px;align-items:center;user-select:none}
  .errors{border:1px solid #fecaca;background:#fee2e2;color:#7f1d1d;border-radius:12px;padding:12px;margin-bottom:12px;font-size:.93rem}
  .note{border:1px solid color-mix(in srgb,var(--brand) 28%, var(--line));background:color-mix(in srgb,var(--brand) 12%, var(--card));color:var(--text);border-radius:12px;padding:12px;margin-bottom:12px;font-size:.93rem}
  .warn{border:1px solid color-mix(in srgb,var(--warn) 40%, var(--line));background:color-mix(in srgb,var(--warn) 10%, var(--card))}
  .ok{border:1px solid color-mix(in srgb,var(--ok) 40%, var(--line));background:color-mix(in srgb,var(--ok) 10%, var(--card))}
  .err{color:#991b1b;background:#fee2e2;border:1px solid #fecaca;border-radius:10px;padding:8px 10px;margin-top:6px;font-size:.9rem}
  .pill{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--line);border-radius:999px;padding:8px 12px;background:var(--card)}
  .preview{display:flex;flex-wrap:wrap;gap:10px;margin-top:6px}
  .role-pill{background:color-mix(in srgb, var(--brand) 12%, var(--card));border-color:color-mix(in srgb, var(--brand) 30%, var(--line))}
  .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:18px;align-items:center}
  .btn{
    padding:12px 16px;border-radius:12px;border:1px solid var(--line);background:var(--card);color:var(--text);
    font-weight:800;cursor:pointer;transition:transform .08s, background .2s; text-decoration:none; display:inline-flex; align-items:center; gap:8px;
  }
  .btn:hover{background:color-mix(in srgb, var(--card) 80%, var(--bg) 20%);transform:translateY(-1px)}
  .btn-primary{background:linear-gradient(135deg,var(--brand),var(--brand-2));border-color:transparent;color:#fff}
  .btn-primary:hover{filter:saturate(1.1)}
  .btn-danger{background:var(--danger);color:#fff;border-color:transparent}
  .kbd{font:600 .82rem ui-monospace,SFMono-Regular,Menlo,monospace;background:var(--bg);border:1px solid var(--line);border-radius:8px;padding:2px 6px}

  /* reporttypes widget */
  .rt-box{display:grid;gap:10px}
  .rt-actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .badge{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:color-mix(in srgb,var(--brand) 14%, var(--card));border:1px solid color-mix(in srgb,var(--brand) 28%, var(--line));font-size:.85rem}
  .muted{color:var(--muted)}
</style>
{% endblock head %}

{% block content %}
<div class="wrap" dir="rtl">
  <div class="crumbs">
    <a href="{% url 'reports:admin_dashboard' %}">Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯ÙŠØ±</a> Â·
    <a href="{% url 'reports:departments_list' %}">Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</a> Â·
    <span>{% if form.instance.pk %}ØªØ¹Ø¯ÙŠÙ„ Ù‚Ø³Ù…{% else %}Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù…{% endif %}</span>
  </div>

  <div class="card">
    <h2 class="title">
      {% if form.instance.pk %}âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ù‚Ø³Ù…{% else %}â• Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù…{% endif %}
    </h2>
    <div class="sub">
      Ø³ÙŠØ¸Ù‡Ø± Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù… ÙƒÙ€ <em>Ø¯ÙˆØ±</em> ÙÙŠ Ù†Ù…Ø§Ø°Ø¬ Ø§Ù„Ù…Ø¹Ù„Ù‘Ù…ÙŠÙ† Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… <strong>Ø§Ù„ÙƒÙˆØ¯ (slug)</strong> ÙƒÙ‚ÙŠÙ…Ø©ØŒ
      Ùˆ<strong>Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ±</strong> Ù„Ù„Ø¹Ø±Ø¶. ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø­ÙØ¸ Ø³Ø±ÙŠØ¹Ù‹Ø§ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù…
      <span class="kbd">Ctrl/âŒ˜ + S</span>.
    </div>

    {% if form.non_field_errors %}
      <div class="errors" role="alert" aria-live="polite">
        {% for e in form.non_field_errors %}â€¢ {{ e }}<br>{% endfor %}
      </div>
    {% endif %}

    {# Ø´Ø§Ø±Ø© Ø­Ø§Ù„Ø© Ø®Ø§ØµØ© Ù„Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…Ø­Ø¬ÙˆØ²Ø© #}
    {% with current_slug=form.slug.value|default:form.instance.slug %}
      {% if current_slug == "manager" %}
        <div class="note ok">
          <strong>Ù‚Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø¯Ø§Ø¦Ù…</strong> â€” Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù… Ù…Ø­Ø¬ÙˆØ² Ø¨Ù€ <code>slug=manager</code>ØŒ ÙˆÙŠØªÙ…ØªØ¹ Ø¨ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø¯ÙŠØ±.
          Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØºÙŠÙŠØ± ÙƒÙˆØ¯Ù‡ØŒ ÙˆÙŠÙ…ÙƒÙ†Ùƒ ÙÙ‚Ø· Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸ÙÙŠÙ† Ù„Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù… Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡.
        </div>
      {% elif current_slug == "teachers" %}
        <div class="note warn">
          <strong>Ù‚Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù‘Ù…ÙŠÙ†</strong> â€” Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù… Ù…Ø®ØµØµ Ù„Ø­Ø³Ø§Ø¨Ø§Øª "Ù…Ø¹Ù„Ù…". Ø¹Ù†Ø¯ Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù… ÙØ¥Ù† Ø§Ù„Ø¯ÙˆØ± ÙŠÙƒÙˆÙ† "Ù…Ø¹Ù„Ù…" ÙÙ‚Ø·.
        </div>
      {% endif %}
    {% endwith %}

    <form method="post" class="grid" novalidate id="deptForm">
      {% csrf_token %}

      <div class="row">
        <div>
          <label for="{{ form.name.id_for_label }}">Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù…</label>
          {{ form.name }}
          {% if form.name.help_text %}<div class="help">{{ form.name.help_text }}</div>{% endif %}
          {% for e in form.name.errors %}<div class="err">â€¢ {{ e }}</div>{% endfor %}
        </div>

        <div>
          <label for="{{ form.slug.id_for_label }}">Ø§Ù„ÙƒÙˆØ¯ (slug)</label>
          {{ form.slug }}
          {% for e in form.slug.errors %}<div class="err">â€¢ {{ e }}</div>{% endfor %}
          <div class="help">Ù‚ØµÙŠØ± ÙˆÙØ±ÙŠØ¯ (Ù…Ø«Ø§Ù„: <b>activity</b>). ÙŠÙØ³ØªØ®Ø¯Ù… Ø£ÙŠØ¶Ù‹Ø§ ÙƒÙ‚ÙŠÙ…Ø© â€œØ§Ù„Ø¯ÙˆØ±â€.</div>
          <label class="switch" style="margin-top:8px">
            <input type="checkbox" id="autoSlug" checked> ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ÙƒÙˆØ¯ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ù…Ù† Ø§Ù„Ø§Ø³Ù… (Ù…Ø¹ Ø®Ø±Ø§Ø¦Ø· Ø®Ø§ØµØ© Ù„Ù„Ù…Ù†ØµØ©)
          </label>
        </div>
      </div>

      {% if form.role_label %}
      <div>
        <label for="{{ form.role_label.id_for_label }}">Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ± Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶</label>
        {{ form.role_label }}
        {% for e in form.role_label.errors %}<div class="err">â€¢ {{ e }}</div>{% endfor %}
        <div class="help">
          Ù…Ø«Ø§Ù„: <b>Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ù†Ø´Ø§Ø·</b> â€” Ø³ÙŠØ¸Ù‡Ø± ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© â€œØ§Ù„Ø¯ÙˆØ±â€ Ø¶Ù…Ù† Ù†Ù…Ø§Ø°Ø¬ Ø§Ù„Ù…Ø¹Ù„Ù‘Ù…ÙŠÙ†.
        </div>
      </div>
      {% endif %}

      {% if form.description %}
      <div>
        <label for="{{ form.description.id_for_label }}">Ø§Ù„ÙˆØµÙ</label>
        {{ form.description }}
        {% for e in form.description.errors %}<div class="err">â€¢ {{ e }}</div>{% endfor %}
      </div>
      {% endif %}

      <div>
        <label class="switch">
          {{ form.is_active }} Ù†Ø´Ø·
        </label>
        {% for e in form.is_active.errors %}<div class="err">â€¢ {{ e }}</div>{% endfor %}
      </div>

      {% if form.reporttypes %}
      <div>
        <label for="{{ form.reporttypes.id_for_label }}">Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©</label>
        <div class="rt-box">
          <!-- Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© -->
          <div class="rt-actions">
            <input id="rtSearch" type="search" class="control" placeholder="Ø§Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹..." aria-label="Ø¨Ø­Ø« ÙÙŠ Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±">
            <button type="button" class="btn" id="rtSelectAll">ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¸Ø§Ù‡Ø±Ø©</button>
            <button type="button" class="btn" id="rtClearAll">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ÙƒÙ„</button>
            <span class="badge"><span id="rtCount">0</span> Ù…Ø®ØªØ§Ø±Ø©</span>
            <span class="muted">Ø§Ø®ØªÙŠØ§Ø±Ø§Øª Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù… ØªÙØ²Ø§Ù…ÙÙ† ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ù…Ø¹ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø¯ÙˆØ± Ø§Ù„Ù…ÙˆØ§Ø²ÙŠ.</span>
          </div>

          {{ form.reporttypes }}

          {% if form.reporttypes.help_text %}<div class="help">{{ form.reporttypes.help_text }}</div>{% endif %}
          {% for e in form.reporttypes.errors %}<div class="err">â€¢ {{ e }}</div>{% endfor %}
        </div>
      </div>
      {% endif %}

      <div>
        <div class="help">Ù…Ø¹Ø§ÙŠÙ†Ø© ÙƒÙŠÙ Ø³ÙŠØ¸Ù‡Ø± Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù… ÙƒØ®ÙŠØ§Ø± â€œØ¯ÙˆØ±â€:</div>
        <div class="preview" id="rolePreview">
          <span class="pill role-pill" title="Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¯ÙˆØ± (slug)">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M3 6h18M3 12h12M3 18h8" stroke="currentColor" stroke-width="1.7" stroke-linecap="round"/></svg>
            <span id="pvCode">â€”</span>
          </span>
          <span class="pill" title="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M12 6v12M6 12h12" stroke="currentColor" stroke-width="1.7" stroke-linecap="round"/></svg>
            <span id="pvLabel">â€”</span>
          </span>
        </div>
      </div>

      {% for h in form.hidden_fields %}{{ h }}{% endfor %}

      <div class="actions">
        <button class="btn btn-primary" type="submit">ğŸ’¾ Ø­ÙØ¸</button>
        <a class="btn" href="{% url 'reports:departments_list' %}">â†©ï¸ Ø±Ø¬ÙˆØ¹</a>

        {% if form.instance.pk %}
          <form method="post" action="{% url 'reports:department_delete' code=form.instance.slug %}" style="display:inline" onsubmit="return confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù… Ù†Ù‡Ø§Ø¦ÙŠÙ‹Ø§ØŸ');">
            {% csrf_token %}
            <button class="btn btn-danger" type="submit">ğŸ—‘ Ø­Ø°Ù</button>
          </form>
        {% endif %}
      </div>
    </form>
  </div>
</div>

<script>
  // Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù .control Ù„ÙƒÙ„ Ù…Ø¯Ø®Ù„Ø§Øª Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
  (function(){
    const form = document.getElementById('deptForm');
    if(!form) return;
    const sel = 'input[type=text], input[type=url], input[type=email], input[type=search], textarea, select';
    form.querySelectorAll(sel).forEach(el=>{
      if(!el.classList.contains('control')) el.classList.add('control');
    });
  })();

  // Ø®Ø±Ø§Ø¦Ø· Ø§Ù„Ù…Ù†ØµØ© Ù„Ù„Ø£Ø³Ù…Ø§Ø¡ â†’ slug (ØªØ·Ø§Ø¨Ù‚ Ù…Ø§ Ù‡Ùˆ ÙÙŠ backend)
  const ALIASES = {
    "Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©":"manager","Ø§Ù„Ø§Ø¯Ø§Ø±Ø©":"manager","Ù…Ø¯ÙŠØ±":"manager",
    "Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†":"teachers","Ù…Ø¹Ù„Ù…ÙŠÙ†":"teachers",
    "Ø§Ù„Ù†Ø´Ø§Ø·":"activity",
    "Ø§Ù„ØªØ·ÙˆØ¹":"volunteer",
    "Ø§Ù„Ø´Ø¤ÙˆÙ† Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠØ©":"affairs",
    "Ø§Ù„Ø´Ø¤ÙˆÙ† Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ©":"admin","Ø§Ù„Ø´Ø¤ÙˆÙ† Ø§Ù„Ø§Ø¯Ø§Ø±ÙŠØ©":"admin"
  };

  // ØªÙˆÙ„ÙŠØ¯ slug + Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© + Ø­Ø¸Ø± ØªØ­Ø±ÙŠØ± manager
  function normArabicDigits(s){return (s||'').replace(/[Ù -Ù©]/g, d => "Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©".indexOf(d));}
  function slugifyAscii(s){
    s = (s||"").trim();
    // Ø®Ø±ÙŠØ·Ø© Ù…Ø³Ø¨Ù‚Ø©
    if (ALIASES[s]) return ALIASES[s];
    s = normArabicDigits(s);
    // Ø¥Ø²Ø§Ù„Ø© ØªØ´ÙƒÙŠÙ„
    s = s.normalize("NFKD").replace(/[\u064B-\u065F]/g,"");
    // Ù…Ø³Ø§ÙØ§Øª Ù„Ø´Ø±Ø·Ø©
    s = s.replace(/[\s_]+/g,"-");
    // Ø£Ø­Ø±Ù Ù„Ø§ØªÙŠÙ†ÙŠØ©/Ø£Ø±Ù‚Ø§Ù… ÙˆØ´Ø±Ø·Ø© ÙÙ‚Ø·
    s = s.replace(/[^a-zA-Z0-9-]/g,"");
    return s.toLowerCase().replace(/-+/g,"-").replace(/^-+|-+$/g,"");
  }

  (function(){
    const name = document.getElementById("{{ form.name.id_for_label }}");
    const slug = document.getElementById("{{ form.slug.id_for_label }}");
    const roleLabel = document.getElementById("{% if form.role_label %}{{ form.role_label.id_for_label }}{% else %}__none{% endif %}");
    const auto = document.getElementById("autoSlug");
    const pvCode = document.getElementById("pvCode");
    const pvLabel = document.getElementById("pvLabel");
    const formEl = document.getElementById("deptForm");

    function updatePreview(){
      pvCode.textContent  = (slug && slug.value) ? slug.value : "â€”";
      const label = roleLabel && roleLabel.value ? roleLabel.value : (name ? name.value : "");
      pvLabel.textContent = label || "â€”";
    }

    function lockIfManager(){
      const isManager = (slug.value || "").toLowerCase() === "manager";
      if (isManager){
        // Ø§Ø¬Ø¹Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ù„Ù„Ù‚Ø±Ø§Ø¡Ø© ÙÙ‚Ø· Ù„ÙƒÙ† Ø£Ø±Ø³Ù„ Ø§Ù„Ù‚ÙŠÙ…
        name.readOnly = true;
        slug.readOnly = true;
        if (roleLabel) roleLabel.readOnly = true;
        if (auto){ auto.checked = false; auto.disabled = true; }
      } else {
        name.readOnly = false;
        slug.readOnly = false;
        if (roleLabel) roleLabel.readOnly = false;
        if (auto){ auto.disabled = false; }
      }
    }

    if (name && slug){
      // ØªØ²Ø§Ù…Ù† ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù…Ù† Ø§Ù„Ø§Ø³Ù…
      const sync = () => {
        if (!auto || auto.checked){
          const v = slugifyAscii(name.value);
          if (!slug.dataset.touched || slug.value === "" || slug.value === "manager" || slug.value === "teachers"){
            slug.value = v;
          }
          updatePreview(); lockIfManager();
        }
      };
      name.addEventListener("input", sync);
      name.addEventListener("blur", sync);
      if (auto){ auto.addEventListener("change", sync); }
      slug.addEventListener("input", () => { slug.dataset.touched = "1"; updatePreview(); lockIfManager(); });
      // Ø¨Ø¯Ø§ÙŠØ©
      updatePreview(); lockIfManager();
    }

    if (roleLabel){ roleLabel.addEventListener("input", updatePreview); }

    // Ø­ÙØ¸ Ø³Ø±ÙŠØ¹: Ctrl/Cmd + S
    document.addEventListener("keydown", function(e){
      if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === "s"){
        e.preventDefault(); formEl.requestSubmit();
      }
    });
  })();

  // Ø£Ø¯ÙˆØ§Øª reporttypes: Ø¨Ø­Ø« + ØªØ­Ø¯ÙŠØ¯/Ø¥Ù„ØºØ§Ø¡ + Ø¹Ø¯Ù‘Ø§Ø¯
  (function(){
    const rtSelect = document.getElementById("{% if form.reporttypes %}{{ form.reporttypes.id_for_label }}{% else %}__none{% endif %}");
    if(!rtSelect) return;
    const search = document.getElementById('rtSearch');
    const btnAll = document.getElementById('rtSelectAll');
    const btnClear = document.getElementById('rtClearAll');
    const counter = document.getElementById('rtCount');

    function updateCount(){
      let c = 0;
      Array.from(rtSelect.options).forEach(o => { if(o.selected) c++; });
      counter.textContent = c;
    }

    function filterOptions(){
      const q = (search.value || '').trim().toLowerCase();
      Array.from(rtSelect.options).forEach(o=>{
        const txt = (o.text || '').toLowerCase();
        const show = !q || txt.includes(q);
        o.hidden = !show;
      });
    }

    btnAll?.addEventListener('click', ()=>{
      const q = (search.value || '').trim().toLowerCase();
      Array.from(rtSelect.options).forEach(o=>{
        const txt = (o.text || '').toLowerCase();
        if(!q || txt.includes(q)) o.selected = true;
      });
      updateCount();
    });

    btnClear?.addEventListener('click', ()=>{
      Array.from(rtSelect.options).forEach(o=>o.selected=false);
      updateCount();
    });

    search?.addEventListener('input', filterOptions);
    search?.addEventListener('keydown', (e)=>{ if(e.key === 'Enter'){ e.preventDefault(); } });

    rtSelect.addEventListener('change', updateCount);
    filterOptions();
    updateCount();
  })();
</script>
{% endblock content %}
