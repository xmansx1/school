{% extends "base.html" %}
{% block title %}{% if form.instance.pk %}تعديل قسم{% else %}إضافة قسم{% endif %}{% endblock %}

{% block head %}
<style>
  :root{
    --bg:#f8fafc; --card:#ffffff; --line:#e5e7eb; --text:#0f172a; --muted:#6b7280;
    --brand:#2563eb; --brand-2:#3b82f6; --danger:#b91c1c;
  }
  @media (prefers-color-scheme: dark){
    :root{ --bg:#0b1220; --card:#0f172a; --line:#1f2937; --text:#e5e7eb; --muted:#94a3b8; --brand:#3b82f6; --brand-2:#60a5fa; }
  }
  body{background:var(--bg)}
  .wrap{max-width:860px;margin:24px auto;padding:0 16px}
  .crumbs{color:var(--muted);font-size:.9rem;margin-bottom:10px}
  .crumbs a{color:inherit;text-decoration:none}
  .card{background:var(--card);border:1px solid var(--line);border-radius:18px;box-shadow:0 10px 30px rgba(2,6,23,.08);padding:22px}
  .title{display:flex;align-items:center;gap:10px;font-weight:900;font-size:1.35rem;margin:0 0 6px}
  .sub{color:var(--muted);font-size:.95rem;margin-bottom:14px}
  .grid{display:grid;gap:16px}
  .row{display:grid;gap:14px}
  @media(min-width:780px){.row{grid-template-columns:1fr 1fr}}
  label{font-weight:700;margin-bottom:6px;display:block;color:var(--text)}
  .help{color:var(--muted);font-size:.86rem;margin-top:6px}
  .control{
    width:100%;padding:12px 14px;border:1px solid var(--line);border-radius:12px;background:var(--card);color:var(--text);
    transition:border .2s, box-shadow .2s; box-shadow:0 1px 0 rgba(2,6,23,.02) inset;
  }
  .control:focus{outline:none;border-color:var(--brand);box-shadow:0 0 0 3px color-mix(in srgb, var(--brand) 25%, transparent)}
  textarea.control{min-height:110px;resize:vertical}
  .switch{display:flex;gap:8px;align-items:center;user-select:none}
  .errors{border:1px solid #fecaca;background:#fee2e2;color:#7f1d1d;border-radius:12px;padding:12px;margin-bottom:12px;font-size:.93rem}
  .err{color:#991b1b;background:#fee2e2;border:1px solid #fecaca;border-radius:10px;padding:8px 10px;margin-top:6px;font-size:.9rem}
  .pill{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--line);border-radius:999px;padding:8px 12px;background:var(--card)}
  .preview{display:flex;flex-wrap:wrap;gap:10px;margin-top:6px}
  .role-pill{background:color-mix(in srgb, var(--brand) 12%, var(--card));border-color:color-mix(in srgb, var(--brand) 30%, var(--line))}
  .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:18px}
  .btn{
    padding:12px 16px;border-radius:12px;border:1px solid var(--line);background:var(--card);color:var(--text);
    font-weight:800;cursor:pointer;transition:transform .08s, background .2s
  }
  .btn:hover{background:color-mix(in srgb, var(--card) 80%, var(--bg) 20%);transform:translateY(-1px)}
  .btn-primary{background:linear-gradient(135deg,var(--brand),var(--brand-2));border-color:transparent;color:#fff}
  .btn-primary:hover{filter:saturate(1.1)}
  .btn-danger{background:var(--danger);color:#fff;border-color:transparent}
  .kbd{font:600 .82rem ui-monospace,SFMono-Regular,Menlo,monospace;background:var(--bg);border:1px solid var(--line);border-radius:8px;padding:2px 6px}
</style>
{% endblock head %}

{% block content %}
<div class="wrap" dir="rtl">
  <div class="crumbs">
    <a href="{% url 'reports:admin_dashboard' %}">لوحة المدير</a> ·
    <a href="{% url 'reports:departments_list' %}">الأقسام</a> ·
    <span>{% if form.instance.pk %}تعديل قسم{% else %}إضافة قسم{% endif %}</span>
  </div>

  <div class="card">
    <h2 class="title">
      {% if form.instance.pk %}✏️ تعديل قسم{% else %}➕ إضافة قسم{% endif %}
    </h2>
    <div class="sub">
      سيظهر هذا القسم كـ <em>دور</em> في نماذج المعلّمين باستخدام <strong>الكود (slug)</strong> كقيمة،
      و<strong>اسم الدور</strong> للعرض. يمكنك الحفظ سريعًا باستخدام
      <span class="kbd">Ctrl/⌘ + S</span>.
    </div>

    {% if form.non_field_errors %}
      <div class="errors" role="alert" aria-live="polite">
        {% for e in form.non_field_errors %}• {{ e }}<br>{% endfor %}
      </div>
    {% endif %}

    <form method="post" class="grid" novalidate id="deptForm">
      {% csrf_token %}

      <div class="row">
        <div>
          <label for="{{ form.name.id_for_label }}">اسم القسم</label>
          {{ form.name }}
          {% if form.name.help_text %}<div class="help">{{ form.name.help_text }}</div>{% endif %}
          {% for e in form.name.errors %}<div class="err">• {{ e }}</div>{% endfor %}
        </div>

        <div>
          <label for="{{ form.slug.id_for_label }}">الكود (slug)</label>
          {{ form.slug }}
          {% for e in form.slug.errors %}<div class="err">• {{ e }}</div>{% endfor %}
          <div class="help">قصير وفريد (مثال: <b>clinic</b>). يُستخدم أيضًا كقيمة “الدور”.</div>
          <label class="switch" style="margin-top:8px">
            <input type="checkbox" id="autoSlug" checked> توليد الكود تلقائيًا من الاسم
          </label>
        </div>
      </div>

      {% if form.role_label %}
      <div>
        <label for="{{ form.role_label.id_for_label }}">اسم الدور المعروض</label>
        {{ form.role_label }}
        {% for e in form.role_label.errors %}<div class="err">• {{ e }}</div>{% endfor %}
        <div class="help">مثال: المرشد الصحي — سيظهر في قائمة “الدور” ضمن نماذج المعلّمين.</div>
      </div>
      {% endif %}

      {% if form.description %}
      <div>
        <label for="{{ form.description.id_for_label }}">الوصف</label>
        {{ form.description }}
        {% for e in form.description.errors %}<div class="err">• {{ e }}</div>{% endfor %}
      </div>
      {% endif %}

      <div>
        <label class="switch">
          {{ form.is_active }} نشط
        </label>
        {% for e in form.is_active.errors %}<div class="err">• {{ e }}</div>{% endfor %}
      </div>

      <div>
        <div class="help">معاينة كيف سيظهر هذا القسم كخيار “دور”:</div>
        <div class="preview" id="rolePreview">
          <span class="pill role-pill" title="قيمة الدور (slug)">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M3 6h18M3 12h12M3 18h8" stroke="currentColor" stroke-width="1.7" stroke-linecap="round"/></svg>
            <span id="pvCode">—</span>
          </span>
          <span class="pill" title="الاسم المعروض">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M12 6v12M6 12h12" stroke="currentColor" stroke-width="1.7" stroke-linecap="round"/></svg>
            <span id="pvLabel">—</span>
          </span>
        </div>
      </div>

      {% for h in form.hidden_fields %}{{ h }}{% endfor %}

      <div class="actions">
        <button class="btn btn-primary" type="submit">💾 حفظ</button>
        <a class="btn" href="{% url 'reports:departments_list' %}">↩️ رجوع</a>
        {% if form.instance.pk %}
          <a class="btn btn-danger" href="#" onclick="confirmDelete(event)">&nbsp;🗑 حذف&nbsp;</a>
        {% endif %}
      </div>
    </form>
  </div>
</div>

<script>
  // 1) أضف صنف .control لكل مدخلات النموذج (بدون الحاجة لفلاتر قالب)
  (function(){
    const form = document.getElementById('deptForm');
    const sel = 'input[type=text], input[type=url], input[type=email], textarea, select';
    form.querySelectorAll(sel).forEach(el=>{
      if(!el.classList.contains('control')) el.classList.add('control');
    });
  })();

  // 2) توليد slug + المعاينة
  function normArabicDigits(s){return s.replace(/[٠-٩]/g, d => "٠١٢٣٤٥٦٧٨٩".indexOf(d));}
  function slugify(s){
    s = (s||"").trim();
    s = normArabicDigits(s);
    s = s.normalize("NFKD").replace(/[\u064B-\u065F]/g,"");
    s = s.replace(/[\s_]+/g,"-");
    s = s.replace(/[^a-zA-Z0-9-]/g,"");
    return s.toLowerCase().replace(/-+/g,"-").replace(/^-+|-+$/g,"");
  }

  (function(){
    const name = document.getElementById("{{ form.name.id_for_label }}");
    const slug = document.getElementById("{{ form.slug.id_for_label }}");
    const roleLabel = document.getElementById("{% if form.role_label %}{{ form.role_label.id_for_label }}{% else %}__none{% endif %}");
    const auto = document.getElementById("autoSlug");
    const pvCode = document.getElementById("pvCode");
    const pvLabel = document.getElementById("pvLabel");
    const formEl = document.getElementById("deptForm");

    function updatePreview(){
      pvCode.textContent  = (slug && slug.value) ? slug.value : "—";
      const label = roleLabel && roleLabel.value ? roleLabel.value : (name ? name.value : "");
      pvLabel.textContent = label || "—";
    }

    if (name && slug && auto) {
      const sync = () => { if (auto.checked && (!slug.dataset.touched || slug.value === "")) { slug.value = slugify(name.value); updatePreview(); } };
      name.addEventListener("input", sync);
      auto.addEventListener("change", sync);
      slug.addEventListener("input", () => { slug.dataset.touched = "1"; updatePreview(); });
      name.addEventListener("blur", sync);
    }
    if (roleLabel){ roleLabel.addEventListener("input", updatePreview); }
    updatePreview();

    // حفظ سريع: Ctrl/Cmd + S
    document.addEventListener("keydown", function(e){
      if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === "s"){
        e.preventDefault(); formEl.requestSubmit();
      }
    });

    // زر الحذف (اربطه لاحقًا بمسار POST لديك)
    window.confirmDelete = function(ev){
      ev.preventDefault();
      if(!confirm("هل تريد حذف هذا القسم نهائيًا؟")) return;
      alert("اربط زر الحذف بمسار POST لديك (department_delete) للحذف الآمن.");
    }
  })();
</script>
{% endblock content %}
