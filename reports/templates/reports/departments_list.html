{% extends "base.html" %}
{% block title %}إدارة الأقسام{% endblock %}

{% block head %}
<style>
  .wrap{max-width:1100px;margin:0 auto}
  .card{background:#fff;border:1px solid #e5e7eb;border-radius:14px;box-shadow:0 6px 20px rgba(2,6,23,.06);padding:16px}
  .title{margin:0 0 10px;font-weight:900;color:#0f172a}
  .toolbar{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:12px}
  .btn{padding:10px 14px;border-radius:10px;border:1px solid #e5e7eb;background:#fff;font-weight:800;text-decoration:none}
  .btn-primary{background:linear-gradient(135deg,#2563eb,#3b82f6);border-color:transparent;color:#fff}
  .btn-danger{background:#fee2e2;color:#991b1b;border-color:#fecaca}
  .table-wrap{overflow:auto;border:1px solid #e5e7eb;border-radius:12px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:12px 10px;border-bottom:1px solid #e5e7eb;white-space:nowrap}
  thead th{background:#f8fafc;text-align:right;font-weight:900}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid #e5e7eb;background:#f8fafc;font-weight:800}
  .muted{color:#6b7280}
  .actions{display:flex;gap:6px;flex-wrap:wrap}
</style>
{% endblock %}

{% block content %}
<div class="wrap">
  <div class="card">
    <h2 class="title">🏷️ إدارة الأقسام</h2>

    <div class="toolbar">
      {% url 'reports:departments_add' as departments_add_url %}
      <a class="btn btn-primary" href="{{ departments_add_url|default:'#' }}">➕ قسم جديد</a>
    </div>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>المعرّف/الكود</th>
            <th>الاسم</th>
            <th>الحالة</th>
            <th>عدد الأعضاء</th>
            <th>التذاكر (مفتوحة / قيد / منجزة)</th>
            <th>إجراءات</th>
          </tr>
        </thead>
        <tbody>
          {% for d in departments %}
          <tr>
            <td>{{ forloop.counter }}</td>

            <td>
              <code>
                {% if d.code %}{{ d.code }}
                {% elif d.slug %}{{ d.slug }}
                {% else %}—{% endif %}
              </code>
            </td>

            <td>{{ d.name|default:"—" }}</td>

            <td>
              <span class="pill">{% if d.is_active %}نشط{% else %}موقّف{% endif %}</span>
            </td>

            <td>
              {# إن كان عندك members_count جاهز استخدمه، وإلا fallback إلى d.members.count #}
              {% if d.members_count is not None %}{{ d.members_count }}
              {% elif d.members %}{{ d.members.count }}
              {% else %}0{% endif %}
            </td>

            <td class="muted">
              {{ d.stats.open|default:"0" }} /
              {{ d.stats.in_progress|default:"0" }} /
              {{ d.stats.done|default:"0" }}
            </td>

            <td class="actions">
              {% url 'reports:department_members' d.pk as dept_members_url %}
              {% url 'reports:department_edit' d.pk as dept_edit_url %}
              {% url 'reports:department_delete' d.pk as dept_delete_url %}

              <a class="btn" href="{{ dept_members_url }}">👥 الأعضاء</a>
              <a class="btn" href="{{ dept_edit_url }}">✏️ تعديل</a>

              <form action="{{ dept_delete_url }}" method="post" style="display:inline"
                    onsubmit="return confirm('حذف هذا القسم؟');">
                {% csrf_token %}
                <button class="btn btn-danger" type="submit">🗑 حذف</button>
              </form>
            </td>
          </tr>
          {% empty %}
            <tr><td colspan="7" class="muted" style="text-align:center">لا توجد أقسام.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %}
